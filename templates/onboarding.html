<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ SERVER_NAME }}</title>
      <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
    {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% if services %}
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1000; background: rgba(0, 0, 0, 0.9); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); min-width: 200px;">
      <div style="margin-bottom: 8px; color: #aaa; font-size: 0.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">{{ t["quick_access"]["title"] }}</div>
      <div style="display: flex; gap: 0.8em; align-items: center; flex-wrap: wrap;">
        {% for service in services %}
          <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" style="display: flex; align-items: center; margin-bottom: 4px;">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 28px; height: 28px; border-radius: 6px; filter: brightness(0.9); transition: filter 0.2s ease;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(0.9)'">
            </a>
            <div style="color: #ccc; font-size: 0.7em; font-weight: 500; max-width: 60px; line-height: 1.2;">
              {% if service.name == "Plex" %}
                {{ t["quick_access"]["plex"] }}
              {% elif service.name == "Audiobookshelf" %}
                {{ t["quick_access"]["audiobookshelf"] }}
              {% elif service.name == "Tautulli" %}
                {{ t["quick_access"]["tautulli"] }}
              {% elif service.name == "Overseerr" %}
                {{ t["quick_access"]["overseerr"] }}
              {% else %}
                {{ service.name }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div style="position: absolute; top: 1rem; right: 1rem;">
    <form method="get" onchange="this.submit()" style="margin: 0;">
      <select name="lang">
        <option value="en" {% if lang == "en" %}selected{% endif %}>English</option>
        <option value="it" {% if lang == "it" %}selected{% endif %}>Italiano</option>
        <!-- add more language here -->
      </select>
    </form>
  </div>
  

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
      <h1 style="margin: 0;">{{ t["onboarding"]["title"] }}</h1>
      {% if services %}
        <div style="display: flex; gap: 0.5em; align-items: center;">
          {% for service in services %}
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" style="display: flex; align-items: center;">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 24px; height: 24px; border-radius: 4px;">
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

  <p class="max-850">
    {{ t["onboarding"]["intro_pre_link"] }}
    <a href="https://support.plex.tv/articles/200288286-what-is-plex/" target="_blank">{{ t["onboarding"]["intro_link_text"] }}</a>
    {{ t["onboarding"]["intro_post_link"] }}
  </p>


    {% set library_list = library_posters.keys()|list %}

    <!-- Single Carousel with Library Selector -->
    <div class="carousel-row">
      <div class="poster-carousel-container">
        <div class="poster-carousel animate" id="main-carousel"></div>
      </div>
      
      <div class="library-selector">
        <button class="library-tab {% if default_library == 'random-all' %}active{% endif %}" data-library="random-all">{{ t["onboarding"]["lib_random"] }}</button>
        {% for lib_name in library_list %}
          <button class="library-tab {% if default_library == lib_name %}active{% endif %}" data-library="{{ lib_name }}">{{ lib_name }}</button>
        {% endfor %}
      </div>
    </div>

    <p class="muted" style="margin-top: 1em; text-align: center; color: #aaa;">
      {{ t["onboarding"]["lib_pre_link"] }} <a href="/medialists" class="accent">{{ t["onboarding"]["lib_link_text"] }}</a> {{ t["onboarding"]["lib_post_link"] }}
    </p>

    <img src="{{ url_for('static', filename='homepage.webp') }}" alt="Homepage Example" class="toggle-grow" />

    <p class="muted">
      {{ t["onboarding"]["zoom"] }}
    </p>
  </div>
  <div class="container">
    <details {% if submitted %}open{% endif %}>
      <summary class="collapsible-heading">{{ t["section_1"]["title"] }}</summary>
      <div style="margin-left: 1em;">
        <p>{{ t["section_1"]["text_1"] }}</p>
	<p class="muted">
          {{ t["section_1"]["text_2"] }}
        </p>
        <form method="POST" action="/onboarding" id="onboarding-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label for="email">Email:</label><br>
          <input type="email" name="email" placeholder="{{ t["section_1"]["email_placeholder"] }}" required
                 class="max-300"
                 {% if submitted %}disabled{% endif %} />
          <div class="text-left max-800" style="margin: 1em 0;">
            <div class="library-table-container">
              <table class="library-table">
                <tbody>
                  {% for lib in libraries %}
                    <tr>
                      <td class="lib-checkbox">
                        <input type="checkbox" name="libraries" value="{{ lib.key }}" {% if submitted %}disabled{% endif %} />
                      </td>
                      <td class="lib-title">
                        {{ lib.title }}
                      </td>
                      <td class="lib-desc">
                        {% if library_notes[lib.key|string] and library_notes[lib.key|string]['description'] %}
                          <span class="muted">{{ library_notes[lib.key|string]['description'] }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if has_music_library %}
            <p>
              {{ t["section_1"]["audio_cat"] }}
            </p>
            {% endif %}
          </div>
          
          <!-- Explicit content checkbox temporarily hidden
          <div style="margin: 1em 0;">
            <label class="onboard-checkbox-label">
              <input type="checkbox" name="explicit_content" value="yes" {% if submitted %}disabled{% endif %} />
              <span>I would like access to explicit content (R-rated movies, mature shows, etc.)</span>
            </label>
            <div style="margin-left: 1.5em; color: #888; font-size: 0.9em;">
              This includes movies and shows with mature themes, violence, or adult content.
            </div>
          </div>
          -->
          
          <button type="submit" {% if submitted %}disabled{% endif %}>{{ t["section_1"]["submit_button"] }}</button>
        </form>
        
        <div style="margin: 1.5em 0; padding: 1em; background: #2a2a2a; border-radius: 0.5em; border-left: 4px solid #f6b900;">
          <p style="margin: 0; color: #f6b900; font-weight: bold;">{{ t["section_1"]["disclaimer"] }}</p>
          <p style="margin: 0.5em 0 0 0; color: #aaa; font-size: 0.95em;">
            {{ t["section_1"]["disclaimer_text"] }}
          </p>
        </div>
        
        <div id="onboarding-success" style="display:none;">
          <p class="accent" style="font-weight: bold; margin-top: 1em;">
            {{ t["section_1"]["request_submitted"] }}
          </p>
        </div>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{{ t["section_2"]["title"] }}</summary>
      <div style="margin-left: 1em;">
        <p>
          {{ t["section_2"]["text_1"] }} 
        </p>
        <p>
          <a href="https://www.plex.tv/media-server-downloads/?cat=plex+desktop&plat=windows#plex-app" target="_blank">{{ t["section_2"]["comp_device_link"] }}</a> {{ t["section_2"]["post_link"] }}
        </p>
        <p>
         {{ t["section_2"]["pre_web_link"] }} <a href="https://app.plex.tv/" target="_blank">{{ t["section_2"]["web_link"] }}</a> {{ t["section_2"]["post_web_link"] }} 
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{{ t["section_3"]["title"] }}</summary>
      <div style="margin-left: 1em;">    
        <p>
          {{ t["section_3"]["text_1"] }}
        </p>

        <p>
          {{ t["section_3"]["text_2"] }}
        </p>

        <p>
          {{ t["section_3"]["text_3"] }}
        </p>

        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='newuser1.webp') }}" alt="New User Screenshot" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            {{ t["section_3"]["text_4"] }}
          </figcaption>
        </figure>
        
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='onlinemedia.webp') }}" alt="Online Media Setting" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            {{ t["section_3"]["text_5"] }}
          </figcaption>
        </figure>
        
       
        <p>
          {{ t["section_3"]["text_6"] }}	
        </p>

        <p>
          {{ t["section_3"]["pre_guide_link"] }} <a href="https://mediaclients.wiki/Plex" target="_blank">{{ t["section_3"]["guide_link"] }}</a> {{ t["section_3"]["post_guide_link"] }}
    	</p>

        <p>
          {{ t["section_3"]["text_7"] }}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>{{ t["section_3"]["text_8"] }}</li>
          <li>{{ t["section_3"]["text_9"] }}</li>
          <li>{{ t["section_3"]["text_10"] }}</li>
          <li>{{ t["section_3"]["text_11"] }}</li>
          <li>{{ t["section_3"]["text_12"] }}</li>
        </ul>

        <p>
          {{ t["section_3"]["text_13"] }}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>{{ t["section_3"]["text_14"] }}</li>
          <li>{{ t["section_3"]["text_15"] }}</li>
          <li>{{ t["section_3"]["text_16"] }}</li>
        </ul>
        <p>
        {{ t["section_3"]["text_17"] }}
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{{ t["section_4"]["title"] }}</summary>
      <div style="margin-left: 1em;">
    
        <h3>{{ t["section_4"]["desktop_title"] }}</h3>
        <p>
          {{ t["section_4"]["desktop_text_1"] }}
        </p>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='sidemore.webp') }}" alt="Sidebar" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            {{ t["section_4"]["desktop_text_2"] }}
          </figcaption>
        </figure>
    
             <figure style="width: 100%; margin: 0 0 1em 0;">
              <img src="{{ url_for('static', filename='unpin.webp') }}" alt="Unpinning" class="toggle-grow" />
              <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
                {{ t["section_4"]["desktop_text_3"] }}
              </figcaption>
            </figure>
            
    
        <h3>{{ t["section_4"]["mobile_title"] }}</h3>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='mobilehome.webp') }}" alt="Mobile Home Screen" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            {{ t["section_4"]["mobile_text_1"] }}
          </figcaption>
        </figure>
        
    
        <p>
          {{ t["section_4"]["mobile_text_2"] }}
        </p>

        <img src="{{ url_for('static', filename='screens.webp') }}"
        alt="Screens"
        class="toggle-grow" />
    
      </div>
    </details>
  </div>
  {% if pulsarr_enabled or overseerr_enabled %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">{{ t["section_5"]["title"] }}</summary>
      <div style="margin-left: 1em;">
        {% if pulsarr_enabled %}
        <h3>{{ t["section_5"]["wathclist_title"] }}</h3>
        <p>
          {{ t["section_5"]["watchlist_text_1"] }}
        </p>
        <p>
          {{ t["section_5"]["watchlist_text_2"] }}
        </p>
        <p class="accent">
          {{ t["section_5"]["watchlist_text_3"] }}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>{{ t["section_5"]["watchlist_text_4"] }}</li>
          <li>{{ t["section_5"]["watchlist_text_5"] }}</li>
          <li>{{ t["section_5"]["watchlist_text_6"] }}</li>
          <li>{{ t["section_5"]["watchlist_text_7"] }}</li>
        </ul>
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='watchlist.webp') }}" alt="Watchlist" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            {{ t["section_5"]["watchlist_text_8"] }}
          </figcaption>
        </figure>
        <p>
          {{ t["section_5"]["watchlist_text_9"] }}
        </p>
        <p class="accent">
          {{ t["section_5"]["watchlist_text_10"] }}
        </p>
        <h3>{{ t["section_5"]["notifications_title"] }}</h3>
        <p>
          {{ t["section_5"]["notifications_text_1"] }}{% if tautulli_enabled %} {{ t["section_5"]["notifications_text_2"] }}{% endif %}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>{{ t["section_5"]["notifications_text_3"] }}</li>
          <li>{{ t["section_5"]["notifications_text_4"] }}</li>
          <li>{{ t["section_5"]["notifications_text_5"] }}</li>
          <li>{{ t["section_5"]["notifications_text_6"] }}</li>
          <li>{{ t["section_5"]["notifications_text_7"] }}</li>
        </ul>
        <img src="{{ url_for('static', filename='notifs.webp') }}"
             alt="Notification Settings"
             class="toggle-grow" />
        {% endif %}
        {% if overseerr_enabled %}
        <h3>{{ t["section_5"]["overseerr_title"] }}</h3>
        <p>
          {{ t["section_5"]["overseerr_text_1"] }}
        </p>
        <p>
          <a href="{{ overseerr_url }}" target="_blank" class="accent">{{ t["section_5"]["overseerr_link"] }}</a>
        </p>
        <p class="muted">
          {{ t["section_5"]["overseerr_text_2"] }}
        </p>
        {% endif %}
      </div>
    </details>
  </div>
  {% endif %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}{{ t["section_issue"]["issue_overseerr_enabled_num"] }}{% else %}{{ t["section_issue"]["issue_overseerr_disabled_num"] }}{% endif %}. {{ t["section_issue"]["title"] }}</summary>
      <div style="margin-left: 1em;">
    
        <p>
          {{ t["section_issue"]["issue_text_1"] }}
        </p>
    
        <img src="{{ url_for('static', filename='issue.webp') }}"
             alt="Report Issue"
             class="toggle-grow" />
    
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}{{ t["section_end"]["end_overseerr_enabled_num"] }}{% else %}{{ t["section_end"]["end_overseerr_disabled_num"] }}{% endif %}. {{ t["section_end"]["title"] }}</summary>
      <div style="margin-left: 1em;">
        {% include "onboarding_section7.html" %}
      </div>
    </details>
  </div>

  <script>
    function handleSubmit(event) {
      // Allow form to submit normally and delay disabling
      setTimeout(() => {
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = true);
      }, 50); // enough time for submit to start

      return true; // let form proceed
    }
  </script>

  <script>
    // AJAX onboarding form submission for Plex
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('onboarding-form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const data = new URLSearchParams();
          for (const pair of formData) {
            data.append(pair[0], pair[1]);
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          Array.from(form.elements).forEach(el => el.disabled = true);
          try {
            const response = await fetch('/onboarding', {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: data
            });
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                document.getElementById('onboarding-success').style.display = '';
                form.style.display = 'none';
              } else {
                alert(result.error || 'Submission failed.');
                Array.from(form.elements).forEach(el => el.disabled = false);
                if (submitBtn) submitBtn.disabled = false;
              }
            } else {
              alert('Submission failed.');
              Array.from(form.elements).forEach(el => el.disabled = false);
              if (submitBtn) submitBtn.disabled = false;
            }
          } catch (err) {
            alert('Submission failed.');
            Array.from(form.elements).forEach(el => el.disabled = false);
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Row-based tab switching functionality
      const rowTabs = document.querySelectorAll('.row-tab');
      
      // Library data from template
      const libraryPosters = JSON.parse('{{ library_posters|tojson|safe }}');
      const posterImdbIds = JSON.parse('{{ poster_imdb_ids|tojson|safe if poster_imdb_ids else "{}" }}');
      
      // Track current library
      let currentLibrary = null;
      
      // Load initial carousel with default library
      const defaultLibrary = '{{ default_library }}';
      const defaultTab = document.querySelector(`.library-tab[data-library="${defaultLibrary}"]`);
      
      console.log('Available library data:', libraryPosters);
      console.log('Default library:', defaultLibrary);
      console.log('Default tab:', defaultTab);
      
      if (defaultTab) {
        console.log(`Loading carousel with ${defaultLibrary}`);
        currentLibrary = defaultLibrary;
        loadCarousel('main-carousel', defaultLibrary);
      }
      
      function loadCarousel(carouselId, library) {
        const carousel = document.getElementById(carouselId);
        if (!carousel) {
          console.log(`Carousel ${carouselId} not found`);
          return;
        }
        
        console.log(`Loading carousel ${carouselId} with library ${library}`);
        
        // Stop any existing animation
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Clear existing content
        carousel.innerHTML = '';
        carousel.style.transform = 'translateX(0px)';
        
        // Show loading state
        carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">Loading posters...</div>';
        
        // Function to fetch random posters from server
        async function fetchRandomPosters(count = 10) {
          try {
            console.log(`Fetching ${count} random posters for library: "${library}"`);
            
            let endpoint = '/ajax/get-random-posters';
            let requestData = {
              count: count
            };
            
            if (library === 'random-all') {
              endpoint = '/ajax/get-random-posters-all';
              requestData.include_music = false;  // Exclude music by default for "Random All"
              console.log('Using random-all endpoint (excluding music)');
            } else {
              requestData.library = library;
            }
            
            console.log('Sending request data:', requestData);
            
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: JSON.stringify(requestData)
            });
            
            console.log(`Response status: ${response.status}`);
            console.log(`Response headers:`, Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
              const data = await response.json();
              console.log(`Received ${data.posters.length} posters from server`);
              return data;
            } else {
              const errorText = await response.text();
              console.error('Failed to fetch random posters:', response.status, errorText);
              
              // Try to parse as JSON for better error info
              try {
                const errorData = JSON.parse(errorText);
                console.error('Error details:', errorData);
              } catch (e) {
                console.error('Raw error response:', errorText);
              }
              
              return { posters: [], imdb_ids: [] };
            }
          } catch (error) {
            console.error('Error fetching random posters:', error);
            return { posters: [], imdb_ids: [] };
          }
        }
        
        // Function to add posters to carousel
        function addPostersToCarousel(posters, imdbIds, lastfmUrls) {
          // Clear loading state
          carousel.innerHTML = '';
          
          if (posters.length === 0) {
            carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">No posters available for this library</div>';
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const lastfmUrl = lastfmUrls ? lastfmUrls[index] : null;
            
            let imgElement;
            if (lastfmUrl) {
              // If it's a music artist, link to Last.fm
              imgElement = `<a href="${lastfmUrl}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else if (imdbId) {
              // If it has IMDB ID, link to IMDB
              imgElement = `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else {
              // No link
              imgElement = `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            }
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          console.log(`Added ${posters.length} new posters for ${library}`);
        }
        
        // Function to append posters to the end of carousel (out of view)
        function appendPostersToCarousel(posters, imdbIds, lastfmUrls) {
          if (posters.length === 0) {
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const lastfmUrl = lastfmUrls ? lastfmUrls[index] : null;
            
            let imgElement;
            if (lastfmUrl) {
              // If it's a music artist, link to Last.fm
              imgElement = `<a href="${lastfmUrl}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else if (imdbId) {
              // If it has IMDB ID, link to IMDB
              imgElement = `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else {
              // No link
              imgElement = `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            }
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          // Update carousel width after adding new posters
          updateWidth();
          console.log(`Appended ${posters.length} new posters to carousel for ${library}`);
        }
        
        // Function to update carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
        }
        
        // Function to ensure minimum posters in carousel
        function ensureMinimumPosters() {
          const currentPosters = carousel.children.length;
          if (currentPosters < 5) {
            console.log(`Only ${currentPosters} posters left, adding more...`);
            // Try to load more posters
            fetchRandomPosters(5).then(data => {
              if (data.posters.length > 0) {
                appendPostersToCarousel(data.posters, data.imdb_ids);
              } else {
                // If AJAX fails, try fallback data
                if (library === 'random-all') {
                  // For random-all, combine all available posters
                  const allPosters = [];
                  const allImdbIds = [];
                  Object.keys(libraryPosters).forEach(libName => {
                    if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                      allPosters.push(...libraryPosters[libName]);
                      const imdbIds = posterImdbIds[libName] || [];
                      allImdbIds.push(...imdbIds);
                    }
                  });
                  if (allPosters.length > 0) {
                    // Get random selection from all posters
                    const indices = [];
                    for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                      indices.push(Math.floor(Math.random() * allPosters.length));
                    }
                    const nextBatch = indices.map(i => allPosters[i]);
                    const nextImdbIds = indices.map(i => allImdbIds[i] || null);
                    appendPostersToCarousel(nextBatch, nextImdbIds);
                  }
                } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
                  const posters = libraryPosters[library];
                  const imdbIds = posterImdbIds[library] || [];
                  const nextBatch = posters.slice(0, 5);
                  const nextImdbIds = imdbIds.slice(0, 5);
                  if (nextBatch.length > 0) {
                    appendPostersToCarousel(nextBatch, nextImdbIds);
                  }
                }
              }
            }).catch(error => {
              console.error('Error ensuring minimum posters:', error);
            });
          }
        }
        
        // Load initial posters
        fetchRandomPosters(15).then(data => {
          if (data.posters.length > 0) {
            addPostersToCarousel(data.posters, data.imdb_ids, data.lastfm_urls);
            
            // Start animation immediately
            setupInfiniteCarousel(carousel, async () => {
              // Load more random posters when needed
              const newData = await fetchRandomPosters(5);
              if (newData.posters.length > 0) {
                appendPostersToCarousel(newData.posters, newData.imdb_ids, newData.lastfm_urls);
              }
            });
          } else {
            // Fallback to original library_posters data if AJAX fails
            console.log('AJAX failed, using fallback data for', library);
            if (library === 'random-all') {
              // For random-all, combine all available posters
              const allPosters = [];
              const allImdbIds = [];
              Object.keys(libraryPosters).forEach(libName => {
                if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                  allPosters.push(...libraryPosters[libName]);
                  const imdbIds = posterImdbIds[libName] || [];
                  allImdbIds.push(...imdbIds);
                }
              });
              if (allPosters.length > 0) {
                // Get random selection from all posters
                const indices = [];
                for (let i = 0; i < Math.min(15, allPosters.length); i++) {
                  indices.push(Math.floor(Math.random() * allPosters.length));
                }
                const initialPosters = indices.map(i => allPosters[i]);
                const initialImdbIds = indices.map(i => allImdbIds[i] || null);
                
                addPostersToCarousel(initialPosters, initialImdbIds, []);
                
                // Start animation with fallback loading
                setupInfiniteCarousel(carousel, () => {
                  // Load more random posters
                  const nextIndices = [];
                  for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                    nextIndices.push(Math.floor(Math.random() * allPosters.length));
                  }
                  const nextBatch = nextIndices.map(i => allPosters[i]);
                  const nextImdbIds = nextIndices.map(i => allImdbIds[i] || null);
                  if (nextBatch.length > 0) {
                    appendPostersToCarousel(nextBatch, nextImdbIds, []);
                  }
                });
              } else {
                addPostersToCarousel([], [], []);
              }
            } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
              const posters = libraryPosters[library];
              const imdbIds = posterImdbIds[library] || [];
              
              // Use first 15 posters from the original data
              const initialPosters = posters.slice(0, 15);
              const initialImdbIds = imdbIds.slice(0, 15);
              
              addPostersToCarousel(initialPosters, initialImdbIds, []);
              
              // Start animation with fallback loading
              setupInfiniteCarousel(carousel, () => {
                // Load more from original data
                const currentCount = carousel.children.length;
                const nextBatch = posters.slice(currentCount, currentCount + 5);
                const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
                if (nextBatch.length > 0) {
                  appendPostersToCarousel(nextBatch, nextImdbIds, []);
                }
              });
            } else {
              // No posters available at all
              addPostersToCarousel([], [], []);
            }
          }
        }).catch(error => {
          console.error('Error in initial poster loading:', error);
          // Fallback to original library_posters data
          if (library === 'random-all') {
            // For random-all, combine all available posters
            const allPosters = [];
            const allImdbIds = [];
            Object.keys(libraryPosters).forEach(libName => {
              if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                allPosters.push(...libraryPosters[libName]);
                const imdbIds = posterImdbIds[libName] || [];
                allImdbIds.push(...imdbIds);
              }
            });
            if (allPosters.length > 0) {
              // Get random selection from all posters
              const indices = [];
              for (let i = 0; i < Math.min(15, allPosters.length); i++) {
                indices.push(Math.floor(Math.random() * allPosters.length));
              }
              const initialPosters = indices.map(i => allPosters[i]);
              const initialImdbIds = indices.map(i => allImdbIds[i] || null);
              
              addPostersToCarousel(initialPosters, initialImdbIds);
              
              setupInfiniteCarousel(carousel, () => {
                // Load more random posters
                const nextIndices = [];
                for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                  nextIndices.push(Math.floor(Math.random() * allPosters.length));
                }
                const nextBatch = nextIndices.map(i => allPosters[i]);
                const nextImdbIds = nextIndices.map(i => allImdbIds[i] || null);
                if (nextBatch.length > 0) {
                  appendPostersToCarousel(nextBatch, nextImdbIds, []);
                }
              });
            } else {
              addPostersToCarousel([], [], []);
            }
          } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
            const posters = libraryPosters[library];
            const imdbIds = posterImdbIds[library] || [];
            
            const initialPosters = posters.slice(0, 15);
            const initialImdbIds = imdbIds.slice(0, 15);
            
            addPostersToCarousel(initialPosters, initialImdbIds, []);
            
            setupInfiniteCarousel(carousel, () => {
              const currentCount = carousel.children.length;
              const nextBatch = posters.slice(currentCount, currentCount + 5);
              const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
              if (nextBatch.length > 0) {
                appendPostersToCarousel(nextBatch, nextImdbIds, []);
              }
            });
          } else {
            addPostersToCarousel([], [], []);
          }
        });
      }
      
      // Library tab switching functionality
      const libraryTabs = document.querySelectorAll('.library-tab');
      
      libraryTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const targetLibrary = this.getAttribute('data-library');
          
          // Only reload if library actually changed
          if (currentLibrary !== targetLibrary) {
            console.log(`Switching from ${currentLibrary} to ${targetLibrary}`);
            
            // Update active tab
            libraryTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update current library tracking
            currentLibrary = targetLibrary;
            
            // Load new carousel data
            loadCarousel('main-carousel', targetLibrary);
          }
        });
      });

      // Only enable enlarge on screens wider than 1081px (adjust as needed)
      if (window.innerWidth >= 1081) {
        document.querySelectorAll(".toggle-grow").forEach(function (img) {
          img.addEventListener("click", function () {
            const isGrown = img.classList.toggle("grown");

            if (!isGrown) {
              img.style.left = "0px";
              img.style.top = "0px";
              img.style.position = "relative";
              img.style.zIndex = "";
            } else {
              img.style.position = "relative";
              img.style.zIndex = 10;
            }
          });
        });
      }

      // --- Improved Infinite Carousel Logic ---
      function setupInfiniteCarousel(carousel, onLoadMore = null) {
        const container = carousel.parentElement;
        let scrollSpeed = 0.5; // px per frame - increased for better visibility
        let isPaused = false;
        let offset = 0;
        let lastLoadCheck = 0;
        let isLoading = false; // Prevent multiple simultaneous loads

        // Clear any existing animation and event listeners
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Remove existing event listeners to prevent duplicates
        if (carousel._mouseEnterHandler) {
          container.removeEventListener('mouseenter', carousel._mouseEnterHandler);
        }
        if (carousel._mouseLeaveHandler) {
          container.removeEventListener('mouseleave', carousel._mouseLeaveHandler);
        }

        // Reset transform
        carousel.style.transform = 'translateX(0px)';

        // Set carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            console.log('No children in carousel for width calculation');
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              console.log(`Image ${index} has zero width, using naturalWidth`);
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
          console.log(`Carousel width set to: ${totalWidth}px`);
        }
        
        // Update width immediately and after a short delay
        updateWidth();
        setTimeout(updateWidth, 100);

        // Animation loop using transform
        function animate() {
          try {
            // Don't animate if there are no images or if we have a loading/error message
            if (carousel.children.length === 0 || carousel.querySelector('div')) {
              carousel.rafId = requestAnimationFrame(animate);
              return;
            }
            
            if (!isPaused) {
              offset -= scrollSpeed;
              carousel.style.transform = `translateX(${offset}px)`;
              
              // Remove images that have scrolled completely off screen
              const firstImg = carousel.children[0];
              if (firstImg && (firstImg.tagName === 'IMG' || firstImg.tagName === 'A')) {
                const firstImgWidth = firstImg.offsetWidth + parseInt(getComputedStyle(carousel).gap || 0);
                if (Math.abs(offset) >= firstImgWidth) {
                  firstImg.remove();
                  offset += firstImgWidth;
                  carousel.style.transform = `translateX(${offset}px)`;
                  
                  // Update width after removing image
                  updateWidth();
                }
              }
              
              // Check if we need to load more posters (every 3 seconds)
              const now = Date.now();
              if (onLoadMore && now - lastLoadCheck > 3000 && !isLoading) {
                lastLoadCheck = now;
                const remainingImages = carousel.children.length;
                if (remainingImages <= 15) { // Load earlier to prevent gaps
                  console.log(`Only ${remainingImages} images left, loading more...`);
                  isLoading = true;
                  try {
                    onLoadMore().then(() => {
                      isLoading = false;
                    }).catch(error => {
                      console.error('Error loading more posters:', error);
                      isLoading = false;
                      // Use safety mechanism to ensure minimum posters
                      ensureMinimumPosters();
                    });
                  } catch (error) {
                    console.error('Error in onLoadMore:', error);
                    isLoading = false;
                    ensureMinimumPosters();
                  }
                }
              }
            }
            carousel.rafId = requestAnimationFrame(animate);
          } catch (error) {
            console.error('Animation error:', error);
            // Stop animation on error
            if (carousel.rafId) {
              cancelAnimationFrame(carousel.rafId);
              carousel.rafId = null;
            }
          }
        }
        
        // Start animation immediately
        console.log(`Starting animation for carousel ${carousel.id}`);
        animate();

        // Pause on hover - store handlers to prevent duplicates
        carousel._mouseEnterHandler = () => { 
          isPaused = true; 
          console.log('Carousel paused on hover');
        };
        carousel._mouseLeaveHandler = () => { 
          isPaused = false; 
          console.log('Carousel resumed on mouse leave');
        };
        container.addEventListener('mouseenter', carousel._mouseEnterHandler);
        container.addEventListener('mouseleave', carousel._mouseLeaveHandler);
        
        // Periodic safety check to ensure carousel doesn't become empty
        setInterval(() => {
          if (carousel.children.length < 5) {
            console.log('Carousel running low on posters, adding more...');
            ensureMinimumPosters();
          }
        }, 5000); // Check every 5 seconds
      }
    });
  </script>

</body>
</html>
