<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} ‚Äî Admin</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}">
  <link rel="stylesheet" href="/static/modern-style.css">
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}

  <div class="onboarding-content">
    {% if custom_services_url %}
      <div class="onboarding-section">
        <div class="info-box">
          <span>üîó</span>
          <span><a href="{{ custom_services_url }}" target="_blank" class="accent" style="font-size: 1.2em;">Open Custom Services Page</a></span>
        </div>
        <!-- Optionally, embed the page below -->
        <iframe src="{{ custom_services_url }}" style="width:100%;height:600px;border:1px solid var(--border);margin-top:1em;border-radius: 0.5rem;"></iframe>
      </div>
    {% elif show_services %}
      <div class="onboarding-section">
        <h2 class="form-section-title">
          <span class="form-section-icon">üîó</span>
          Services
        </h2>
        <div class="services-grid">
          {% for service in services %}
            <a href="{{ service.url }}" class="service-card" target="_blank">
              <div class="service-icon-container">
                <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="service-icon">
              </div>
              <span class="service-name">{{ service.name }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="onboarding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üì∫</span>
        Plex Requests
      </h2>
      {% if submissions %}
        <div class="scrollable-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Libraries</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in submissions %}
                <tr data-plex-index="{{ loop.index0 }}">
                  <td>{{ submission.email }}</td>
                  <td>{{ submission.libraries_titles | join(', ') }}</td>
                  <td>
                    <button type="button" onclick="deletePlexRequest({{ loop.index0 }})" class="btn btn-secondary">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">No Plex requests found.</p>
      {% endif %}

      <!-- Plex User Invitation Section -->
      {% if submissions %}
      <div class="form-section">
        <h3 class="form-section-title">
          <span class="form-section-icon">üë•</span>
          Invite Plex Users
        </h3>
        <div class="info-box">
          <span>‚ÑπÔ∏è</span>
          <span>Select submissions to invite users to your Plex server. Users will be invited with access to the selected libraries.</span>
        </div>
        <form id="plex-user-invite-form">
          <div class="form-group">
            <label class="form-label">Select submissions to invite:</label>
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" id="select_all_plex_users">
                <span>Select All</span>
              </label>
            </div>
            {% for submission in submissions %}
              <div class="user-selection-item">
                <input type="checkbox" name="invite_users" value="{{ loop.index0 }}" id="invite_user_{{ loop.index0 }}" class="plex-user-checkbox">
                <label for="invite_user_{{ loop.index0 }}">
                  <strong>{{ submission.email }}</strong>
                  <div class="user-details">
                    Libraries: {{ submission.libraries_titles | join(', ') }} | 
                    Submitted: {{ submission.submitted_at[:10] }}
                  </div>
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="submit-section">
            <button type="button" onclick="invitePlexUsers()" class="submit-btn">
              Invite Selected Users to Plex
            </button>
          </div>
        </form>
        {% if plex_invite_results %}
        <div class="results-section">
          <h4 class="form-section-title">Invitation Results:</h4>
          {% for result in plex_invite_results %}
            <div class="result-item {% if result.success %}success{% else %}error{% endif %}">
              <div class="result-title">{{ result.email }}</div>
              <div class="result-message">
                {% if result.success %}
                  ‚úÖ {{ result.message or 'Successfully invited user' }}
                {% else %}
                  ‚ùå Failed to invite user: {{ result.error }}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    {% if ABS_ENABLED == 'yes' %}
    <div class="onboarding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üìö</span>
        Audiobookshelf Requests
      </h2>
      <div class="warning-box">
        <span>‚ö†Ô∏è</span>
        <span>Note: Passwords are censored for security. They are still available for user creation.</span>
      </div>
      {% if audiobookshelf_submissions %}
        <div class="scrollable-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Username</th>
                <th>Password</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in audiobookshelf_submissions %}
                <tr data-abs-index="{{ loop.index0 }}">
                  <td>{{ submission.email }}</td>
                  <td>{{ submission.username }}</td>
                  <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                  <td>
                    <button type="button" onclick="deleteAbsRequest({{ loop.index0 }})" class="btn btn-secondary">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- ABS User Creation Section -->
        <div class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üë•</span>
            Create Audiobookshelf Users
          </h3>
          <div class="info-box">
            <span>‚ÑπÔ∏è</span>
            <span>Select submissions to create users in Audiobookshelf. Users will be created with the specified username and password.</span>
          </div>
          
          <form id="abs-user-creation-form">
            <div class="form-group">
              <label class="form-label">Select submissions to create users:</label>
              <div class="checkbox-group">
                <label class="checkbox-option">
                  <input type="checkbox" id="select_all_users">
                  <span>Select All</span>
                </label>
              </div>
              {% for submission in audiobookshelf_submissions %}
                <div class="user-selection-item">
                  <input type="checkbox" name="create_users" value="{{ loop.index0 }}" id="create_user_{{ loop.index0 }}" class="user-checkbox">
                  <label for="create_user_{{ loop.index0 }}">
                    <strong>{{ submission.username }}</strong> ({{ submission.email }})
                    <div class="user-details">
                      Password: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ | Submitted: {{ submission.submitted_at[:10] }}
                    </div>
                  </label>
                </div>
              {% endfor %}
            </div>
            
            <div class="form-group">
              <label class="form-label">User Type:</label>
              <select name="user_type" id="abs_user_type" class="form-input" style="width: 200px;">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="guest">Guest</option>
              </select>
              <div class="file-help">
                <strong>User:</strong> Standard user access | <strong>Admin:</strong> Full administrative access | <strong>Guest:</strong> Limited access
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Permissions:</label>
              <div class="permissions-grid">
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="download" checked>
                  <span>Download items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="update">
                  <span>Update library items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="delete">
                  <span>Delete library items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="upload">
                  <span>Upload items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessAllLibraries" checked>
                  <span>Access all libraries</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessAllTags" checked>
                  <span>Access all tags</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessExplicitContent" checked>
                  <span>Access explicit content</span>
                </label>
              </div>
            </div>
            
            <div class="submit-section">
              <button type="button" onclick="createAbsUsers()" class="submit-btn">
                Create Selected Users in Audiobookshelf
              </button>
            </div>
          </form>
          
          {% if abs_user_creation_results %}
          <div class="results-section">
            <h4 class="form-section-title">Creation Results:</h4>
            {% for result in abs_user_creation_results %}
              <div class="result-item {% if result.success %}success{% else %}error{% endif %}">
                <div class="result-title">{{ result.username }} ({{ result.email }})</div>
                <div class="result-message">
                  {% if result.success %}
                    ‚úÖ Successfully created user
                  {% else %}
                    ‚ùå Failed to create user: {{ result.error }}
                  {% endif %}
                </div>
                {% if result.success and result.user_id %}
                  <div class="result-details">User ID: {{ result.user_id }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      {% else %}
        <p class="muted">No Audiobookshelf requests found.</p>
      {% endif %}
    </div>
    {% endif %}

    <div class="onboarding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üíæ</span>
        Storage
      </h2>
      <div class="storage-info">
        {% for drive in storage_info %}
          <div class="storage-item">
            <div class="storage-header">
              <strong>{{ drive.mount }}</strong>
              <span class="storage-stats">{{ drive.used }} GB used / {{ drive.total }} GB total ({{ drive.percent }}%)</span>
            </div>
            <div class="storage-bar">
              <div class="storage-bar-fill" style="width: {{ drive.percent }}%;"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="onboarding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">‚öôÔ∏è</span>
        Settings
      </h2>
      <form method="post" id="admin-settings-form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="warning-box">
          <span>üîë</span>
          <span><strong>SITE_PASSWORD</strong> and <strong>ADMIN_PASSWORD</strong> must be different.</span>
        </div>
        <div class="muted" style="margin-bottom: 1.2em; font-size: 0.98em; margin-left: 2.1em;">
          Leaving either field blank will keep the current password.
        </div>
        
        <div class="form-group">
          <label class="form-label">SITE_PASSWORD (for guests):</label>
          <div class="input-with-icon">
            <span class="input-icon">üîë</span>
            <input type="text" name="site_password" id="admin_site_password_box" value="{{ SITE_PASSWORD or '' }}" class="form-input">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ADMIN_PASSWORD (for admin):</label>
          <div class="input-with-icon">
            <span class="input-icon">üîë</span>
            <input type="text" name="admin_password" id="admin_admin_password_box" value="{{ ADMIN_PASSWORD or '' }}" class="form-input">
          </div>
        </div>
        
        <div id="admin-passwords-error" class="error-box" style="display: none;"></div>
        
        <div class="form-group">
          <label class="form-label">Server Name:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename=logo_filename) }}" alt="Server Name" class="input-icon-img">
            <input type="text" name="server_name" id="server_name" value="{{ SERVER_NAME or '' }}" class="form-input">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Accent Color:</label>
          <div class="color-picker-group">
            <input type="color" name="accent_color" id="accent_color" value="{{ ACCENT_COLOR or '#d33fbc' }}" class="color-picker">
            <input type="text" name="accent_color_text" id="accent_color_text" value="{{ ACCENT_COLOR or '#d33fbc' }}" placeholder="#d33fbc" class="form-input color-input">
          </div>
          <div class="color-help">Choose your theme color</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Custom Branding:</label>
          <div class="file-help">
            Upload your own logo and wordmark to customize the appearance. These can be changed later.
          </div>
          
          <div class="form-group">
            <label class="form-label">Select New Logo:</label>
            <input type="file" name="logo_file" id="logo_file" accept=".png,.webp,.jpg,.jpeg" class="file-input">
            <div class="file-help">
              .png or .webp, ~350x350, 1:1<br>
              This will replace the logo and automatically create a favicon.
            </div>
            <div class="info-box">
              <span>üí°</span>
              <div>
                <strong>Need a logo?</strong><br>
                ‚Ä¢ <a href="https://vectorink.io/app/canvas" target="_blank" class="accent">Simple Vector Editor</a> - Create a custom logo<br>
                ‚Ä¢ <a href="http://logobook.com/letter/a/" target="_blank" class="accent">Letter Logos</a> - Find a logo for any letter
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Select New Wordmark:</label>
            <input type="file" name="wordmark_file" id="wordmark_file" accept=".png,.webp,.jpg,.jpeg" class="file-input">
            <div class="file-help">
              .png or .webp, minimum dimensions ~1000x250, 4:1 or wider<br>
              This will replace the wordmark image.
            </div>
            <div class="info-box">
              <span>üí°</span>
              <div>
                <strong>Need a wordmark?</strong><br>
                ‚Ä¢ <a href="https://fontmeme.com/netflix-font/" target="_blank" class="accent">Wordmark Generator</a> - Create text-based wordmarks<br>
                <span style="color: var(--text-secondary); font-size: 0.8em;">Try different fonts, make the output text as big as slider allows, and use the same hex as the accent.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Plex Token:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex Token" class="input-icon-img">
            <div class="password-input-group">
              <input type="password" name="plex_token" id="plex_token" value="{{ PLEX_TOKEN or '' }}" class="form-input">
              <button type="button" onclick="togglePasswordVisibility('plex_token')" class="password-toggle-btn">üëÅ</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Plex URL:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex URL" class="input-icon-img">
            <input type="text" name="plex_url" id="plex_url" value="{{ PLEX_URL or '' }}" class="form-input">
          </div>
        </div>
        
        <div class="form-group">
          <button type="button" onclick="fetchLibrariesAdmin()" class="btn btn-secondary">Fetch Plex Libraries</button>
        </div>
        
        <!-- Current Library Selection Display -->
        {% if LIBRARY_IDS %}
        <div class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üìö</span>
            Currently Selected Libraries
          </h3>
          <div class="current-library-selection">
            <div class="library-header">
              <strong>Selected Libraries:</strong>
              <button type="button" onclick="refreshLibraryTitles()" class="btn btn-secondary">Refresh Titles</button>
            </div>
            {% set selected_ids = LIBRARY_IDS.split(',') %}
            {% for lib_id in selected_ids %}
              {% if lib_id.strip() %}
                <div class="library-item">
                  <strong>
                    {% if library_notes[lib_id.strip()] and library_notes[lib_id.strip()]['title'] %}{{ library_notes[lib_id.strip()]['title'] }}{% else %}Unknown{% endif %} ({{ lib_id.strip() }})
                  </strong>
                  {% if library_notes[lib_id.strip()] and library_notes[lib_id.strip()]['description'] %}
                    <span class="library-description">‚Äî {{ library_notes[lib_id.strip()]['description'] }}</span>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <div id="libraries-section-admin" class="library-section" style="display:none;">
          <h3 class="form-section-title">
            <span class="form-section-icon">üìö</span>
            Select Libraries
          </h3>
          <div class="form-group">
            <label class="form-label">Select Libraries to make available:</label>
            <div id="libraries-list-admin" class="library-list"></div>
          </div>
        </div>
        
        <div id="library-descriptions-section-admin" class="description-section" style="display:none;">
          <h3 class="form-section-title">
            <span class="form-section-icon">üìù</span>
            Library Descriptions
          </h3>
          <div class="form-group">
            <label class="form-label">Enter a description for each selected library (optional):</label>
            <div id="library-descriptions-list-admin"></div>
          </div>
        </div>
        
        <div id="library-carousels-section-admin" class="form-section" style="display:none;">
          <h3 class="form-section-title">
            <span class="form-section-icon">üé†</span>
            Library Carousel Settings
          </h3>
          <div class="form-group">
            <label class="form-label">Select which libraries should show their own carousel:</label>
            <div class="info-box">
              <span>‚ÑπÔ∏è</span>
              <span>Uncheck to hide the carousel for that library. Users can still request access and see its contents on Media Lists.</span>
            </div>
            <div class="notification-options" id="library-carousels-list-admin"></div>
          </div>
        </div>

        <div id="abs-section-admin" class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üìö</span>
            Audiobookshelf Configuration
          </h3>
          <div class="form-group">
            <label class="form-label">Audiobook Library ID:</label>
            <div class="input-with-icon">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobook Library ID" class="input-icon-img">
              <input type="text" name="audiobooks_id" id="audiobooks_id" value="{{ AUDIOBOOKS_ID or '' }}" class="form-input">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Audiobookshelf Server URL:</label>
            <div class="input-with-icon">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf Server URL" class="input-icon-img">
              <input type="text" name="audiobookshelf_url" id="audiobookshelf_url_admin" value="{{ AUDIOBOOKSHELF_URL or '' }}" class="form-input">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Audiobookshelf API Token:</label>
            <div class="input-with-icon">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf API Token" class="input-icon-img">
              <div class="password-input-group">
                <input type="password" name="audiobookshelf_token" id="audiobookshelf_token_admin" value="{{ AUDIOBOOKSHELF_TOKEN or '' }}" class="form-input">
                <button type="button" onclick="togglePasswordVisibility('audiobookshelf_token_admin')" class="password-toggle-btn">üëÅ</button>
              </div>
            </div>
          </div>
          
          <div class="info-box">
            <span>‚ÑπÔ∏è</span>
            <span>Leave all fields empty to disable Audiobookshelf integration. All fields are required.</span>
          </div>
        </div>

        
        <div id="discord-section-admin" class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üì¢</span>
            Discord Notifications
          </h3>
          
          <div class="form-group">
            <label class="form-label">Notification Events:</label>
            <div class="notification-options">
              <label class="checkbox-option">
                <input type="checkbox" name="discord_notify_plex" id="discord_notify_plex" value="1" {% if DISCORD_NOTIFY_PLEX == '1' %}checked{% endif %}>
                <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
                <span>Notify on new Plex user request</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="discord_notify_abs" id="discord_notify_abs" value="1" {% if DISCORD_NOTIFY_ABS == '1' %}checked{% endif %}>
                <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
                <span>Notify on new Audiobookshelf user request</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Webhook URL:</label>
            <input type="text" name="discord_webhook" id="discord_webhook_admin" value="{{ DISCORD_WEBHOOK or '' }}" class="form-input" placeholder="https://discord.com/api/webhooks/...">
            <div class="file-help">Leave blank to disable Discord notifications</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Username (optional):</label>
            <input type="text" name="discord_username" id="discord_username_admin" value="{{ DISCORD_USERNAME or '' }}" class="form-input" placeholder="Onboarderr">
          </div>
          
          <div class="form-group">
            <label class="form-label">Avatar URL (optional):</label>
            <input type="text" name="discord_avatar" id="discord_avatar_admin" value="{{ DISCORD_AVATAR or '' }}" class="form-input" placeholder="Default Logo">
          </div>
          
          <div class="form-group">
            <label class="form-label">Color (optional):</label>
            <input type="text" name="discord_color" id="discord_color_admin" value="{{ DISCORD_COLOR or '' }}" class="form-input" placeholder="#000000">
          </div>
        </div>

        <!-- Quick Access Configuration -->
        <div class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">‚ö°</span>
             Quick Access Links
          </h3>
                  
           <div class="form-group">
            <label class="form-label">Display Quick Access Links?</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="quick_access_enabled" value="yes" id="quick_access_enabled_yes" class="radio-input" {% if QUICK_ACCESS_ENABLED == 'yes' or not QUICK_ACCESS_ENABLED %}checked{% endif %}>
                <span>Yes</span>
              </label>
               <label class="radio-option">
                <input type="radio" name="quick_access_enabled" value="no" id="quick_access_enabled_no" class="radio-input" {% if QUICK_ACCESS_ENABLED == 'no' %}checked{% endif %}>
                <span>No</span>
              </label>
            </div>
             <div class="file-help">
              Quick access links appear as a floating panel on desktop and in the mobile navigation menu. They provide direct access to your media services.
             </div>
           </div>
         </div>
        
        <!-- Editable Service URLs -->
        <div class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üîó</span>
            Public Service URLs
          </h3>
          {% for service in all_services %}
            <div class="form-group">
              <label class="form-label">{{ service.name }}:</label>
              <div class="service-url-input">
                <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="service-icon">
                <input type="text" name="{{ service.env }}" value="{{ service.url }}" class="form-input">
              </div>
            </div>
          {% endfor %}
        </div>
        
        {% if error_message %}
        <div id="admin-setup-message" class="error-box">{{ error_message }}</div>
        {% else %}
        <div id="admin-setup-message" class="error-box" style="display: none;"></div>
        {% endif %}
        
        <div class="submit-section">
          <button type="submit" id="admin-submit-btn" class="submit-btn">Apply Settings</button>
        </div>
        
        <div class="info-box">
          <span>‚ÑπÔ∏è</span>
          <span><strong>Note:</strong> Changes will only take effect after you restart the server.</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>

  <script>
    // Password visibility toggle function
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const button = input.nextElementSibling;
      
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅ';
      }
    }
    
    // Initialize password validation
    function validateAdminPasswords() {
      var site = document.getElementById('admin_site_password_box').value.trim();
      var admin = document.getElementById('admin_admin_password_box').value.trim();
      var errorDiv = document.getElementById('admin-passwords-error');
      var submitBtn = document.getElementById('admin-submit-btn');
      let valid = true;
      if (!site && !admin) {
          errorDiv.textContent = '';
          valid = true;
      } else if (!site || !admin) {
          errorDiv.textContent = 'If changing, both SITE_PASSWORD and ADMIN_PASSWORD are required.';
          valid = false;
      } else if (site === admin) {
          errorDiv.textContent = 'SITE_PASSWORD and ADMIN_PASSWORD must be different.';
          valid = false;
      } else {
          errorDiv.textContent = '';
          valid = true;
      }
      if (submitBtn) submitBtn.disabled = !valid;
  }
  
  validateAdminPasswords();
  document.getElementById('admin_site_password_box').addEventListener('input', validateAdminPasswords);
  document.getElementById('admin_admin_password_box').addEventListener('input', validateAdminPasswords);
  
  // COLOR PICKER - THIS IS THE IMPORTANT PART
  const colorPicker = document.getElementById('accent_color');
  const colorText = document.getElementById('accent_color_text');
  
  if (colorPicker && colorText) {
      colorPicker.addEventListener('input', function() {
          colorText.value = this.value;
      });
      
      colorText.addEventListener('input', function() {
          if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
              colorPicker.value = this.value;
          }
      });
  }
  
  // Other functions...
  function fetchLibrariesAdmin() {
      var token = document.getElementById('plex_token').value;
      var url = document.getElementById('plex_url').value;
      if (!token || !url) {
          alert('Please enter Plex Token and URL first.');
          return;
      }
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/fetch-libraries', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
              plex_token: token,
              plex_url: url
          })
      }).then(response => response.json()).then(data => {
          var section = document.getElementById('libraries-section-admin');
          var list = document.getElementById('libraries-list-admin');
          var descSection = document.getElementById('library-descriptions-section-admin');
          var descList = document.getElementById('library-descriptions-list-admin');
          var carouselSection = document.getElementById('library-carousels-section-admin');
          var carouselList = document.getElementById('library-carousels-list-admin');
          list.innerHTML = '';
          descList.innerHTML = '';
          carouselList.innerHTML = '';
          
          // Get currently selected library IDs
          var currentLibraryIds = [];
          {% if LIBRARY_IDS %}
              {% set selected_ids = LIBRARY_IDS.split(',') %}
              {% for lib_id in selected_ids %}
                  {% if lib_id.strip() %}
                      currentLibraryIds.push('{{ lib_id.strip() }}');
                  {% endif %}
              {% endfor %}
          {% endif %}
          
          if (data.libraries && data.libraries.length > 0) {
              section.style.display = 'block';
              data.libraries.forEach(function(lib) {
                  var checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.name = 'library_ids';
                  checkbox.value = lib.key;
                  checkbox.id = 'admin_lib_' + lib.key;
                  checkbox.className = 'library-checkbox';
                  
                  // Check if this library is currently active
                  if (currentLibraryIds.includes(lib.key)) {
                      checkbox.checked = true;
                  }
                  
                  var label = document.createElement('label');
                  label.htmlFor = checkbox.id;
                  label.className = 'library-item';
                  
                  var titleSpan = document.createElement('span');
                  titleSpan.className = 'library-title';
                  titleSpan.innerText = lib.title;
                  
                  var idSpan = document.createElement('span');
                  idSpan.className = 'library-id';
                  idSpan.innerText = '(' + lib.key + ')';
                  
                  label.appendChild(checkbox);
                  label.appendChild(titleSpan);
                  label.appendChild(idSpan);
                  list.appendChild(label);
                  
                  var descDiv = document.createElement('div');
                  descDiv.id = 'admindescdiv_' + lib.key;
                  descDiv.style.display = checkbox.checked ? 'block' : 'none';
                  descDiv.className = 'description-item';
                  
                  var descLabel = document.createElement('label');
                  descLabel.className = 'description-label';
                  descLabel.innerText = 'Description for ' + lib.title + ':';
                  
                  var descInput = document.createElement('input');
                  descInput.type = 'text';
                  descInput.name = 'library_desc_' + lib.key;
                  descInput.className = 'form-input';
                  
                  descDiv.appendChild(descLabel);
                  descDiv.appendChild(descInput);
                  descList.appendChild(descDiv);
                  
                  // Add carousel checkbox
                  var carouselLabel = document.createElement('label');
                  carouselLabel.className = 'checkbox-option';
                  carouselLabel.style.display = checkbox.checked ? 'flex' : 'none';
                  
                  var carouselCheckbox = document.createElement('input');
                  carouselCheckbox.type = 'checkbox';
                  carouselCheckbox.name = 'library_carousels';
                  carouselCheckbox.value = lib.key;
                  carouselCheckbox.id = 'admin_carousel_' + lib.key;
                  carouselCheckbox.className = 'checkbox-input';
                  
                  // Check if this library has carousel enabled
                  var currentCarousels = [];
                  {% if LIBRARY_CAROUSELS %}
                      {% set carousel_ids = LIBRARY_CAROUSELS.split(',') %}
                      {% for carousel_id in carousel_ids %}
                          {% if carousel_id.strip() %}
                              currentCarousels.push('{{ carousel_id.strip() }}');
                          {% endif %}
                      {% endfor %}
                  {% endif %}
                  
                  // Default to checked for new libraries, or if already in current carousels
                  if (currentCarousels.includes(lib.key) || currentCarousels.length === 0) {
                      carouselCheckbox.checked = true;
                  }
                     
                  var carouselSpan = document.createElement('span');
                  carouselSpan.textContent = lib.title;
                     
                  carouselLabel.appendChild(carouselCheckbox);
                  carouselLabel.appendChild(carouselSpan);
                  carouselList.appendChild(carouselLabel);
                  
                  // Add change event listener to update libraries immediately
                  checkbox.addEventListener('change', function() {
                      descDiv.style.display = checkbox.checked ? 'block' : 'none';
                      carouselLabel.style.display = checkbox.checked ? 'flex' : 'none';
                      updateLibrariesImmediately();
                  });
              });
              descSection.style.display = 'block';
              carouselSection.style.display = 'block';
          } else {
              section.style.display = 'none';
              descSection.style.display = 'none';
              carouselSection.style.display = 'none';
              alert('No libraries found or error fetching libraries.');
          }
      }).catch((err) => {
          alert('Failed to fetch libraries.');
          console.error(err);
      });
  }
  
  function updateLibrariesImmediately() {
      var selectedLibraries = [];
      document.querySelectorAll('input[name="library_ids"]:checked').forEach(function(cb) {
          selectedLibraries.push(cb.value);
      });
      
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/ajax/update-libraries', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
              library_ids: selectedLibraries
          })
      }).then(response => response.json()).then(data => {
          if (data.success) {
              // Update the current library display
              updateCurrentLibrariesDisplay(selectedLibraries);
              // Trigger poster refresh
              triggerPosterRefresh();
          } else {
              console.error('Failed to update libraries:', data.error);
          }
      }).catch(error => {
          console.error('Error updating libraries:', error);
      });
  }
  
  function updateCurrentLibrariesDisplay(selectedLibraries) {
      var currentDisplay = document.querySelector('.current-library-selection');
      if (currentDisplay) {
          var libraryNotes = {{ library_notes | tojson }};
          var html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">';
          html += '<strong style="display:block;">Currently Selected Libraries:</strong>';
          html += '<button type="button" onclick="refreshLibraryTitles()" style="padding: 0.3em 0.8em; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Refresh Titles</button>';
          html += '</div>';
          
          if (selectedLibraries.length === 0) {
              html += '<div style="color: #888; font-style: italic;">No libraries selected</div>';
          } else {
              selectedLibraries.forEach(function(libId) {
                  var title = 'Unknown';
                  var description = '';
                  if (libraryNotes[libId] && libraryNotes[libId].title) {
                      title = libraryNotes[libId].title;
                  }
                  if (libraryNotes[libId] && libraryNotes[libId].description) {
                      description = libraryNotes[libId].description;
                  }
                  
                  html += '<div style="margin-bottom: 0.5em;">';
                  html += '<strong>' + title + ' (' + libId + ')</strong>';
                  if (description) {
                      html += '<span style="color: #888; font-size: 0.9em;">‚Äî ' + description + '</span>';
                  }
                  html += '</div>';
              });
          }
          
          currentDisplay.innerHTML = html;
      }
  }
  
  function triggerPosterRefresh() {
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/trigger-poster-downloads', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          }
      }).then(response => response.json()).then(data => {
          if (data.success) {
              console.log('Poster refresh triggered successfully');
          } else {
              console.error('Failed to trigger poster refresh:', data.error);
          }
      }).catch(error => {
          console.error('Error triggering poster refresh:', error);
      });
  }
  
  // Refresh library titles (kept for compatibility, but updateLibrariesImmediately is now primary)
  function refreshLibraryTitles() {
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Refreshing...';
      button.disabled = true;
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/refresh-library-titles', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({})
      }).then(response => response.json()).then(data => {
          if (data.success) {
              window.location.reload();
          } else {
              alert('Failed to refresh library titles: ' + (data.error || 'Unknown error'));
              button.textContent = originalText;
              button.disabled = false;
          }
      }).catch(error => {
          console.error('Error:', error);
          alert('Failed to refresh library titles. Please check your Plex connection.');
          button.textContent = originalText;
          button.disabled = false;
      });
  }
  </script>
  
  <!-- AJAX Functions for Services Page -->
  <script>
    // Delete Plex request
    async function deletePlexRequest(index) {
      if (!confirm('Are you sure you want to delete this Plex request?')) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/delete-plex-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ delete_index: index })
        });
        
        const result = await response.json();
        if (result.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-plex-index="${index}"]`);
          if (row) {
            row.remove();
          }
          // If no more submissions, reload the page to show "No Plex requests found"
          const tbody = document.querySelector('table tbody');
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        } else {
          alert('Failed to delete request: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete request. Please try again.');
      }
    }
    
    // Delete Audiobookshelf request
    async function deleteAbsRequest(index) {
      if (!confirm('Are you sure you want to delete this Audiobookshelf request?')) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/delete-abs-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ delete_index: index })
        });
        
        const result = await response.json();
        if (result.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-abs-index="${index}"]`);
          if (row) {
            row.remove();
          }
          // If no more submissions, reload the page to show "No Audiobookshelf requests found"
          const tbody = document.querySelector('.scrollable-table-container table tbody');
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        } else {
          alert('Failed to delete request: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete request. Please try again.');
      }
    }
    
    // Invite Plex users
    async function invitePlexUsers() {
      const selectedCheckboxes = document.querySelectorAll('.plex-user-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one user to invite.');
        return;
      }
      
      const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Inviting...';
      button.disabled = true;
      
      try {
        const response = await fetch('/ajax/invite-plex-users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ selected_indices: selectedIndices })
        });
        
        const result = await response.json();
        if (result.success) {
          // Show results
          showPlexInviteResults(result.results);
          // Reload page to update the list
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          alert('Failed to invite users: ' + (result.error || 'Unknown error'));
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to invite users. Please try again.');
        button.textContent = originalText;
        button.disabled = false;
      }
    }
    
    // Create Audiobookshelf users
    async function createAbsUsers() {
      const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one user to create.');
        return;
      }
      
      const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
      const userType = document.getElementById('abs_user_type').value;
      const selectedPermissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Creating...';
      button.disabled = true;
      
      try {
        const response = await fetch('/ajax/create-abs-users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            selected_indices: selectedIndices,
            user_type: userType,
            permissions: selectedPermissions
          })
        });
        
        const result = await response.json();
        if (result.success) {
          // Show results
          showAbsCreationResults(result.results);
          // Reload page to update the list
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          alert('Failed to create users: ' + (result.error || 'Unknown error'));
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to create users. Please try again.');
        button.textContent = originalText;
        button.disabled = false;
      }
    }
    
    // Show Plex invite results
    function showPlexInviteResults(results) {
      const form = document.getElementById('plex-user-invite-form');
      const resultsDiv = document.createElement('div');
      resultsDiv.style.marginTop = '2em';
      resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Invitation Results:</h4>';
      
      results.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.style.marginBottom = '1em';
        resultDiv.style.padding = '0.8em';
        resultDiv.style.borderRadius = '0.3em';
        resultDiv.style.borderLeft = '4px solid';
        
        if (result.success) {
          resultDiv.style.background = '#1a3a1a';
          resultDiv.style.borderLeftColor = '#4CAF50';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
            <div style="color: #4CAF50; font-weight: 500;">‚úÖ ${result.message || 'Successfully invited user'}</div>
          `;
        } else {
          resultDiv.style.background = '#3a1a1a';
          resultDiv.style.borderLeftColor = '#f44336';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
            <div style="color: #f44336; font-weight: 500;">‚ùå Failed to invite user: ${result.error}</div>
          `;
        }
        
        resultsDiv.appendChild(resultDiv);
      });
      
      form.appendChild(resultsDiv);
    }
    
    // Show ABS creation results
    function showAbsCreationResults(results) {
      const form = document.getElementById('abs-user-creation-form');
      const resultsDiv = document.createElement('div');
      resultsDiv.style.marginTop = '2em';
      resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Creation Results:</h4>';
      
      results.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.style.marginBottom = '1em';
        resultDiv.style.padding = '0.8em';
        resultDiv.style.borderRadius = '0.3em';
        resultDiv.style.borderLeft = '4px solid';
        
        if (result.success) {
          resultDiv.style.background = '#1a3a1a';
          resultDiv.style.borderLeftColor = '#4CAF50';
          let resultHtml = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
            <div style="color: #4CAF50; font-weight: 500;">‚úÖ Successfully created user</div>
          `;
          if (result.user_id) {
            resultHtml += `<div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">User ID: ${result.user_id}</div>`;
          }
          resultDiv.innerHTML = resultHtml;
        } else {
          resultDiv.style.background = '#3a1a1a';
          resultDiv.style.borderLeftColor = '#f44336';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
            <div style="color: #f44336; font-weight: 500;">‚ùå Failed to create user: ${result.error}</div>
          `;
        }
        
        resultsDiv.appendChild(resultDiv);
      });
      
      form.appendChild(resultsDiv);
    }
  </script>

</body>
</html>
