<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} - Admin</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}">
  <link rel="stylesheet" href="/static/modern-style.css">
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
    
    // Smooth scroll to section function
    function scrollToSection(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        // Add offset to account for any fixed headers
        const offset = 20;
        const elementPosition = element.offsetTop - offset;
        
        window.scrollTo({
          top: elementPosition,
          behavior: 'smooth'
        });
      }
    }
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}

  <div class="onboarding-content">
    <!-- Jump to Section Navigation -->
    <div class="onboarding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">ü¶ò</span>
        Jump to Section
      </h2>
      <div class="jump-nav-links">
        <a href="#services-section" class="jump-nav-link" onclick="scrollToSection('services-section')">
          <span class="jump-nav-icon">üîó</span>
          <span>Services</span>
        </a>
        <a href="#plex-requests-section" class="jump-nav-link" onclick="scrollToSection('plex-requests-section')">
          <span class="jump-nav-icon">üì∫</span>
          <span>Plex Requests</span>
        </a>
        {% if ABS_ENABLED == 'yes' %}
        <a href="#audiobookshelf-requests-section" class="jump-nav-link" onclick="scrollToSection('audiobookshelf-requests-section')">
          <span class="jump-nav-icon">üìö</span>
          <span>Audiobookshelf Requests</span>
        </a>
        {% endif %}
        <a href="#storage-section" class="jump-nav-link" onclick="scrollToSection('storage-section')">
          <span class="jump-nav-icon">üíæ</span>
          <span>Storage</span>
        </a>
        <a href="#authentication-section" class="jump-nav-link" onclick="scrollToSection('authentication-section')">
          <span class="jump-nav-icon">üîê</span>
          <span>Authentication</span>
        </a>
        <a href="#branding-section" class="jump-nav-link" onclick="scrollToSection('branding-section')">
          <span class="jump-nav-icon">üé®</span>
          <span>Branding Configuration</span>
        </a>
        <a href="#plex-config-section" class="jump-nav-link" onclick="scrollToSection('plex-config-section')">
          <span class="jump-nav-icon">üé¨</span>
          <span>Plex Configuration</span>
        </a>
        <a href="#audiobookshelf-config-section" class="jump-nav-link" onclick="scrollToSection('audiobookshelf-config-section')">
          <span class="jump-nav-icon">üìö</span>
          <span>Audiobookshelf Configuration</span>
        </a>
        <a href="#discord-section" class="jump-nav-link" onclick="scrollToSection('discord-section')">
          <span class="jump-nav-icon">üì¢</span>
          <span>Discord Notifications</span>
        </a>
        <a href="#ip-management-section" class="jump-nav-link" onclick="scrollToSection('ip-management-section')">
          <span class="jump-nav-icon">üõ°Ô∏è</span>
          <span>IP Management</span>
        </a>
        <a href="#quick-access-section" class="jump-nav-link" onclick="scrollToSection('quick-access-section')">
          <span class="jump-nav-icon">‚ö°</span>
          <span>Quick Access Links</span>
        </a>
        <a href="#rate-limit-settings-section" class="jump-nav-link" onclick="scrollToSection('rate-limit-settings-section')">
          <span class="jump-nav-icon">üìà</span>
          <span>Rate Limiting Settings</span>
        </a>
        <a href="#service-urls-section" class="jump-nav-link" onclick="scrollToSection('service-urls-section')">
          <span class="jump-nav-icon">üîó</span>
          <span>Service URLs</span>
        </a>
      </div>
    </div>
    {% if custom_services_url %}
      <div class="onboarding-section">
        <div class="info-box">
          <span>üîó</span>
          <span><a href="{{ custom_services_url }}" target="_blank" class="accent" style="font-size: 1.2em;">Open Custom Services Page</a></span>
        </div>
        <!-- Optionally, embed the page below -->
        <iframe src="{{ custom_services_url }}" style="width:100%;height:600px;border:1px solid var(--border);margin-top:1em;border-radius: 0.5rem;"></iframe>
      </div>
    {% elif show_services %}
      <div class="onboarding-section" id="services-section">
        <h2 class="form-section-title">
          <span class="form-section-icon">üîó</span>
          Services
        </h2>
        <div class="services-grid">
          {% for service in services %}
            <a href="{{ service.url }}" class="service-card" target="_blank">
              <div class="service-icon-container">
                <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="service-icon">
              </div>
              <span class="service-name">{{ service.name }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="onboarding-section" id="plex-requests-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üì∫</span>
        Plex Requests
      </h2>
      {% if submissions %}
        <div class="scrollable-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Libraries</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in submissions %}
                <tr data-plex-index="{{ loop.index0 }}">
                  <td>{{ submission.email }}</td>
                  <td>{{ submission.libraries_titles | join(', ') }}</td>
                  <td>
                    <button type="button" onclick="deletePlexRequest({{ loop.index0 }})" class="btn btn-secondary">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">No Plex requests found.</p>
      {% endif %}

      <!-- Plex User Invitation Section -->
      {% if submissions %}
      <div class="form-section">
        <h3 class="form-section-title">
          <span class="form-section-icon">üë•</span>
          Invite Plex Users
        </h3>
        <div class="info-box">
          <span>‚ÑπÔ∏è</span>
          <span>Select submissions to invite users to your Plex server. Users will be invited with access to the selected libraries.</span>
        </div>
        <form id="plex-user-invite-form">
          <div class="form-group">
            <label class="form-label">Select submissions to invite:</label>
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" id="select_all_plex_users">
                <span>Select All</span>
              </label>
            </div>
            {% for submission in submissions %}
              <div class="user-selection-item">
                <label class="checkbox-option">
                  <input type="checkbox" name="invite_users" value="{{ loop.index0 }}" id="invite_user_{{ loop.index0 }}" class="plex-user-checkbox">
                  <div class="user-info">
                    <strong>{{ submission.email }}</strong>
                    <div class="user-details">
                      Libraries: {{ submission.libraries_titles | join(', ') }} | 
                      Submitted: {{ submission.submitted_at[:10] }}
                    </div>
                  </div>
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="submit-section">
            <button type="button" onclick="invitePlexUsers()" class="submit-btn">
              Invite Selected Users to Plex
            </button>
          </div>
        </form>
        {% if plex_invite_results %}
        <div class="results-section">
          <h4 class="form-section-title">Invitation Results:</h4>
          {% for result in plex_invite_results %}
            <div class="result-item {% if result.success %}success{% else %}error{% endif %}">
              <div class="result-title">{{ result.email }}</div>
              <div class="result-message">
                {% if result.success %}
                  ‚úÖ {{ result.message or 'Successfully invited user' }}
                {% else %}
                  ‚ùå Failed to invite user: {{ result.error }}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    {% if ABS_ENABLED == 'yes' %}
    <div class="onboarding-section" id="audiobookshelf-requests-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üìö</span>
        Audiobookshelf Requests
      </h2>
      {% if audiobookshelf_submissions %}
      <div class="warning-box">
        <span>‚ö†Ô∏è</span>
        <span>Passwords are censored for security. They are still available for user creation.</span>
      </div>
      {% endif %}
      {% if audiobookshelf_submissions %}
        <div class="scrollable-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Username</th>
                <th>Password</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in audiobookshelf_submissions %}
                <tr data-abs-index="{{ loop.index0 }}">
                  <td>{{ submission.email }}</td>
                  <td>{{ submission.username }}</td>
                  <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                  <td>
                    <button type="button" onclick="deleteAbsRequest({{ loop.index0 }})" class="btn btn-secondary">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- ABS User Creation Section -->
        <div class="form-section">
          <h3 class="form-section-title">
            <span class="form-section-icon">üë•</span>
            Create Audiobookshelf Users
          </h3>
          <div class="info-box">
            <span>‚ÑπÔ∏è</span>
            <span>Select submissions to create users in Audiobookshelf. Users will be created with the specified username and password.</span>
          </div>
          
          <form id="abs-user-creation-form">
            <div class="form-group">
              <label class="form-label">Select submissions to create users:</label>
              <div class="checkbox-group">
                <label class="checkbox-option">
                  <input type="checkbox" id="select_all_users">
                  <span>Select All</span>
                </label>
              </div>
              {% for submission in audiobookshelf_submissions %}
                <div class="user-selection-item">
                  <label class="checkbox-option">
                    <input type="checkbox" name="create_users" value="{{ loop.index0 }}" id="create_user_{{ loop.index0 }}" class="user-checkbox">
                    <div class="user-info">
                      <strong>{{ submission.username }}</strong> ({{ submission.email }})
                      <div class="user-details">
                        Password: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ | Submitted: {{ submission.submitted_at[:10] }}
                      </div>
                    </div>
                  </label>
                </div>
              {% endfor %}
            </div>
            
            <div class="form-group">
              <label class="form-label">User Type:</label>
              <select name="user_type" id="abs_user_type" class="form-input" style="width: 200px;">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="guest">Guest</option>
              </select>
              <div class="file-help">
                <strong>User:</strong> Standard user access | <strong>Admin:</strong> Full administrative access | <strong>Guest:</strong> Limited access
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Permissions:</label>
              <div class="permissions-grid">
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="download" checked>
                  <span>Download items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="update">
                  <span>Update library items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="delete">
                  <span>Delete library items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="upload">
                  <span>Upload items</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessAllLibraries" checked>
                  <span>Access all libraries</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessAllTags" checked>
                  <span>Access all tags</span>
                </label>
                <label class="checkbox-option">
                  <input type="checkbox" name="permissions" value="accessExplicitContent" checked>
                  <span>Access explicit content</span>
                </label>
              </div>
            </div>
            
            <div class="submit-section">
              <button type="button" onclick="createAbsUsers()" class="submit-btn">
                Create Selected Users in Audiobookshelf
              </button>
            </div>
          </form>
          
          {% if abs_user_creation_results %}
          <div class="results-section">
            <h4 class="form-section-title">Creation Results:</h4>
            {% for result in abs_user_creation_results %}
              <div class="result-item {% if result.success %}success{% else %}error{% endif %}">
                <div class="result-title">{{ result.username }} ({{ result.email }})</div>
                <div class="result-message">
                  {% if result.success %}
                    ‚úÖ Successfully created user
                  {% else %}
                    ‚ùå Failed to create user: {{ result.error }}
                  {% endif %}
                </div>
                {% if result.success and result.user_id %}
                  <div class="result-details">User ID: {{ result.user_id }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      {% else %}
        <p class="muted">No Audiobookshelf requests found.</p>
      {% endif %}
    </div>
    {% endif %}

    <div class="onboarding-section" id="storage-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üíæ</span>
        Storage
      </h2>
      <div class="storage-info">
        {% for drive in storage_info %}
          <div class="storage-item">
            <div class="storage-header">
              <strong>{{ drive.mount }}</strong>
              <span class="storage-stats">{{ drive.used }} GB used / {{ drive.total }} GB total ({{ drive.percent }}%)</span>
            </div>
            <div class="storage-bar">
              <div class="storage-bar-fill" style="width: {{ drive.percent }}%;"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Authentication Section -->
    <div class="onboarding-section" id="authentication-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üîê</span>
        Authentication
      </h2>
      
      <div class="warning-box">
        <span>üîë</span>
        <span><strong>SITE_PASSWORD</strong> and <strong>ADMIN_PASSWORD</strong> must be different.</span>
      </div>
      
      <div class="form-group">
        <label class="form-label">SITE_PASSWORD (for guests):</label>
        <div class="input-with-icon">
          <span class="input-icon">üîë</span>
          <input type="text" name="site_password" id="admin_site_password_box" value="{{ SITE_PASSWORD or '' }}" class="form-input">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">ADMIN_PASSWORD (for admin):</label>
        <div class="input-with-icon">
          <span class="input-icon">üîë</span>
          <input type="text" name="admin_password" id="admin_admin_password_box" value="{{ ADMIN_PASSWORD or '' }}" class="form-input">
        </div>
      </div>

      <div class="file-help">
        Leaving either field blank will keep the current password.
      </div>
      
      <div id="admin-passwords-error" class="error-box" style="display: none;"></div>
    </div>

    <!-- Branding Configuration Section -->
    <div class="onboarding-section" id="branding-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üé®</span>
        Branding Configuration
      </h2>
      
      <div class="form-group">
        <label class="form-label">Server Name:</label>
        <div class="input-with-icon">
          <img src="{{ url_for('static', filename=logo_filename) }}" alt="Server Name" class="input-icon-img">
          <input type="text" name="server_name" id="server_name" value="{{ SERVER_NAME or '' }}" class="form-input">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Accent Color:</label>
        <div class="color-picker-group">
          <input type="color" name="accent_color" id="accent_color" value="{{ ACCENT_COLOR or '#d33fbc' }}" class="color-picker">
          <input type="text" name="accent_color_text" id="accent_color_text" value="{{ ACCENT_COLOR or '#d33fbc' }}" placeholder="#d33fbc" class="form-input color-input">
        </div>
        <div class="color-help">Choose your theme color</div>
      </div>
      
      <div class="form-group">          
        <div class="form-group">
          <label class="form-label">Select New Logo:</label>
          <input type="file" name="logo_file" id="logo_file" accept=".png,.webp,.jpg,.jpeg" class="file-input">
          <div class="file-help">
            Transparent .png or .webp, ~350x350, 1:1<br>
            This will replace the logo and automatically create a favicon.
          </div>
          <div class="info-box">
            <span>üí°</span>
            <div>
              <strong>Need a logo?</strong><br>
              ‚Ä¢ <a href="https://vectorink.io/app/canvas" target="_blank" class="accent">Simple Vector Editor</a> - Create a custom logo<br>
              ‚Ä¢ <a href="http://logobook.com/letter/a/" target="_blank" class="accent">Letter Logos</a> - Find a logo for any letter
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Select New Wordmark:</label>
          <input type="file" name="wordmark_file" id="wordmark_file" accept=".png,.webp,.jpg,.jpeg" class="file-input">
          <div class="file-help">
            Transparent .png or .webp, minimum dimensions ~1000x250, 4:1 or wider<br>
            This will replace the wordmark image.
          </div>
          <div class="info-box">
            <span>üí°</span>
            <div>
              <strong>Need a wordmark?</strong><br>
              ‚Ä¢ <a href="https://fontmeme.com/netflix-font/" target="_blank" class="accent">Wordmark Generator</a> - Create text-based wordmarks<br>
              <span style="color: var(--text-secondary); font-size: 0.8em;">Try different fonts, make the output text as big as slider allows, and use the same hex as the accent.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Plex Configuration Section -->
    <div class="onboarding-section" id="plex-config-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üé¨</span>
        Plex Configuration
      </h2>
      
      <div class="form-group">
        <label class="form-label">Plex Token:</label>
        <div class="input-with-icon">
          <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex Token" class="input-icon-img">
          <div class="password-input-group">
            <input type="password" name="plex_token" id="plex_token" value="{{ PLEX_TOKEN or '' }}" class="form-input">
            <button type="button" onclick="togglePasswordVisibility('plex_token')" class="password-toggle-btn">üëÅ</button>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Plex URL:</label>
        <div class="input-with-icon">
          <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex URL" class="input-icon-img">
          <input type="text" name="plex_url" id="plex_url" value="{{ PLEX_URL or '' }}" class="form-input">
        </div>
      </div>
      
      <div class="form-group">
        <button type="button" onclick="fetchLibrariesAdmin()" class="btn btn-secondary">Fetch Plex Libraries</button>
      </div>
             
      <div id="libraries-section-admin" class="library-section" style="display:none;">
        <h3 class="form-section-title">
          <span class="form-section-icon">üìö</span>
          Select Libraries
        </h3>
        <div class="form-group">
          <label class="form-label">Select Libraries to make available:</label>
          <div id="libraries-list-admin" class="library-list"></div>
        </div>
      </div>
      
      <!-- Current Library Selection Display -->
      <div class="current-library-selection">
        <h3 class="form-section-title">
          <span class="form-section-icon">üìö</span>
          Currently Selected Libraries
        </h3>
        {% if LIBRARY_IDS %}
          {% set selected_ids = LIBRARY_IDS.split(',') %}
          {% for lib_id in selected_ids %}
            {% if lib_id.strip() %}
              {% set lib_id_clean = lib_id.strip() %}
              <div class="selected-library-item" style="margin-bottom: 1em;">
                <div class="library-title-section">
                  <strong>
                    {% if library_notes[lib_id_clean] and library_notes[lib_id_clean]['title'] %}
                      {{ library_notes[lib_id_clean]['title'] }}
                    {% else %}
                      Unknown
                    {% endif %}
                    ({{ lib_id_clean }})
                  </strong>
                </div>
                <div class="library-description-section" style="margin-top: 0.5em;">
                  <label class="form-label">Description:</label>
                  <input type="text" name="library_desc_{{ lib_id_clean }}" 
                         value="{{ library_notes[lib_id_clean]['description'] if library_notes[lib_id_clean] and library_notes[lib_id_clean]['description'] else '' }}" 
                         class="form-input library-description-input" 
                         placeholder="Enter a description for this library (optional)"
                         onchange="syncLibraryDescription(this, '{{ lib_id_clean }}')"
                         oninput="syncLibraryDescription(this, '{{ lib_id_clean }}')">
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div style="color: #888; font-style: italic;">No libraries selected</div>
        {% endif %}
        <div class="form-group">
          <button type="button" onclick="refreshLibraryTitles()" class="btn btn-secondary" style="margin-left: 0.5em;">Refresh Library Titles</button>
        </div>
  
      </div>
        
      <div id="library-carousels-section-admin" class="form-section" style="display: {% if LIBRARY_IDS %}block{% else %}none{% endif %};">
        <h3 class="form-section-title">
          <span class="form-section-icon">üé†</span>
          Library Carousel Settings
        </h3>
        <div class="form-group">
          <label class="form-label">Select which libraries should show their own carousel:</label>
          <div class="info-box">
            <span>‚ÑπÔ∏è</span>
            <span>Uncheck to hide the carousel for that library. Users can still request access and see its contents on Media Lists.</span>
          </div>
          <div class="notification-options" id="library-carousels-list-admin">
            {% if LIBRARY_IDS %}
              {% set selected_ids = LIBRARY_IDS.split(',') %}
              {% set carousel_ids = LIBRARY_CAROUSELS.split(',') if LIBRARY_CAROUSELS else [] %}
              {% for lib_id in selected_ids %}
                {% if lib_id.strip() %}
                  {% set lib_id_clean = lib_id.strip() %}
                  {% set library_title = library_notes[lib_id_clean]['title'] if library_notes[lib_id_clean] and library_notes[lib_id_clean]['title'] else 'Unknown' %}
                  <label class="checkbox-option">
                    <input type="checkbox" name="library_carousels" value="{{ lib_id_clean }}" 
                           id="admin_carousel_{{ lib_id_clean }}" class="checkbox-input"
                           {% if lib_id_clean in carousel_ids or carousel_ids|length == 0 %}checked{% endif %}>
                    <span>{{ library_title }}</span>
                  </label>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Audiobookshelf Configuration Section -->
    <div class="onboarding-section" id="audiobookshelf-config-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üìö</span>
        Audiobookshelf Configuration
      </h2>
      
      <div class="form-group">
        <label class="form-label">Enable Audiobookshelf Configuration?</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="abs_config_enabled" value="yes" id="abs_config_enabled_yes" onchange="toggleAbsConfig()" class="radio-input" {% if ABS_ENABLED == 'yes' %}checked{% endif %}>
            <span>Yes</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="abs_config_enabled" value="no" id="abs_config_enabled_no" onchange="toggleAbsConfig()" class="radio-input" {% if ABS_ENABLED != 'yes' %}checked{% endif %}>
            <span>No</span>
          </label>
        </div>
      </div>
      
      <div id="abs-config-section" style="display: {% if ABS_ENABLED == 'yes' %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">Audiobook Library ID:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobook Library ID" class="input-icon-img">
            <input type="text" name="audiobooks_id" id="audiobooks_id" value="{{ AUDIOBOOKS_ID or '' }}" class="form-input">
          </div>
          <div class="file-help">You can get the ID string from the URL of your ABS homepage, .../audiobookshelf/library/[ID_STRING]</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Public Audiobookshelf Server URL:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf Server URL" class="input-icon-img">
            <input type="text" name="audiobookshelf_url" id="audiobookshelf_url_admin" value="{{ AUDIOBOOKSHELF_URL or '' }}" class="form-input" oninput="syncABSURLAdmin()">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Audiobookshelf API Token:</label>
          <div class="input-with-icon">
            <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf API Token" class="input-icon-img">
            <div class="password-input-group">
              <input type="password" name="audiobookshelf_token" id="audiobookshelf_token_admin" value="{{ AUDIOBOOKSHELF_TOKEN or '' }}" class="form-input" placeholder="Settings > API Keys > Add API Key">
              <button type="button" onclick="togglePasswordVisibility('audiobookshelf_token_admin')" class="password-toggle-btn">üëÅ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Discord Notifications Section -->
    <div class="onboarding-section" id="discord-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üì¢</span>
        Discord Notifications
      </h2>
      
      <div class="form-group">
        <label class="form-label">Enable Discord Notifications?</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="discord_config_enabled" value="yes" id="discord_config_enabled_yes" onchange="toggleDiscordConfig()" class="radio-input" {% if DISCORD_WEBHOOK %}checked{% endif %}>
            <span>Yes</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="discord_config_enabled" value="no" id="discord_config_enabled_no" onchange="toggleDiscordConfig()" class="radio-input" {% if not DISCORD_WEBHOOK %}checked{% endif %}>
            <span>No</span>
          </label>
        </div>
      </div>
      
      <div id="discord-config-section" style="display: {% if DISCORD_WEBHOOK %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">Notification Events:</label>
          <div class="info-box" style="margin-bottom: 1rem;">
            <span>‚ÑπÔ∏è</span>
            <span><strong>Smart Notifications:</strong> The system now intelligently reduces notification noise by only alerting on important events. Login attempts only notify on first success/failure and lockouts, not every attempt.</span>
          </div>
          <div class="notification-options">
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_plex" id="discord_notify_plex" value="1" {% if DISCORD_NOTIFY_PLEX == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>New Plex user request</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_abs" id="discord_notify_abs" value="1" {% if DISCORD_NOTIFY_ABS == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>New Audiobookshelf user request</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_rate_limiting" id="discord_notify_rate_limiting" value="1" {% if DISCORD_NOTIFY_RATE_LIMITING == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>Rate limiting events (first failed attempt + lockouts)</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_ip_management" id="discord_notify_ip_management" value="1" {% if DISCORD_NOTIFY_IP_MANAGEMENT == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>IP management events</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_login_attempts" id="discord_notify_login_attempts" value="1" {% if DISCORD_NOTIFY_LOGIN_ATTEMPTS == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>Login attempts (first success + first failure + lockouts)</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_form_rate_limiting" id="discord_notify_form_rate_limiting" value="1" {% if DISCORD_NOTIFY_FORM_RATE_LIMITING == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>Form submission rate limiting</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" name="discord_notify_first_access" id="discord_notify_first_access" value="1" {% if DISCORD_NOTIFY_FIRST_ACCESS == '1' %}checked{% endif %}>
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" class="service-icon">
              <span>First-time IP access (new visitors)</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Webhook URL:</label>
          <input type="text" name="discord_webhook" id="discord_webhook_admin" value="{{ DISCORD_WEBHOOK or '' }}" class="form-input" placeholder="https://discord.com/api/webhooks/...">
          <div class="file-help">Leave blank to disable Discord notifications</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Username (optional):</label>
          <input type="text" name="discord_username" id="discord_username_admin" value="{{ DISCORD_USERNAME or '' }}" class="form-input" placeholder="Onboarderr">
        </div>
        
        <div class="form-group">
          <label class="form-label">Avatar URL (optional):</label>
          <input type="text" name="discord_avatar" id="discord_avatar_admin" value="{{ DISCORD_AVATAR or '' }}" class="form-input" placeholder="Default Logo">
        </div>
        
        <div class="form-group">
          <label class="form-label">Color (optional):</label>
          <input type="text" name="discord_color" id="discord_color_admin" value="{{ DISCORD_COLOR or '' }}" class="form-input" placeholder="#000000">
        </div>
        
        <div class="form-group">
          <label class="form-label">Onboarderr Public URL (for Discord links):</label>
          <input type="text" name="onboarderr_url" id="onboarderr_url_admin" value="{{ ONBOARDERR_URL or '' }}" class="form-input" placeholder="https://your-onboarderr-domain.com">
          <div class="file-help">This URL will be used in Discord notifications to link back to the admin page. Leave blank to disable links.</div>
        </div>
      </div>
    </div>

    <!-- Quick Access Configuration Section -->
    <div class="onboarding-section" id="quick-access-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">‚ö°</span>
        Quick Access Links
      </h2>
              
      <div class="form-group">
        <label class="form-label">Display Quick Access Links?</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="quick_access_enabled" value="yes" id="quick_access_enabled_yes" class="radio-input" {% if QUICK_ACCESS_ENABLED == 'yes' or not QUICK_ACCESS_ENABLED %}checked{% endif %}>
            <span>Yes</span>
          </label>
           <label class="radio-option">
            <input type="radio" name="quick_access_enabled" value="no" id="quick_access_enabled_no" class="radio-input" {% if QUICK_ACCESS_ENABLED == 'no' %}checked{% endif %}>
            <span>No</span>
          </label>
        </div>
         <div class="file-help">
          Quick access links appear as a floating panel on desktop and in the mobile navigation menu. They provide direct access to your media and requesting services.
         </div>
       </div>

      <!-- Quick Access Service Toggles -->
      <div id="qa-service-toggles" class="form-group" style="display: none;">
        <label class="form-label">Quick Access Services</label>
        <div class="checkbox-group">
          <label class="checkbox-option">
            <input type="checkbox" name="qa_plex_enabled" value="yes" class="checkbox-input" {% if QA_PLEX_ENABLED != 'no' %}checked{% endif %}>
            <span>Plex</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" name="qa_audiobookshelf_enabled" value="yes" class="checkbox-input" {% if QA_AUDIOBOOKSHELF_ENABLED != 'no' %}checked{% endif %}>
            <span>Audiobookshelf</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" name="qa_tautulli_enabled" value="yes" class="checkbox-input" {% if QA_TAUTULLI_ENABLED != 'no' %}checked{% endif %}>
            <span>Tautulli</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" name="qa_overseerr_enabled" value="yes" class="checkbox-input" {% if QA_OVERSEERR_ENABLED != 'no' %}checked{% endif %}>
            <span>Overseerr</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" name="qa_jellyseerr_enabled" value="yes" class="checkbox-input" {% if QA_JELLYSEERR_ENABLED != 'no' %}checked{% endif %}>
            <span>Jellyseerr</span>
          </label>
        </div>
        <div class="file-help">
          Select which services to show in the Quick Access panel. Services will only appear if they have a URL configured below.
        </div>
      </div>
    </div>

        <!-- IP Management Section -->
        <div class="onboarding-section" id="ip-management-section">
          <h2 class="form-section-title">
            <span class="form-section-icon">üõ°Ô∏è</span>
            IP Management
          </h2>
          
          <div class="form-group">
            <label class="form-label">Enable IP Management?</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="ip_management_enabled" value="yes" id="ip_management_enabled_yes" class="radio-input" {% if IP_MANAGEMENT_ENABLED == 'yes' %}checked{% endif %}>
                <span>Yes</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="ip_management_enabled" value="no" id="ip_management_enabled_no" class="radio-input" {% if IP_MANAGEMENT_ENABLED != 'yes' %}checked{% endif %}>
                <span>No</span>
              </label>
            </div>
            <div class="file-help">
              IP Management allows you to whitelist trusted IPs and blacklist malicious ones. This helps control access and prevent abuse.
            </div>
          </div>
    
          <!-- IP Management Section (shown when enabled) -->
          <div id="ip-management-content" style="display: none;">
            <div class="info-box">
              <span>‚ÑπÔ∏è</span>
              <span><strong>IP Management:</strong> Whitelisted IPs bypass all rate limiting. Blacklisted IPs are completely blocked. Use with caution.</span>
            </div>
            
            <!-- Add IP to Whitelist -->
            <div class="form-group">
              <label class="form-label">Add IP to Whitelist:</label>
              <div class="input-with-icon">
                <span class="input-icon">‚úÖ</span>
                <input type="text" name="whitelist_ip" id="whitelist_ip" placeholder="192.168.1.100 or 192.168.1.0/24" class="form-input">
              </div>
              <div class="file-help">Enter an IP address (e.g., 192.168.1.100) or IP range (e.g., 192.168.1.0/24) to whitelist (bypasses all rate limiting)</div>
              <button type="button" onclick="addToWhitelist()" class="btn btn-secondary" style="margin-top: 0.5em;">Add to Whitelist</button>
            </div>
            
            <!-- Add IP to Blacklist -->
            <div class="form-group">
              <label class="form-label">Add IP to Blacklist:</label>
              <div class="input-with-icon">
                <span class="input-icon">‚ùå</span>
                <input type="text" name="blacklist_ip" id="blacklist_ip" placeholder="192.168.1.100 or 192.168.1.0/24" class="form-input">
              </div>
              <div class="file-help">Enter an IP address (e.g., 192.168.1.100) or IP range (e.g., 192.168.1.0/24) to blacklist (completely blocked)</div>
              <button type="button" onclick="addToBlacklist()" class="btn btn-secondary" style="margin-top: 0.5em;">Add to Blacklist</button>
            </div>
            
            <!-- Current IP Lists -->
            <div class="form-group">
              <label class="form-label">Current IP Lists:</label>
              
              <!-- Whitelisted IPs -->
              <div class="ip-list-section">
                <h4 style="margin-bottom: 0.5em; color: #4CAF50;">‚úÖ Whitelisted IPs:</h4>
                {% if ip_lists.whitelisted %}
                  <div class="ip-list">
                    {% for ip in ip_lists.whitelisted %}
                      <div class="ip-item">
                        <span class="ip-address">{{ ip }}</span>
                        <button type="button" onclick="removeFromWhitelist('{{ ip }}')" class="btn btn-small btn-danger">Remove</button>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="muted">No whitelisted IPs</p>
                {% endif %}
              </div>
              
              <!-- Blacklisted IPs -->
              <div class="ip-list-section">
                <h4 style="margin-bottom: 0.5em; color: #f44336;">‚ùå Blacklisted IPs:</h4>
                {% if ip_lists.banned %}
                  <div class="ip-list">
                    {% for ip in ip_lists.banned %}
                      <div class="ip-item">
                        <span class="ip-address">{{ ip }}</span>
                        <button type="button" onclick="removeFromBlacklist('{{ ip }}')" class="btn btn-small btn-danger">Remove</button>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="muted">No blacklisted IPs</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      
    <!-- Rate Limiting Settings Section -->
    <div class="onboarding-section" id="rate-limit-settings-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üìà</span>
        Rate Limiting Settings
      </h2>
      
      <div class="form-group">
        <label class="form-label">Enable Rate Limiting Settings?</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="rate_limit_settings_enabled" value="yes" id="rate_limit_settings_enabled_yes" class="radio-input" {% if RATE_LIMIT_SETTINGS_ENABLED == 'yes' %}checked{% endif %}>
            <span>Yes (Recommended)</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="rate_limit_settings_enabled" value="no" id="rate_limit_settings_enabled_no" class="radio-input" {% if RATE_LIMIT_SETTINGS_ENABLED != 'yes' %}checked{% endif %}>
            <span>No</span>
          </label>
        </div>
        <div class="file-help">
          Rate limiting settings allow you to configure how many failed login attempts and form submissions are allowed before lockout.
        </div>
      </div>

      <!-- Rate Limiting Settings Section (shown when enabled) -->
      <div id="rate-limit-settings-content" style="display: none;">
        
        <!-- Max Login Attempts -->
        <div class="form-group">
          <label class="form-label">Max Login Attempts Before Lockout:</label>
          <select name="max_login_attempts" id="max_login_attempts" class="form-input">
            {% for i in range(0, 11) %}
              <option value="{{ i }}" {% if RATE_LIMIT_MAX_LOGIN_ATTEMPTS == i %}selected{% endif %}>
                {% if i == 0 %}Unlimited (0){% else %}{{ i }}{% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="file-help">Number of failed login attempts allowed before 1-hour lockout.</div>
        </div>
        
        <!-- Max Form Submissions -->
        <div class="form-group">
          <label class="form-label">Max Form Submissions Before 1hr Lockout:</label>
          <select name="max_form_submissions" id="max_form_submissions" class="form-input">
            {% for i in range(0, 11) %}
              <option value="{{ i }}" {% if RATE_LIMIT_MAX_FORM_SUBMISSIONS == i %}selected{% endif %}>
                {% if i == 0 %}Unlimited (0){% else %}{{ i }}{% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="file-help">Number of form submissions (Plex/Audiobookshelf requests) allowed per hour.</div>
        </div>
      </div>
    </div>
      
    <!-- Service URLs Section -->
    <div class="onboarding-section" id="service-urls-section">
      <h2 class="form-section-title">
        <span class="form-section-icon">üîó</span>
        Service URLs
      </h2>
      
      <div class="info-box">
        <span>‚ÑπÔ∏è</span>
        <span>These URLs are used in the services panel at the top of this page, and a few populate the quick access panel when enabled. Default local URLs are provided for admin-only services. For user-facing ones, put a public link that remote users can access.</span>
      </div>
      {% for service in all_services %}
        <div class="form-group">
          <label class="form-label">{{ service.name }}:</label>
          <div class="service-url-input">
            <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="service-icon">
            <input type="text" name="{{ service.env }}" value="{{ service.url }}" class="form-input">
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Main Form with Hidden Inputs -->
    <form method="post" id="admin-settings-form" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <!-- Hidden inputs to collect data from all sections -->
      <input type="hidden" name="site_password" id="site_password_hidden">
      <input type="hidden" name="admin_password" id="admin_password_hidden">
      <input type="hidden" name="server_name" id="server_name_hidden">
      <input type="hidden" name="accent_color_text" id="accent_color_text_hidden">
      <input type="hidden" name="plex_token" id="plex_token_hidden">
      <input type="hidden" name="plex_url" id="plex_url_hidden">
      <input type="hidden" name="audiobooks_id" id="audiobooks_id_hidden">
      <input type="hidden" name="audiobookshelf_url" id="audiobookshelf_url_hidden">
      <input type="hidden" name="audiobookshelf_token" id="audiobookshelf_token_hidden">
      <input type="hidden" name="discord_notify_plex" id="discord_notify_plex_hidden">
      <input type="hidden" name="discord_notify_abs" id="discord_notify_abs_hidden">
      <input type="hidden" name="discord_notify_rate_limiting" id="discord_notify_rate_limiting_hidden">
      <input type="hidden" name="discord_notify_ip_management" id="discord_notify_ip_management_hidden">
      <input type="hidden" name="discord_notify_login_attempts" id="discord_notify_login_attempts_hidden">
                    <input type="hidden" name="discord_notify_form_rate_limiting" id="discord_notify_form_rate_limiting_hidden">
              <input type="hidden" name="discord_notify_first_access" id="discord_notify_first_access_hidden">
      <input type="hidden" name="discord_webhook" id="discord_webhook_hidden">
      <input type="hidden" name="discord_username" id="discord_username_hidden">
      <input type="hidden" name="discord_avatar" id="discord_avatar_hidden">
      <input type="hidden" name="discord_color" id="discord_color_hidden">
      <input type="hidden" name="onboarderr_url" id="onboarderr_url_hidden">
      <input type="hidden" name="quick_access_enabled" id="quick_access_enabled_hidden">
      <input type="hidden" name="qa_plex_enabled" id="qa_plex_enabled_hidden">
      <input type="hidden" name="qa_audiobookshelf_enabled" id="qa_audiobookshelf_enabled_hidden">
      <input type="hidden" name="qa_tautulli_enabled" id="qa_tautulli_enabled_hidden">
      <input type="hidden" name="qa_overseerr_enabled" id="qa_overseerr_enabled_hidden">
      <input type="hidden" name="qa_jellyseerr_enabled" id="qa_jellyseerr_enabled_hidden">
      <input type="hidden" name="ip_management_enabled" id="ip_management_enabled_hidden">
      <input type="hidden" name="rate_limit_settings_enabled" id="rate_limit_settings_enabled_hidden">
      <input type="hidden" name="max_login_attempts" id="max_login_attempts_hidden">
      <input type="hidden" name="max_form_submissions" id="max_form_submissions_hidden">
      
      <!-- Service URLs hidden inputs -->
      {% for service in all_services %}
        <input type="hidden" name="{{ service.env }}" id="{{ service.env.lower() }}_hidden">
      {% endfor %}
      
      <!-- File inputs -->
      <input type="file" name="logo_file" id="logo_file_hidden" style="display: none;">
      <input type="file" name="wordmark_file" id="wordmark_file_hidden" style="display: none;">
      
      <!-- Library Description Inputs -->
      {% if LIBRARY_IDS %}
        {% set selected_ids = LIBRARY_IDS.split(',') %}
        {% for lib_id in selected_ids %}
          {% if lib_id.strip() %}
            {% set lib_id_clean = lib_id.strip() %}
            <input type="text" name="library_desc_hidden_{{ lib_id_clean }}" 
                   value="{{ library_notes[lib_id_clean]['description'] if library_notes[lib_id_clean] and library_notes[lib_id_clean]['description'] else '' }}" 
                   style="display: none;">
          {% endif %}
        {% endfor %}
      {% endif %}
      
      <!-- Submit Section -->
      {% if error_message %}
      <div id="admin-setup-message" class="error-box">{{ error_message }}</div>
      {% else %}
      <div id="admin-setup-message" class="error-box" style="display: none;"></div>
      {% endif %}
      <div class="warning-box" id="request-services-warning" style="display: none;">
        <span>‚ö†Ô∏è</span>
        <span><strong>Request Services:</strong> You can only configure one of Pulsarr, Overseerr, or Jellyseerr. These are different versions of the same type of service.</span>
      </div>
    
      <div class="info-box">
        <span>‚ÑπÔ∏è</span>
        <span>Changes will only take effect after you restart the server.</span>
      </div>

      <div class="submit-section">
        <button type="submit" id="admin-submit-btn" class="submit-btn">Apply Settings</button>
      </div>
    </form>
  </div>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>

  <script>
    // Function to sync ABS URL to service URLs section (admin page)
    function syncABSURLAdmin() {
      const absUrlInput = document.getElementById('audiobookshelf_url_admin');
      const absServiceInput = document.querySelector('input[name="AUDIOBOOKSHELF"]');
      
      if (absUrlInput && absServiceInput) {
        absServiceInput.value = absUrlInput.value;
      }
    }
    
    // Form submission handler for admin settings form
    document.addEventListener('DOMContentLoaded', function() {
      var adminForm = document.getElementById('admin-settings-form');
      if (adminForm) {
        adminForm.addEventListener('submit', function(e) {
          // Check request services validation
          if (!validateRequestServices()) {
            e.preventDefault();
            var warningDiv = document.getElementById('request-services-warning');
            if (warningDiv) {
              warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return false;
          }
        });
      }
      
      // Initialize event listeners for existing library description inputs
      var existingInputs = document.querySelectorAll('.library-description-input');
      existingInputs.forEach(function(input) {
        input.addEventListener('input', function() {
          var libId = this.name.replace('library_desc_', '');
          syncLibraryDescription(this, libId);
        });
      });
      
      // Initialize ABS URL sync on page load
      syncABSURLAdmin();
    });
  </script>

  <script>
    // Select All functionality for Plex users
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllPlex = document.getElementById('select_all_plex_users');
      const plexCheckboxes = document.querySelectorAll('.plex-user-checkbox');
      
      if (selectAllPlex) {
        selectAllPlex.addEventListener('change', function() {
          plexCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
        
        // Update Select All when individual checkboxes change
        plexCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const allChecked = Array.from(plexCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(plexCheckboxes).some(cb => cb.checked);
            selectAllPlex.checked = allChecked;
            selectAllPlex.indeterminate = anyChecked && !allChecked;
          });
        });
      }
      
      // Select All functionality for ABS users
      const selectAllAbs = document.getElementById('select_all_users');
      const absCheckboxes = document.querySelectorAll('.user-checkbox');
      
      if (selectAllAbs) {
        selectAllAbs.addEventListener('change', function() {
          absCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
        
        // Update Select All when individual checkboxes change
        absCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const allChecked = Array.from(absCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(absCheckboxes).some(cb => cb.checked);
            selectAllAbs.checked = allChecked;
            selectAllAbs.indeterminate = anyChecked && !allChecked;
          });
        });
      }
    });
    
    // Password visibility toggle function
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const button = input.nextElementSibling;
      
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅ';
      }
    }
    
    // Initialize password validation
    function validateAdminPasswords() {
      var site = document.getElementById('admin_site_password_box').value.trim();
      var admin = document.getElementById('admin_admin_password_box').value.trim();
      var errorDiv = document.getElementById('admin-passwords-error');
      var submitBtn = document.getElementById('admin-submit-btn');
      let valid = true;
      if (!site && !admin) {
          errorDiv.textContent = '';
          valid = true;
      } else if (!site || !admin) {
          errorDiv.textContent = 'If changing, both SITE_PASSWORD and ADMIN_PASSWORD are required.';
          valid = false;
      } else if (site === admin) {
          errorDiv.textContent = 'SITE_PASSWORD and ADMIN_PASSWORD must be different.';
          valid = false;
      } else {
          errorDiv.textContent = '';
          valid = true;
      }
      if (submitBtn) submitBtn.disabled = !valid;
  }
  
  validateAdminPasswords();
  document.getElementById('admin_site_password_box').addEventListener('input', validateAdminPasswords);
  document.getElementById('admin_admin_password_box').addEventListener('input', validateAdminPasswords);
  
  // COLOR PICKER - THIS IS THE IMPORTANT PART
  const colorPicker = document.getElementById('accent_color');
  const colorText = document.getElementById('accent_color_text');
  
  if (colorPicker && colorText) {
      colorPicker.addEventListener('input', function() {
          colorText.value = this.value;
      });
      
      colorText.addEventListener('input', function() {
          if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
              colorPicker.value = this.value;
          }
      });
  }
  
  // Other functions...
  function fetchLibrariesAdmin() {
      var token = document.getElementById('plex_token').value;
      var url = document.getElementById('plex_url').value;
      if (!token || !url) {
          alert('Please enter Plex Token and URL first.');
          return;
      }
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/fetch-libraries', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
              plex_token: token,
              plex_url: url
          })
      }).then(response => response.json()).then(data => {
          var section = document.getElementById('libraries-section-admin');
          var list = document.getElementById('libraries-list-admin');
          var carouselSection = document.getElementById('library-carousels-section-admin');
          var carouselList = document.getElementById('library-carousels-list-admin');
          list.innerHTML = '';
          carouselList.innerHTML = '';
          
          // Get currently selected library IDs
          var currentLibraryIds = [];
          {% if LIBRARY_IDS %}
              {% set selected_ids = LIBRARY_IDS.split(',') %}
              {% for lib_id in selected_ids %}
                  {% if lib_id.strip() %}
                      currentLibraryIds.push('{{ lib_id.strip() }}');
                  {% endif %}
              {% endfor %}
          {% endif %}
          
          if (data.libraries && data.libraries.length > 0) {
              section.style.display = 'block';
              data.libraries.forEach(function(lib) {
                  var checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.name = 'library_ids';
                  checkbox.value = lib.key;
                  checkbox.id = 'admin_lib_' + lib.key;
                  checkbox.className = 'library-checkbox';
                  
                  // Check if this library is currently active
                  if (currentLibraryIds.includes(lib.key)) {
                      checkbox.checked = true;
                  }
                  
                  var label = document.createElement('label');
                  label.htmlFor = checkbox.id;
                  label.className = 'library-item';
                  
                  var titleSpan = document.createElement('span');
                  titleSpan.className = 'library-title';
                  titleSpan.innerText = lib.title;
                  
                  var idSpan = document.createElement('span');
                  idSpan.className = 'library-id';
                  idSpan.innerText = '(' + lib.key + ')';
                  
                  label.appendChild(checkbox);
                  label.appendChild(titleSpan);
                  label.appendChild(idSpan);
                  list.appendChild(label);
                  
                  // Add carousel checkbox
                  var carouselLabel = document.createElement('label');
                  carouselLabel.className = 'checkbox-option';
                  carouselLabel.style.display = checkbox.checked ? 'flex' : 'none';
                  
                  var carouselCheckbox = document.createElement('input');
                  carouselCheckbox.type = 'checkbox';
                  carouselCheckbox.name = 'library_carousels';
                  carouselCheckbox.value = lib.key;
                  carouselCheckbox.id = 'admin_carousel_' + lib.key;
                  carouselCheckbox.className = 'checkbox-input';
                  
                  // Check if this library has carousel enabled
                  var currentCarousels = [];
                  {% if LIBRARY_CAROUSELS %}
                      {% set carousel_ids = LIBRARY_CAROUSELS.split(',') %}
                      {% for carousel_id in carousel_ids %}
                          {% if carousel_id.strip() %}
                              currentCarousels.push('{{ carousel_id.strip() }}');
                          {% endif %}
                      {% endfor %}
                  {% endif %}
                  
                  // Default to checked for new libraries, or if already in current carousels
                  if (currentCarousels.includes(lib.key) || currentCarousels.length === 0) {
                      carouselCheckbox.checked = true;
                  }
                     
                  var carouselSpan = document.createElement('span');
                  carouselSpan.textContent = lib.title;
                     
                  carouselLabel.appendChild(carouselCheckbox);
                  carouselLabel.appendChild(carouselSpan);
                  carouselList.appendChild(carouselLabel);
                  
                  // Add change event listener to update libraries immediately
                  checkbox.addEventListener('change', function() {
                      carouselLabel.style.display = checkbox.checked ? 'flex' : 'none';
                      updateLibrariesImmediately();
                      updateCarouselSectionVisibility();
                  });
              });
              updateCarouselSectionVisibility();
          } else {
              section.style.display = 'none';
              carouselSection.style.display = 'none';
              alert('No libraries found or error fetching libraries.');
          }
      }).catch((err) => {
          alert('Failed to fetch libraries.');
          console.error(err);
      });
  }
  
  function updateLibrariesImmediately() {
      var selectedLibraries = [];
      document.querySelectorAll('input[name="library_ids"]:checked').forEach(function(cb) {
          selectedLibraries.push(cb.value);
      });
      
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/ajax/update-libraries', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
              library_ids: selectedLibraries
          })
      }).then(response => response.json()).then(data => {
          if (data.success) {
              // Update the current library display
              updateCurrentLibrariesDisplay(selectedLibraries);
              // Update carousel section visibility
              updateCarouselSectionVisibility();
              // Trigger poster refresh
              triggerPosterRefresh();
          } else {
              console.error('Failed to update libraries:', data.error);
          }
      }).catch(error => {
          console.error('Error updating libraries:', error);
      });
  }
  
  function updateCurrentLibrariesDisplay(selectedLibraries) {
      var currentDisplay = document.querySelector('.current-library-selection');
      if (currentDisplay) {
          if (selectedLibraries.length === 0) {
              currentDisplay.innerHTML = '<h3 class="form-section-title"><span class="form-section-icon">üìö</span>Currently Selected Libraries</h3><div style="color: #888; font-style: italic;">No libraries selected</div>';
          } else {
              // Preserve current description input values before regenerating HTML
              var currentDescriptions = {};
              selectedLibraries.forEach(function(libId) {
                  // Check for visible input first, then hidden input
                  var existingInput = document.querySelector('input[name="library_desc_' + libId + '"]');
                  if (!existingInput) {
                      existingInput = document.querySelector('input[name="library_desc_hidden_' + libId + '"]');
                  }
                  if (existingInput) {
                      currentDescriptions[libId] = existingInput.value;
                  }
              });
              
              // Fetch fresh library notes from the server
              var csrfToken = document.querySelector('input[name="csrf_token"]').value;
              fetch('/ajax/get-library-notes', {
                  method: 'GET',
                  headers: {
                      'X-CSRFToken': csrfToken
                  }
              }).then(response => response.json()).then(data => {
                  if (data.success) {
                      var libraryNotes = data.library_notes;
                      var html = '<h3 class="form-section-title"><span class="form-section-icon">üìö</span>Currently Selected Libraries</h3>';
                      
                      selectedLibraries.forEach(function(libId) {
                          var title = 'Unknown';
                          var description = '';
                          if (libraryNotes[libId] && libraryNotes[libId].title) {
                              title = libraryNotes[libId].title;
                          }
                          // Use current input value if it exists, otherwise use saved description
                          if (currentDescriptions[libId] !== undefined) {
                              description = currentDescriptions[libId];
                          } else if (libraryNotes[libId] && libraryNotes[libId].description) {
                              description = libraryNotes[libId].description;
                          }
                          
                          html += '<div class="selected-library-item" style="margin-bottom: 1em;">';
                          html += '<div class="library-title-section">';
                          html += '<strong>' + title + ' (' + libId + ')</strong>';
                          html += '</div>';
                          html += '<div class="library-description-section" style="margin-top: 0.5em;">';
                          html += '<label class="form-label">Description:</label>';
                                                html += '<input type="text" name="library_desc_' + libId + '" value="' + (description || '') + '" class="form-input library-description-input" placeholder="Enter a description for this library (optional)" onchange="syncLibraryDescription(this, \'' + libId + '\')" oninput="syncLibraryDescription(this, \'' + libId + '\')">';
                      html += '</div>';
                      html += '</div>';
                  });
                  
                  currentDisplay.innerHTML = html;
                  
                  // Update carousel section with new libraries
                  // Extract library titles from libraryNotes
                  var libraryTitles = {};
                  if (libraryNotes) {
                      selectedLibraries.forEach(function(libId) {
                          if (libraryNotes[libId] && libraryNotes[libId].title) {
                              libraryTitles[libId] = libraryNotes[libId].title;
                          }
                      });
                  }
                  updateCarouselSection(selectedLibraries, libraryTitles);
                  
                  // Add event listeners to sync with hidden inputs
                  setTimeout(function() {
                      var inputs = currentDisplay.querySelectorAll('.library-description-input');
                      inputs.forEach(function(input) {
                          input.addEventListener('input', function() {
                              syncLibraryDescription(this, this.name.replace('library_desc_', ''));
                          });
                      });
                  }, 100);
                  } else {
                      console.error('Failed to fetch library notes:', data.error);
                      // Fallback to basic display without titles
                      var html = '<h3 class="form-section-title"><span class="form-section-icon">üìö</span>Currently Selected Libraries</h3>';
                      selectedLibraries.forEach(function(libId) {
                          var description = currentDescriptions[libId] || '';
                          html += '<div class="selected-library-item" style="margin-bottom: 1em;">';
                          html += '<div class="library-title-section">';
                          html += '<strong>Unknown (' + libId + ')</strong>';
                          html += '</div>';
                          html += '<div class="library-description-section" style="margin-top: 0.5em;">';
                          html += '<label class="form-label">Description:</label>';
                          html += '<input type="text" name="library_desc_' + libId + '" value="' + description + '" class="form-input library-description-input" placeholder="Enter a description for this library (optional)" onchange="syncLibraryDescription(this, \'' + libId + '\')">';
                          html += '</div>';
                          html += '</div>';
                      });
                      currentDisplay.innerHTML = html;
                      
                      // Update carousel section with new libraries
                      // No library titles available in this fallback case
                      updateCarouselSection(selectedLibraries, {});
                      
                      // Add event listeners to sync with hidden inputs
                      setTimeout(function() {
                          var inputs = currentDisplay.querySelectorAll('.library-description-input');
                          inputs.forEach(function(input) {
                              input.addEventListener('input', function() {
                                  syncLibraryDescription(this, this.name.replace('library_desc_', ''));
                              });
                          });
                      }, 100);
                  }
              }).catch(error => {
                  console.error('Error fetching library notes:', error);
                  // Fallback to basic display without titles
                  var html = '<h3 class="form-section-title"><span class="form-section-icon">üìö</span>Currently Selected Libraries</h3>';
                  selectedLibraries.forEach(function(libId) {
                      var description = currentDescriptions[libId] || '';
                      html += '<div class="selected-library-item" style="margin-bottom: 1em;">';
                      html += '<div class="library-title-section">';
                      html += '<strong>Unknown (' + libId + ')</strong>';
                      html += '</div>';
                      html += '<div class="library-description-section" style="margin-top: 0.5em;">';
                      html += '<label class="form-label">Description:</label>';
                      html += '<input type="text" name="library_desc_' + libId + '" value="' + description + '" class="form-input library-description-input" placeholder="Enter a description for this library (optional)" onchange="syncLibraryDescription(this, \'' + libId + '\')">';
                      html += '</div>';
                      html += '</div>';
                  });
                  currentDisplay.innerHTML = html;
                  
                  // Update carousel section with new libraries
                  // No library titles available in this error case
                  updateCarouselSection(selectedLibraries, {});
                  
                  // Add event listeners to sync with hidden inputs
                  setTimeout(function() {
                      var inputs = currentDisplay.querySelectorAll('.library-description-input');
                      inputs.forEach(function(input) {
                          input.addEventListener('input', function() {
                              syncLibraryDescription(this, this.name.replace('library_desc_', ''));
                          });
                      });
                  }, 100);
              });
          }
      }
  }
  
  function syncLibraryDescription(input, libId) {
      // Sync the visible input with the hidden input in the form
      var hiddenInput = document.querySelector('input[name="library_desc_hidden_' + libId + '"]');
      if (hiddenInput) {
          hiddenInput.value = input.value;
          console.log('Synced library description for ' + libId + ': "' + input.value + '"');
      } else {
          console.error('Hidden input not found for library ' + libId);
      }
  }
  
  function triggerPosterRefresh() {
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/trigger-poster-downloads', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          }
      }).then(response => response.json()).then(data => {
          if (data.success) {
              console.log('Poster refresh triggered successfully');
          } else {
              console.error('Failed to trigger poster refresh:', data.error);
          }
      }).catch(error => {
          console.error('Error triggering poster refresh:', error);
      });
  }
  
  function updateCarouselSectionVisibility() {
      var carouselSection = document.getElementById('library-carousels-section-admin');
      var carouselCheckboxes = document.querySelectorAll('input[name="library_carousels"]');
      var selectedLibraryItems = document.querySelectorAll('.selected-library-item');
      carouselSection.style.display = (carouselCheckboxes.length > 0 || selectedLibraryItems.length > 0) ? 'block' : 'none';
  }
  
  function updateCarouselSection(selectedLibraries, libraryTitles) {
      var carouselList = document.getElementById('library-carousels-list-admin');
      if (!carouselList) return;
      
      // Clear existing carousel checkboxes
      carouselList.innerHTML = '';
      
      // Get current carousel settings
      var currentCarousels = [];
      {% if LIBRARY_CAROUSELS %}
          {% set carousel_ids = LIBRARY_CAROUSELS.split(',') %}
          {% for carousel_id in carousel_ids %}
              {% if carousel_id.strip() %}
                  currentCarousels.push('{{ carousel_id.strip() }}');
              {% endif %}
          {% endfor %}
      {% endif %}
      
      // Create carousel checkboxes for selected libraries
      selectedLibraries.forEach(function(libId) {
          var carouselLabel = document.createElement('label');
          carouselLabel.className = 'checkbox-option';
          
          var carouselCheckbox = document.createElement('input');
          carouselCheckbox.type = 'checkbox';
          carouselCheckbox.name = 'library_carousels';
          carouselCheckbox.value = libId;
          carouselCheckbox.id = 'admin_carousel_' + libId;
          carouselCheckbox.className = 'checkbox-input';
          
          // Check if this library has carousel enabled
          if (currentCarousels.includes(libId) || currentCarousels.length === 0) {
              carouselCheckbox.checked = true;
          }
          
          var carouselSpan = document.createElement('span');
          // Use the library title if available, otherwise fall back to ID
          var libraryTitle = libraryTitles && libraryTitles[libId] ? libraryTitles[libId] : 'Library ' + libId;
          carouselSpan.textContent = libraryTitle;
          
          carouselLabel.appendChild(carouselCheckbox);
          carouselLabel.appendChild(carouselSpan);
          carouselList.appendChild(carouselLabel);
      });
      
      // Update carousel section visibility
      updateCarouselSectionVisibility();
  }
  
  function refreshLibraryTitles() {
      var csrfToken = document.querySelector('input[name="csrf_token"]').value;
      fetch('/refresh-library-titles', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
          }
      }).then(response => response.json()).then(data => {
          if (data.success) {
              alert('Library titles refreshed successfully!');
              // Reload the page to show updated titles
              window.location.reload();
          } else {
              alert('Failed to refresh library titles: ' + (data.error || 'Unknown error'));
          }
      }).catch(error => {
          console.error('Error refreshing library titles:', error);
          alert('Failed to refresh library titles. Please try again.');
      });
  }

  </script>
  
  <!-- AJAX Functions for Services Page -->
  <script>
    // Delete Plex request
    async function deletePlexRequest(index) {
      if (!confirm('Are you sure you want to delete this Plex request?')) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/delete-plex-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ delete_index: index })
        });
        
        const result = await response.json();
        if (result.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-plex-index="${index}"]`);
          if (row) {
            row.remove();
          }
          
          // Update the invite section by removing the corresponding checkbox
          const inviteCheckbox = document.getElementById(`invite_user_${index}`);
          if (inviteCheckbox) {
            const userSelectionItem = inviteCheckbox.closest('.user-selection-item');
            if (userSelectionItem) {
              userSelectionItem.remove();
            }
          }
          
          // Update all remaining checkboxes to have correct indices
          updatePlexCheckboxIndices();
          
          // Update table row indices
          updatePlexTableIndices();
          
          // If no more submissions, reload the page to show "No Plex requests found"
          const tbody = document.querySelector('table tbody');
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        } else {
          alert('Failed to delete request: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete request. Please try again.');
      }
    }
    
    // Delete Audiobookshelf request
    async function deleteAbsRequest(index) {
      if (!confirm('Are you sure you want to delete this Audiobookshelf request?')) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/delete-abs-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ delete_index: index })
        });
        
        const result = await response.json();
        if (result.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-abs-index="${index}"]`);
          if (row) {
            row.remove();
          }
          
          // Update the invite section by removing the corresponding checkbox
          const inviteCheckbox = document.getElementById(`create_user_${index}`);
          if (inviteCheckbox) {
            const userSelectionItem = inviteCheckbox.closest('.user-selection-item');
            if (userSelectionItem) {
              userSelectionItem.remove();
            }
          }
          
          // Update all remaining checkboxes to have correct indices
          updateAbsCheckboxIndices();
          
          // Update table row indices
          updateAbsTableIndices();
          
          // If no more submissions, reload the page to show "No Audiobookshelf requests found"
          const tbody = document.querySelector('.scrollable-table-container table tbody');
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        } else {
          alert('Failed to delete request: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete request. Please try again.');
      }
    }
    
    // Invite Plex users
    async function invitePlexUsers() {
      const selectedCheckboxes = document.querySelectorAll('.plex-user-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one user to invite.');
        return;
      }
      
      // Get the actual backend indices by mapping from frontend indices to table rows
      const selectedIndices = Array.from(selectedCheckboxes).map(cb => {
        const frontendIndex = parseInt(cb.value);
        const tableRow = document.querySelector(`tr[data-plex-index="${frontendIndex}"]`);
        if (tableRow) {
          // Find the actual index in the table by counting previous rows
          let actualIndex = 0;
          let currentRow = tableRow.previousElementSibling;
          while (currentRow) {
            if (currentRow.hasAttribute('data-plex-index')) {
              actualIndex++;
            }
            currentRow = currentRow.previousElementSibling;
          }
          return actualIndex;
        }
        return frontendIndex;
      });
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Inviting...';
      button.disabled = true;
      
      try {
        const response = await fetch('/ajax/invite-plex-users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ selected_indices: selectedIndices })
        });
        
        const result = await response.json();
        if (result.success) {
          // Show results
          showPlexInviteResults(result.results);
          // Reload page to update the list
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          alert('Failed to invite users: ' + (result.error || 'Unknown error'));
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to invite users. Please try again.');
        button.textContent = originalText;
        button.disabled = false;
      }
    }
    
    // Create Audiobookshelf users
    async function createAbsUsers() {
      const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one user to create.');
        return;
      }
      
      // Get the actual backend indices by mapping from frontend indices to table rows
      const selectedIndices = Array.from(selectedCheckboxes).map(cb => {
        const frontendIndex = parseInt(cb.value);
        const tableRow = document.querySelector(`tr[data-abs-index="${frontendIndex}"]`);
        if (tableRow) {
          // Find the actual index in the table by counting previous rows
          let actualIndex = 0;
          let currentRow = tableRow.previousElementSibling;
          while (currentRow) {
            if (currentRow.hasAttribute('data-abs-index')) {
              actualIndex++;
            }
            currentRow = currentRow.previousElementSibling;
          }
          return actualIndex;
        }
        return frontendIndex;
      });
      
      const userType = document.getElementById('abs_user_type').value;
      const selectedPermissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Creating...';
      button.disabled = true;
      
      try {
        const response = await fetch('/ajax/create-abs-users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            selected_indices: selectedIndices,
            user_type: userType,
            permissions: selectedPermissions
          })
        });
        
        const result = await response.json();
        if (result.success) {
          // Show results
          showAbsCreationResults(result.results);
          // Reload page to update the list
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          alert('Failed to create users: ' + (result.error || 'Unknown error'));
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to create users. Please try again.');
        button.textContent = originalText;
        button.disabled = false;
      }
    }
    
    // Show Plex invite results
    function showPlexInviteResults(results) {
      const form = document.getElementById('plex-user-invite-form');
      const resultsDiv = document.createElement('div');
      resultsDiv.style.marginTop = '2em';
      resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Invitation Results:</h4>';
      
      results.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.style.marginBottom = '1em';
        resultDiv.style.padding = '0.8em';
        resultDiv.style.borderRadius = '0.3em';
        resultDiv.style.borderLeft = '4px solid';
        
        if (result.success) {
          resultDiv.style.background = '#1a3a1a';
          resultDiv.style.borderLeftColor = '#4CAF50';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
            <div style="color: #4CAF50; font-weight: 500;">‚úÖ ${result.message || 'Successfully invited user'}</div>
          `;
        } else {
          resultDiv.style.background = '#3a1a1a';
          resultDiv.style.borderLeftColor = '#f44336';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
            <div style="color: #f44336; font-weight: 500;">‚ùå Failed to invite user: ${result.error}</div>
          `;
        }
        
        resultsDiv.appendChild(resultDiv);
      });
      
      form.appendChild(resultsDiv);
    }
    
    // Show ABS creation results
    function showAbsCreationResults(results) {
      const form = document.getElementById('abs-user-creation-form');
      const resultsDiv = document.createElement('div');
      resultsDiv.style.marginTop = '2em';
      resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Creation Results:</h4>';
      
      results.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.style.marginBottom = '1em';
        resultDiv.style.padding = '0.8em';
        resultDiv.style.borderRadius = '0.3em';
        resultDiv.style.borderLeft = '4px solid';
        
        if (result.success) {
          resultDiv.style.background = '#1a3a1a';
          resultDiv.style.borderLeftColor = '#4CAF50';
          let resultHtml = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
            <div style="color: #4CAF50; font-weight: 500;">‚úÖ Successfully created user</div>
          `;
          if (result.user_id) {
            resultHtml += `<div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">User ID: ${result.user_id}</div>`;
          }
          resultDiv.innerHTML = resultHtml;
        } else {
          resultDiv.style.background = '#3a1a1a';
          resultDiv.style.borderLeftColor = '#f44336';
          resultDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
            <div style="color: #f44336; font-weight: 500;">‚ùå Failed to create user: ${result.error}</div>
          `;
        }
        
        resultsDiv.appendChild(resultDiv);
      });
      
      form.appendChild(resultsDiv);
    }
    
    // Helper function to update Plex checkbox indices after deletion
    function updatePlexCheckboxIndices() {
      const plexCheckboxes = document.querySelectorAll('.plex-user-checkbox');
      plexCheckboxes.forEach((checkbox, newIndex) => {
        checkbox.value = newIndex;
        checkbox.id = `invite_user_${newIndex}`;
        checkbox.name = 'invite_users';
      });
    }
    
    // Helper function to update ABS checkbox indices after deletion
    function updateAbsCheckboxIndices() {
      const absCheckboxes = document.querySelectorAll('.user-checkbox');
      absCheckboxes.forEach((checkbox, newIndex) => {
        checkbox.value = newIndex;
        checkbox.id = `create_user_${newIndex}`;
        checkbox.name = 'create_users';
      });
    }
    
    // Helper function to update Plex table row indices after deletion
    function updatePlexTableIndices() {
      const plexRows = document.querySelectorAll('tr[data-plex-index]');
      plexRows.forEach((row, newIndex) => {
        row.setAttribute('data-plex-index', newIndex);
        // Update the delete button onclick to use the new index
        const deleteButton = row.querySelector('button[onclick^="deletePlexRequest"]');
        if (deleteButton) {
          deleteButton.setAttribute('onclick', `deletePlexRequest(${newIndex})`);
        }
      });
    }
    
    // Helper function to update ABS table row indices after deletion
    function updateAbsTableIndices() {
      const absRows = document.querySelectorAll('tr[data-abs-index]');
      absRows.forEach((row, newIndex) => {
        row.setAttribute('data-abs-index', newIndex);
        // Update the delete button onclick to use the new index
        const deleteButton = row.querySelector('button[onclick^="deleteAbsRequest"]');
        if (deleteButton) {
          deleteButton.setAttribute('onclick', `deleteAbsRequest(${newIndex})`);
        }
      });
    }
    
    // Request services validation - ensure only one of Pulsarr, Overseerr, or Jellyseerr has a URL
    function validateRequestServices() {
      var pulsarrInput = document.querySelector('input[name="PULSARR"]');
      var overseerrInput = document.querySelector('input[name="OVERSEERR"]');
      var jellyseerrInput = document.querySelector('input[name="JELLYSEERR"]');
      
      var pulsarrUrl = pulsarrInput ? pulsarrInput.value.trim() : '';
      var overseerrUrl = overseerrInput ? overseerrInput.value.trim() : '';
      var jellyseerrUrl = jellyseerrInput ? jellyseerrInput.value.trim() : '';
      
      var requestServices = [pulsarrUrl, overseerrUrl, jellyseerrUrl];
      var configuredServices = requestServices.filter(function(url) { return url !== ''; });
      
      var warningDiv = document.getElementById('request-services-warning');
      
      if (configuredServices.length > 1) {
        warningDiv.style.display = 'flex';
        return false;
      } else {
        warningDiv.style.display = 'none';
        return true;
      }
    }
    
    // Add event listeners for request service inputs
    document.addEventListener('DOMContentLoaded', function() {
      var requestServiceInputs = [
        document.querySelector('input[name="PULSARR"]'),
        document.querySelector('input[name="OVERSEERR"]'),
        document.querySelector('input[name="JELLYSEERR"]')
      ];
      
      requestServiceInputs.forEach(function(input) {
        if (input) {
          input.addEventListener('input', validateRequestServices);
          input.addEventListener('change', validateRequestServices);
        }
      });
      
      // Initial validation
      validateRequestServices();
    });
    
    // Quick Access service toggles visibility
    function toggleQAServiceToggles() {
      var qaEnabled = document.querySelector('input[name="quick_access_enabled"]:checked');
      var qaToggles = document.getElementById('qa-service-toggles');
      
      if (qaEnabled && qaEnabled.value === 'yes') {
        qaToggles.style.display = 'block';
      } else {
        qaToggles.style.display = 'none';
      }
    }
    
    // IP Management section visibility
    function toggleIPManagement() {
      var ipEnabled = document.querySelector('input[name="ip_management_enabled"]:checked');
      var ipSection = document.getElementById('ip-management-content');
      
      if (ipEnabled && ipEnabled.value === 'yes') {
        ipSection.style.display = 'block';
      } else {
        ipSection.style.display = 'none';
      }
    }
    
    // Rate Limiting Settings section visibility
    function toggleRateLimitSettings() {
      var rateLimitEnabled = document.querySelector('input[name="rate_limit_settings_enabled"]:checked');
      var rateLimitSection = document.getElementById('rate-limit-settings-content');
      
      if (rateLimitEnabled && rateLimitEnabled.value === 'yes') {
        rateLimitSection.style.display = 'block';
      } else {
        rateLimitSection.style.display = 'none';
      }
    }
    
    // Audiobookshelf Configuration section visibility
    function toggleAbsConfig() {
      var absEnabled = document.querySelector('input[name="abs_config_enabled"]:checked');
      var absSection = document.getElementById('abs-config-section');
      
      if (absEnabled && absEnabled.value === 'yes') {
        absSection.style.display = 'block';
      } else {
        absSection.style.display = 'none';
      }
    }
    
    // Discord Configuration section visibility
    function toggleDiscordConfig() {
      var discordEnabled = document.querySelector('input[name="discord_config_enabled"]:checked');
      var discordSection = document.getElementById('discord-config-section');
      
      if (discordEnabled && discordEnabled.value === 'yes') {
        discordSection.style.display = 'block';
      } else {
        discordSection.style.display = 'none';
      }
    }
    
    // Add IP to whitelist
    async function addToWhitelist() {
      const ipInput = document.getElementById('whitelist_ip');
      const ip = ipInput.value.trim();
      
      if (!ip) {
        alert('Please enter an IP address to whitelist.');
        return;
      }
      
      try {
        const response = await fetch('/ajax/ip-management', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            action: 'whitelist',
            ip_address: ip
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('IP added to whitelist successfully.');
          // Clear the input field
          ipInput.value = '';
          // Refresh the IP lists without reloading the page
          refreshIPLists();
        } else {
          alert('Failed to add IP to whitelist: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to add IP to whitelist. Please try again.');
      }
    }
    
    // Add IP to blacklist
    async function addToBlacklist() {
      const ipInput = document.getElementById('blacklist_ip');
      const ip = ipInput.value.trim();
      
      if (!ip) {
        alert('Please enter an IP address to blacklist.');
        return;
      }
      
      try {
        const response = await fetch('/ajax/ip-management', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            action: 'blacklist',
            ip_address: ip
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('IP added to blacklist successfully.');
          // Clear the input field
          ipInput.value = '';
          // Refresh the IP lists without reloading the page
          refreshIPLists();
        } else {
          alert('Failed to add IP to blacklist: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to add IP to blacklist. Please try again.');
      }
    }
    
    // Remove IP from whitelist
    async function removeFromWhitelist(ip) {
      if (!confirm(`Are you sure you want to remove ${ip} from the whitelist?`)) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/ip-management', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            action: 'remove_whitelist',
            ip_address: ip
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('IP removed from whitelist successfully.');
          // Refresh the IP lists without reloading the page
          refreshIPLists();
        } else {
          alert('Failed to remove IP from whitelist: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to remove IP from whitelist. Please try again.');
      }
    }
    
    // Remove IP from blacklist
    async function removeFromBlacklist(ip) {
      if (!confirm(`Are you sure you want to remove ${ip} from the blacklist?`)) {
        return;
      }
      
      try {
        const response = await fetch('/ajax/ip-management', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            action: 'remove_blacklist',
            ip_address: ip
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('IP removed from blacklist successfully.');
          // Refresh the IP lists without reloading the page
          refreshIPLists();
        } else {
          alert('Failed to remove IP from blacklist: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to remove IP from blacklist. Please try again.');
      }
    }
    
    // Refresh IP lists without reloading the page
    async function refreshIPLists() {
      try {
        const response = await fetch('/ajax/get-ip-lists', {
          method: 'GET',
          headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          }
        });
        
        const result = await response.json();
        if (result.success) {
          // Update whitelisted IPs
          const whitelistSection = document.querySelector('.ip-list-section:first-of-type');
          
          // Remove any existing content (both .ip-list divs and "No whitelisted IPs" paragraphs)
          const existingWhitelistContent = whitelistSection.querySelector('.ip-list, p.muted');
          if (existingWhitelistContent) {
            existingWhitelistContent.remove();
          }
          
          if (result.whitelisted && result.whitelisted.length > 0) {
            const whitelistContainer = document.createElement('div');
            whitelistContainer.className = 'ip-list';
            whitelistContainer.innerHTML = result.whitelisted.map(ip => 
              `<div class="ip-item">
                <span class="ip-address">${ip}</span>
                <button type="button" onclick="removeFromWhitelist('${ip}')" class="btn btn-small btn-danger">Remove</button>
              </div>`
            ).join('');
            whitelistSection.appendChild(whitelistContainer);
          } else {
            const noWhitelistMsg = document.createElement('p');
            noWhitelistMsg.className = 'muted';
            noWhitelistMsg.textContent = 'No whitelisted IPs';
            whitelistSection.appendChild(noWhitelistMsg);
          }
          
          // Update blacklisted IPs
          const blacklistSection = document.querySelector('.ip-list-section:last-of-type');
          
          // Remove any existing content (both .ip-list divs and "No blacklisted IPs" paragraphs)
          const existingBlacklistContent = blacklistSection.querySelector('.ip-list, p.muted');
          if (existingBlacklistContent) {
            existingBlacklistContent.remove();
          }
          
          if (result.banned && result.banned.length > 0) {
            const blacklistContainer = document.createElement('div');
            blacklistContainer.className = 'ip-list';
            blacklistContainer.innerHTML = result.banned.map(ip => 
              `<div class="ip-item">
                <span class="ip-address">${ip}</span>
                <button type="button" onclick="removeFromBlacklist('${ip}')" class="btn btn-small btn-danger">Remove</button>
              </div>`
            ).join('');
            blacklistSection.appendChild(blacklistContainer);
          } else {
            const noBlacklistMsg = document.createElement('p');
            noBlacklistMsg.className = 'muted';
            noBlacklistMsg.textContent = 'No blacklisted IPs';
            blacklistSection.appendChild(noBlacklistMsg);
          }
        }
      } catch (error) {
        console.error('Error refreshing IP lists:', error);
      }
    }
    
    // Function to collect all form data and populate hidden inputs
    function collectFormData() {
      // Authentication
      document.getElementById('site_password_hidden').value = document.getElementById('admin_site_password_box').value;
      document.getElementById('admin_password_hidden').value = document.getElementById('admin_admin_password_box').value;
      
      // Branding
      document.getElementById('server_name_hidden').value = document.getElementById('server_name').value;
      document.getElementById('accent_color_text_hidden').value = document.getElementById('accent_color_text').value;
      
      // Plex
      document.getElementById('plex_token_hidden').value = document.getElementById('plex_token').value;
      document.getElementById('plex_url_hidden').value = document.getElementById('plex_url').value;
      
      // Audiobookshelf
      document.getElementById('audiobooks_id_hidden').value = document.getElementById('audiobooks_id').value;
      document.getElementById('audiobookshelf_url_hidden').value = document.getElementById('audiobookshelf_url_admin').value;
      document.getElementById('audiobookshelf_token_hidden').value = document.getElementById('audiobookshelf_token_admin').value;
      
      // Discord
              document.getElementById('discord_notify_plex_hidden').value = document.getElementById('discord_notify_plex').checked ? '1' : '';
        document.getElementById('discord_notify_abs_hidden').value = document.getElementById('discord_notify_abs').checked ? '1' : '';
        document.getElementById('discord_notify_rate_limiting_hidden').value = document.getElementById('discord_notify_rate_limiting').checked ? '1' : '';
        document.getElementById('discord_notify_ip_management_hidden').value = document.getElementById('discord_notify_ip_management').checked ? '1' : '';
        document.getElementById('discord_notify_login_attempts_hidden').value = document.getElementById('discord_notify_login_attempts').checked ? '1' : '';
        document.getElementById('discord_notify_form_rate_limiting_hidden').value = document.getElementById('discord_notify_form_rate_limiting').checked ? '1' : '';
        document.getElementById('discord_notify_first_access_hidden').value = document.getElementById('discord_notify_first_access').checked ? '1' : '';
      document.getElementById('discord_webhook_hidden').value = document.getElementById('discord_webhook_admin').value;
      document.getElementById('discord_username_hidden').value = document.getElementById('discord_username_admin').value;
      document.getElementById('discord_avatar_hidden').value = document.getElementById('discord_avatar_admin').value;
      document.getElementById('discord_color_hidden').value = document.getElementById('discord_color_admin').value;
      document.getElementById('onboarderr_url_hidden').value = document.getElementById('onboarderr_url_admin').value;
      
      // Quick Access
      var qaEnabled = '';
      var qaRadios = document.getElementsByName('quick_access_enabled');
      for (var i = 0; i < qaRadios.length; i++) {
        if (qaRadios[i].checked) qaEnabled = qaRadios[i].value;
      }
      document.getElementById('quick_access_enabled_hidden').value = qaEnabled;
      document.getElementById('qa_plex_enabled_hidden').value = document.querySelector('input[name="qa_plex_enabled"]').checked ? 'yes' : '';
      document.getElementById('qa_audiobookshelf_enabled_hidden').value = document.querySelector('input[name="qa_audiobookshelf_enabled"]').checked ? 'yes' : '';
      document.getElementById('qa_tautulli_enabled_hidden').value = document.querySelector('input[name="qa_tautulli_enabled"]').checked ? 'yes' : '';
      document.getElementById('qa_overseerr_enabled_hidden').value = document.querySelector('input[name="qa_overseerr_enabled"]').checked ? 'yes' : '';
      document.getElementById('qa_jellyseerr_enabled_hidden').value = document.querySelector('input[name="qa_jellyseerr_enabled"]').checked ? 'yes' : '';
      
      // IP Management
      var ipEnabled = '';
      var ipRadios = document.getElementsByName('ip_management_enabled');
      for (var i = 0; i < ipRadios.length; i++) {
        if (ipRadios[i].checked) ipEnabled = ipRadios[i].value;
      }
      document.getElementById('ip_management_enabled_hidden').value = ipEnabled;
      
      // Rate Limiting Settings
      var rateLimitEnabled = '';
      var rateLimitRadios = document.getElementsByName('rate_limit_settings_enabled');
      for (var i = 0; i < rateLimitRadios.length; i++) {
        if (rateLimitRadios[i].checked) rateLimitEnabled = rateLimitRadios[i].value;
      }
      document.getElementById('rate_limit_settings_enabled_hidden').value = rateLimitEnabled;
      document.getElementById('max_login_attempts_hidden').value = document.getElementById('max_login_attempts').value;
      document.getElementById('max_form_submissions_hidden').value = document.getElementById('max_form_submissions').value;
      
      // Service URLs
      {% for service in all_services %}
        document.getElementById('{{ service.env.lower() }}_hidden').value = document.querySelector('input[name="{{ service.env }}"]').value;
      {% endfor %}
      
      // Library Carousels - collect selected carousel checkboxes
      var selectedCarouselIds = [];
      var carouselCheckboxes = document.querySelectorAll('input[name="library_carousels"]:checked');
      carouselCheckboxes.forEach(function(cb) {
        selectedCarouselIds.push(cb.value);
      });
      
      // Remove any existing library carousel hidden inputs (but not the visible checkboxes)
      var existingCarouselInputs = document.querySelectorAll('input[name="library_carousels"][type="hidden"]');
      existingCarouselInputs.forEach(function(input) {
        if (input.id !== 'library_carousels_hidden') {
          input.remove();
        }
      });
      
      // Create individual hidden inputs for each library carousel
      selectedCarouselIds.forEach(function(libId) {
        var hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'library_carousels';
        hiddenInput.value = libId;
        document.getElementById('admin-settings-form').appendChild(hiddenInput);
      });
      
      // File inputs
      var logoFile = document.getElementById('logo_file');
      var logoFileHidden = document.getElementById('logo_file_hidden');
      if (logoFile && logoFile.files.length > 0) {
        logoFileHidden.files = logoFile.files;
      }
      
      var wordmarkFile = document.getElementById('wordmark_file');
      var wordmarkFileHidden = document.getElementById('wordmark_file_hidden');
      if (wordmarkFile && wordmarkFile.files.length > 0) {
        wordmarkFileHidden.files = wordmarkFile.files;
      }
    }
    
    // Form submission handler for admin settings form
    document.addEventListener('DOMContentLoaded', function() {
      var adminForm = document.getElementById('admin-settings-form');
      if (adminForm) {
        adminForm.addEventListener('submit', function(e) {
          // Collect all form data first
          collectFormData();
          
          // Check request services validation
          if (!validateRequestServices()) {
            e.preventDefault();
            var warningDiv = document.getElementById('request-services-warning');
            if (warningDiv) {
              warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return false;
          }
        });
      }
    });
    
    // Add event listeners for QA radio buttons
    document.addEventListener('DOMContentLoaded', function() {
      var qaRadios = document.querySelectorAll('input[name="quick_access_enabled"]');
      qaRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleQAServiceToggles);
      });
      
      // Add event listeners for IP management radio buttons
      var ipRadios = document.querySelectorAll('input[name="ip_management_enabled"]');
      ipRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleIPManagement);
      });
      
      // Add event listeners for rate limiting settings radio buttons
      var rateLimitRadios = document.querySelectorAll('input[name="rate_limit_settings_enabled"]');
      rateLimitRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleRateLimitSettings);
      });
      
      // Add event listeners for ABS config radio buttons
      var absConfigRadios = document.querySelectorAll('input[name="abs_config_enabled"]');
      absConfigRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleAbsConfig);
      });
      
      // Add event listeners for Discord config radio buttons
      var discordConfigRadios = document.querySelectorAll('input[name="discord_config_enabled"]');
      discordConfigRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleDiscordConfig);
      });
      
      // Initial toggle states
      toggleQAServiceToggles();
      toggleIPManagement();
      toggleRateLimitSettings();
      toggleAbsConfig();
      toggleDiscordConfig();
      
      // Initialize the "Currently Selected Libraries" section on page load
      // The section is now server-side rendered, so we don't need to populate it via JavaScript
      // But we still need to handle the case when libraries are updated via AJAX
      var currentLibraryIds = '{{ LIBRARY_IDS }}';
      if (currentLibraryIds && currentLibraryIds.trim() !== '') {
        var selectedLibraries = currentLibraryIds.split(',').map(function(id) {
          return id.trim();
        }).filter(function(id) {
          return id !== '';
        });
        // Only update if the section is empty (which shouldn't happen now, but just in case)
        var currentDisplay = document.querySelector('.current-library-selection');
        if (currentDisplay && currentDisplay.querySelector('.selected-library-item') === null) {
          updateCurrentLibrariesDisplay(selectedLibraries);
        }
        // Initialize carousel section visibility
        updateCarouselSectionVisibility();
      }
    });
  </script>

</body>
</html>
