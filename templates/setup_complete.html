<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ SERVER_NAME }} - Setup Complete</title>
    <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}">
    <link rel="stylesheet" href="/static/modern-style.css">
    <style>
        :root {
            --accent-color: {{ ACCENT_COLOR or "#d33fbc" }};
        }
    </style>
</head>
<body>
    <div class="complete-container">
        <div class="complete-card">
            <img src="{{ url_for('static', filename=logo_filename) }}" alt="Logo" class="complete-logo">
            <h1 class="complete-title">Changes Saved!</h1>
            <p class="complete-message">
                <strong>The server will restart automatically to apply changes.</strong><br>
            </p>
            <p class="muted">
                If you don't see the login page, please check the logs for errors.
            </p>

            <div class="countdown-container">
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="countdownBar"></div>
                    <span class="countdown-label" id="countdownLabel">Preparing to restart...</span>
                </div>
            </div>

            <a href="/login" id="loginBtn" class="login-btn" style="display: none;">Go to Login</a>
        </div>
    </div>
    
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // Get restart configuration from backend
            const restartDelay = '{{ restart_delay|default("10") }}';
            const isAdaptive = {{ 'true' if is_adaptive else 'false' }};
            const changedSettings = {{ changed_settings|tojson|safe }};
            
            // Check if restart was already triggered from backend
            const urlParams = new URLSearchParams(window.location.search);
            const fromServices = urlParams.get('from_services');
            
            let totalSeconds = 5; // Default to 5 seconds for immediate settings
            let elapsed = 0;
            let bar = document.getElementById('countdownBar');
            let label = document.getElementById('countdownLabel');
            let waiting = false;
            let restartTriggered = false;
            let posterCheckInterval = null;
            let lastPosterStatus = null;

            // Determine initial countdown based on restart type
            if (isAdaptive) {
                totalSeconds = 5; // Start with short delay, will be extended if needed
                label.textContent = 'Checking poster downloads...';
            } else if (restartDelay === '5') {
                totalSeconds = 5;
                label.textContent = 'Applying settings...';
            } else {
                totalSeconds = parseInt(restartDelay) || 5;
                label.textContent = 'Applying settings...';
            }

            // Function to check restart readiness
            function checkRestartReadiness() {
                fetch('/check-restart-readiness', {method: 'GET', cache: 'no-store'})
                    .then(function(response) {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Network response was not ok');
                        }
                    })
                    .then(function(data) {
                        // Handle setup-specific download status first (prioritize unified status)
                        if (data.setup_download_status) {
                            updateSetupDownloadStatus(data.setup_download_status, data.current_phase);
                        }
                        
                        // During setup, always prioritize unified status over individual library progress
                        // Only use individual library progress if no unified status is available at all
                        if (data.poster_status && (!data.setup_download_status || !data.setup_download_status.unified)) {
                            updatePosterStatus(data.poster_status);
                        }
                        
                        // Check if we're ready to restart
                        if (data.ready && !restartTriggered) {
                            // System is ready, trigger restart immediately
                            triggerRestart();
                        } else if (data.should_wait_for_posters && !restartTriggered) {
                            // Still waiting for posters, extend countdown
                            if (isAdaptive) {
                                totalSeconds = Math.max(totalSeconds, elapsed + 10); // Add 10 more seconds
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Error checking restart readiness:', error);
                    });
            }

            // Function to update poster status display
            function updatePosterStatus(posterStatus) {
                if (JSON.stringify(posterStatus) === JSON.stringify(lastPosterStatus)) {
                    return; // Don't update if status hasn't changed
                }
                lastPosterStatus = JSON.parse(JSON.stringify(posterStatus));
                
                if (posterStatus.in_progress) {
                    const progress = posterStatus.progress;
                    const activeLibraries = Object.keys(progress);
                    
                    if (activeLibraries.length > 0) {
                        // Check for ABS downloads first
                        if (progress.abs) {
                            const absProgress = progress.abs;
                            if (absProgress.total > 0) {
                                const percent = Math.round((absProgress.current / absProgress.total) * 100);
                                label.textContent = `${absProgress.library_name}: ${absProgress.current}/${absProgress.total} (${percent}%)`;
                            } else {
                                label.textContent = 'Downloading Audiobookshelf posters...';
                            }
                            return;
                        }
                        
                        // Show detailed progress for active libraries
                        const libraryDetails = activeLibraries.map(libId => {
                            const libProgress = progress[libId];
                            if (libProgress && libProgress.total > 0) {
                                const percent = Math.round((libProgress.current / libProgress.total) * 100);
                                // Try to get library name from progress, fallback to a more user-friendly message
                                const libName = libProgress.library_name || `Downloading posters for library ${libId}`;
                                return `${libName}: ${libProgress.current}/${libProgress.total} (${percent}%)`;
                            }
                            return 'processing';
                        }).join(', ');
                        
                        label.textContent = `Downloading posters: ${libraryDetails}`;
                    } else {
                        label.textContent = 'Downloading posters and info...';
                    }
                } else if (posterStatus.worker_running) {
                    label.textContent = 'Processing poster downloads...';
                } else if (posterStatus.queue_size > 0) {
                    label.textContent = `Queued poster downloads (${posterStatus.queue_size} items)...`;
                } else {
                    label.textContent = 'Preparing to restart...';
                }
            }

            // Function to update setup download status display
            function updateSetupDownloadStatus(setupStatus, currentPhase) {
                if (setupStatus.unified && setupStatus.unified.status === 'error') {
                    label.textContent = `Error: ${setupStatus.unified.message}`;
                    return;
                }
                
                // Handle new smart status states
                if (setupStatus.unified) {
                    const status = setupStatus.unified.status;
                    const message = setupStatus.unified.message;
                    
                    if (status === 'checking') {
                        label.textContent = 'Checking poster downloads...';
                        return;
                    } else if (status === 'no_downloads_needed') {
                        label.textContent = 'No downloads needed';
                        return;
                    } else if (status === 'server_offline') {
                        label.textContent = 'Server offline, skipping...';
                        return;
                    } else if (status === 'completed') {
                        label.textContent = 'All downloads completed!';
                        return;
                    } else if (message) {
                        // Use the message from the backend for other states
                        label.textContent = message;
                        return;
                    }
                }
                
                // Fallback to phase-based messages
                if (currentPhase === 'plex') {
                    label.textContent = 'Downloading Plex posters...';
                } else if (currentPhase === 'plex_completed') {
                    label.textContent = 'Plex downloads completed, waiting for Audiobookshelf...';
                } else if (currentPhase === 'abs') {
                    label.textContent = 'Downloading Audiobookshelf posters...';
                } else if (currentPhase === 'completed') {
                    label.textContent = 'All downloads completed!';
                } else {
                    label.textContent = 'Downloading Audiobookshelf posters...';
                }
            }

            // Function to trigger restart
            function triggerRestart() {
                if (restartTriggered) return;
                restartTriggered = true;
                
                label.textContent = 'Triggering restart...';
                document.getElementById('loginBtn').style.display = 'inline-block';
                
                fetch('/trigger_restart', {method: 'POST'})
                    .then(function() {
                        label.textContent = 'Restart triggered! Checking if login page is online...';
                        checkLoginAndRedirect();
                    })
                    .catch(function(error) {
                        console.error('Error triggering restart:', error);
                        label.textContent = 'Error triggering restart. Please check logs.';
                    });
            }

            // Function to check if login page is online
            function checkLoginAndRedirect() {
                document.getElementById('loginBtn').style.display = 'inline-block';
                label.textContent = 'Checking if login page is online...';
                fetch('/', {method: 'GET', cache: 'no-store'})
                    .then(function(response) {
                        if (response.ok) {
                            label.textContent = 'Login page is online! Redirecting...';
                            setTimeout(function() { window.location.href = '/login'; }, 500);
                        } else {
                            label.textContent = 'Waiting for server to come online...';
                            setTimeout(checkLoginAndRedirect, 1000);
                        }
                    })
                    .catch(function() {
                        label.textContent = 'Waiting for server to come online...';
                        setTimeout(checkLoginAndRedirect, 1000);
                    });
            }

            // Function to update countdown bar
            function updateBar() {
                if (waiting) return;
                elapsed += 0.05;
                var percent = Math.min(100, (elapsed / totalSeconds) * 100);
                bar.style.width = percent + '%';
                
                if (elapsed < totalSeconds) {
                    setTimeout(updateBar, 100);
                } else {
                    waiting = true;
                    // Always check restart readiness for adaptive behavior
                    checkRestartReadiness();
                }
            }

            // Function to start adaptive polling
            function startAdaptivePolling() {
                if (posterCheckInterval) {
                    clearInterval(posterCheckInterval);
                }
                
                posterCheckInterval = setInterval(function() {
                    checkRestartReadiness();
                }, 5000); // Check every 5 seconds to avoid rate limiting
            }

            // Initialize - always use adaptive logic for consistency
            if (window.debugLog) {
                window.debugLog('Starting adaptive restart logic');
            }
            
            // For setup form submissions, trigger poster downloads first
            if (isAdaptive && changedSettings && changedSettings.length > 0) {
                if (window.debugLog) {
                    window.debugLog('Setup detected - triggering poster downloads');
                }
                triggerSetupPosterDownloads();
            }
            
            // Start adaptive polling immediately
            startAdaptivePolling();
            
            // Start countdown but be ready to adjust
            updateBar();
            
            // Check readiness immediately
            setTimeout(function() {
                checkRestartReadiness();
            }, 1000);
            
            // Function to trigger setup poster downloads
            function triggerSetupPosterDownloads() {
                if (window.debugLog) {
                    window.debugLog('Triggering setup poster downloads...');
                }
                label.textContent = 'Starting poster downloads...';
                
                fetch('/ajax/setup-poster-downloads', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        changed_settings: changedSettings
                    })
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Network response was not ok');
                    }
                })
                .then(function(data) {
                    if (window.debugLog) {
                        window.debugLog('Setup poster downloads response:', data);
                    }
                    if (data.success) {
                        label.textContent = 'Poster downloads initiated successfully';
                        if (window.debugLog) {
                            window.debugLog(`Downloads initiated - Plex: ${data.needs_plex}, ABS: ${data.needs_abs}, Libraries: ${data.libraries_count}`);
                        }
                    } else {
                        label.textContent = 'Error initiating poster downloads';
                        if (window.debugError) {
                            window.debugError('Setup poster downloads error:', data.error);
                        }
                    }
                })
                .catch(function(error) {
                    if (window.debugError) {
                        window.debugError('Error triggering setup poster downloads:', error);
                    }
                    label.textContent = 'Error starting poster downloads';
                });
            }
        });
    </script>
    
    <!-- Debug Utilities -->
    <script src="{{ url_for('static', filename='debug-utils.js') }}"></script>
    <script>
      // Initialize debug state from server
      window.DEBUG_ENABLED = {{ JS_DEBUG|lower }};
    </script>
</body>
</html> 