<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ SERVER_NAME }} - Setup Complete</title>
    <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}">
    <link rel="stylesheet" href="/static/modern-style.css">
    <style>
        :root {
            --accent-color: {{ ACCENT_COLOR or "#d33fbc" }};
        }
    </style>
</head>
<body>
    <div class="complete-container">
        <div class="complete-card">
            <img src="{{ url_for('static', filename=logo_filename) }}" alt="Logo" class="complete-logo">
            <h1 class="complete-title">Changes Saved!</h1>
            <p class="complete-message">
                <strong>The server will restart automatically to apply changes.</strong><br>
            </p>
            <p class="muted">
                If you don't see the login page, please check the logs for errors.
            </p>

            <div class="countdown-container">
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="countdownBar"></div>
                    <span class="countdown-label" id="countdownLabel">Preparing to restart...</span>
                </div>
            </div>

            <a href="/login" id="loginBtn" class="login-btn" style="display: none;">Go to Login</a>
        </div>
    </div>
    
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // Get restart configuration from backend
            const restartDelay = '{{ restart_delay|default('10') }}';
            const isAdaptive = {% if is_adaptive %}true{% else %}false{% endif %};
            const changedSettings = {{ changed_settings|tojson|safe }};
            
            // Check if restart was already triggered from backend
            const urlParams = new URLSearchParams(window.location.search);
            const fromServices = urlParams.get('from_services');
            
            let totalSeconds = 5; // Default to 5 seconds for immediate settings
            let elapsed = 0;
            let bar = document.getElementById('countdownBar');
            let label = document.getElementById('countdownLabel');
            let waiting = false;
            let restartTriggered = false;
            let posterCheckInterval = null;
            let lastPosterStatus = null;

            // Determine initial countdown based on restart type
            if (isAdaptive) {
                totalSeconds = 5; // Start with short delay, will be extended if needed
                label.textContent = 'Checking poster downloads...';
            } else if (restartDelay === '5') {
                totalSeconds = 5;
                label.textContent = 'Applying settings...';
            } else {
                totalSeconds = parseInt(restartDelay) || 5;
                label.textContent = 'Applying settings...';
            }

            // Function to check restart readiness
            function checkRestartReadiness() {
                fetch('/check-restart-readiness', {method: 'GET', cache: 'no-store'})
                    .then(function(response) {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Network response was not ok');
                        }
                    })
                    .then(function(data) {
                        // Update poster status display
                        if (data.poster_status) {
                            updatePosterStatus(data.poster_status);
                        }
                        
                        // Handle setup-specific download status
                        if (data.setup_download_status) {
                            updateSetupDownloadStatus(data.setup_download_status, data.current_phase);
                        }
                        
                        // Check if we're ready to restart
                        if (data.ready && !restartTriggered) {
                            // System is ready, trigger restart immediately
                            // But for services form submissions, restart is already triggered from backend
                            if (fromServices === 'true') {
                                // For services, just redirect to login since restart is already triggered
                                label.textContent = 'Restart triggered! Checking if login page is online...';
                                checkLoginAndRedirect();
                            } else {
                                // For other cases, trigger restart
                                triggerRestart();
                            }
                        } else if (data.should_wait_for_posters && !restartTriggered) {
                            // Still waiting for posters, extend countdown
                            if (isAdaptive) {
                                totalSeconds = Math.max(totalSeconds, elapsed + 10); // Add 10 more seconds
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Error checking restart readiness:', error);
                    });
            }

            // Function to update poster status display
            function updatePosterStatus(posterStatus) {
                if (JSON.stringify(posterStatus) === JSON.stringify(lastPosterStatus)) {
                    return; // Don't update if status hasn't changed
                }
                lastPosterStatus = JSON.parse(JSON.stringify(posterStatus));
                
                if (posterStatus.in_progress) {
                    const progress = posterStatus.progress;
                    const activeLibraries = Object.keys(progress);
                    
                    if (activeLibraries.length > 0) {
                        // Check for ABS downloads first
                        if (progress.abs) {
                            const absProgress = progress.abs;
                            if (absProgress.total > 0) {
                                const percent = Math.round((absProgress.current / absProgress.total) * 100);
                                label.textContent = `${absProgress.library_name}: ${absProgress.current}/${absProgress.total} (${percent}%)`;
                            } else {
                                label.textContent = 'Downloading Audiobookshelf posters...';
                            }
                            return;
                        }
                        
                        // Show detailed progress for active libraries
                        const libraryDetails = activeLibraries.map(libId => {
                            const libProgress = progress[libId];
                            if (libProgress && libProgress.total > 0) {
                                const percent = Math.round((libProgress.current / libProgress.total) * 100);
                                const libName = libProgress.library_name || `Library ${libId}`;
                                return `${libName}: ${libProgress.current}/${libProgress.total} (${percent}%)`;
                            }
                            return 'processing';
                        }).join(', ');
                        
                        label.textContent = `Downloading posters: ${libraryDetails}`;
                    } else {
                        label.textContent = 'Downloading posters and info...';
                    }
                } else if (posterStatus.worker_running) {
                    label.textContent = 'Processing poster downloads...';
                } else if (posterStatus.queue_size > 0) {
                    label.textContent = `Queued poster downloads (${posterStatus.queue_size} items)...`;
                } else {
                    label.textContent = 'Preparing to restart...';
                }
            }

            // Function to update setup download status display
            function updateSetupDownloadStatus(setupStatus, currentPhase) {
                if (setupStatus.error) {
                    label.textContent = `Error: ${setupStatus.error.message}`;
                    return;
                }
                
                if (currentPhase === 'plex' && setupStatus.plex) {
                    const plexStatus = setupStatus.plex;
                    if (plexStatus.status === 'starting') {
                        label.textContent = plexStatus.message || 'Starting Plex poster downloads...';
                    } else if (plexStatus.status === 'waiting_for_completion') {
                        label.textContent = plexStatus.message || 'Waiting for Plex downloads to complete...';
                    } else if (plexStatus.status === 'in_progress') {
                        if (plexStatus.total > 0) {
                            const percent = Math.round((plexStatus.current / plexStatus.total) * 100);
                            label.textContent = `Plex: ${plexStatus.current}/${plexStatus.total} (${percent}%)`;
                        } else {
                            label.textContent = 'Downloading Plex posters...';
                        }
                    } else if (plexStatus.status === 'completed') {
                        label.textContent = 'Plex downloads completed, preparing for next phase...';
                    } else if (plexStatus.status === 'timeout') {
                        label.textContent = 'Plex downloads timed out, proceeding...';
                    }
                } else if (currentPhase === 'abs' && setupStatus.abs) {
                    const absStatus = setupStatus.abs;
                    if (absStatus.status === 'starting') {
                        label.textContent = absStatus.message || 'Starting Audiobookshelf poster downloads...';
                    } else if (absStatus.status === 'in_progress') {
                        if (absStatus.total > 0) {
                            const percent = Math.round((absStatus.current / absStatus.total) * 100);
                            label.textContent = `Audiobookshelf: ${absStatus.current}/${absStatus.total} (${percent}%)`;
                        } else {
                            label.textContent = 'Downloading Audiobookshelf posters...';
                        }
                    } else if (absStatus.status === 'completed') {
                        label.textContent = 'Audiobookshelf downloads completed!';
                    } else if (absStatus.status === 'failed') {
                        label.textContent = `Audiobookshelf download failed: ${absStatus.message}`;
                    }
                } else {
                    // Fallback to generic status
                    if (setupStatus.plex && setupStatus.plex.status === 'completed') {
                        if (setupStatus.abs) {
                            label.textContent = 'Plex completed, processing Audiobookshelf...';
                        } else {
                            label.textContent = 'Plex downloads completed!';
                        }
                    } else {
                        label.textContent = 'Downloading posters...';
                    }
                }
            }

            // Function to trigger restart
            function triggerRestart() {
                if (restartTriggered) return;
                restartTriggered = true;
                
                label.textContent = 'Triggering restart...';
                document.getElementById('loginBtn').style.display = 'inline-block';
                
                fetch('/trigger_restart', {method: 'POST'})
                    .then(function() {
                        label.textContent = 'Restart triggered! Checking if login page is online...';
                        checkLoginAndRedirect();
                    })
                    .catch(function(error) {
                        console.error('Error triggering restart:', error);
                        label.textContent = 'Error triggering restart. Please check logs.';
                    });
            }

            // Function to check if login page is online
            function checkLoginAndRedirect() {
                document.getElementById('loginBtn').style.display = 'inline-block';
                label.textContent = 'Checking if login page is online...';
                fetch('/', {method: 'GET', cache: 'no-store'})
                    .then(function(response) {
                        if (response.ok) {
                            label.textContent = 'Login page is online! Redirecting...';
                            setTimeout(function() { window.location.href = '/login'; }, 500);
                        } else {
                            label.textContent = 'Waiting for server to come online...';
                            setTimeout(checkLoginAndRedirect, 1000);
                        }
                    })
                    .catch(function() {
                        label.textContent = 'Waiting for server to come online...';
                        setTimeout(checkLoginAndRedirect, 1000);
                    });
            }

            // Function to update countdown bar
            function updateBar() {
                if (waiting) return;
                elapsed += 0.1;
                var percent = Math.min(100, (elapsed / totalSeconds) * 100);
                bar.style.width = percent + '%';
                
                if (elapsed < totalSeconds) {
                    setTimeout(updateBar, 100);
                } else {
                    waiting = true;
                    if (isAdaptive) {
                        // For adaptive restarts, check if we're ready
                        checkRestartReadiness();
                    } else if (fromServices === 'true') {
                        // For services form submissions, restart is already triggered from backend
                        // Just check if we're ready to redirect
                        checkRestartReadiness();
                    } else {
                        // For standard restarts, trigger immediately
                        triggerRestart();
                    }
                }
            }

            // Function to start adaptive polling
            function startAdaptivePolling() {
                if (posterCheckInterval) {
                    clearInterval(posterCheckInterval);
                }
                
                posterCheckInterval = setInterval(function() {
                    checkRestartReadiness();
                }, 2000); // Check every 2 seconds
            }

            // Initialize based on restart type
            if (isAdaptive) {
                // For adaptive restarts, start polling immediately
                startAdaptivePolling();
                
                // Start countdown but be ready to adjust
                updateBar();
                
                // Check readiness immediately
                setTimeout(function() {
                    checkRestartReadiness();
                }, 1000);
            } else {
                // For standard restarts, only trigger restart if not from services
                if (!fromServices) {
                    setTimeout(function() {
                        fetch('/trigger_restart', {method: 'POST'});
                    }, 1000);
                }
                
                // Start countdown
                updateBar();
            }
            
            // For setup form submissions, always use adaptive logic regardless of isAdaptive flag
            if (fromServices === null && urlParams.get('from_setup') === 'true') {
                console.log('Setup form detected, forcing adaptive restart logic');
                // Start adaptive polling for setup forms
                startAdaptivePolling();
                
                // Override the countdown to be adaptive
                setTimeout(function() {
                    checkRestartReadiness();
                }, 1000);
            }
            
            // For services form submissions, the restart is already triggered from the backend
            // so we just need to monitor progress and redirect when ready
            if (fromServices === 'true') {
                console.log('Services form detected, monitoring poster downloads and waiting for restart...');
                // Start adaptive polling for services forms
                startAdaptivePolling();
                
                // Start countdown but don't trigger restart (it's already triggered from backend)
                updateBar();
                
                // Check readiness immediately
                setTimeout(function() {
                    checkRestartReadiness();
                }, 1000);
            }
        });
    </script>
</body>
</html> 