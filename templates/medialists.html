<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} - Media Lists</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/modern-style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>

</head>
<body>
  {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% if services and QUICK_ACCESS_ENABLED == 'yes' %}
    <div class="quick-access-panel">
      <div class="quick-access-title">Quick Access</div>
      <div class="quick-access-grid">
        {% for service in services %}
          <div class="quick-access-item">
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" class="service-link">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="quick-access-icon">
            </a>
            <div class="quick-access-label">
              {% if service.name == "Plex" %}
                Media
              {% elif service.name == "Audiobookshelf" %}
                Books
              {% elif service.name == "Tautulli" %}
                Stats
              {% elif service.name == "Overseerr" %}
                Request
              {% else %}
                {{ service.name }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="onboarding-content medialists-page">
    <div class="onboarding-section">
      <h1 class="onboarding-title" style="color: white !important; -webkit-text-fill-color: white !important; background: none !important;">Media Lists</h1>
      
      <!-- Hidden CSRF token field -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <div class="form-group">
        <label for="list-select" class="form-label">Select Library:</label>
        <select id="list-select" class="form-input" style="max-width: 350px;">
          {% for lib_name in library_media.keys() %}
            <option value="plex-{{ loop.index0 }}" {% if selected_service == 'plex' and selected_library == lib_name %}selected{% endif %}>Plex - {{ lib_name }}</option>
          {% endfor %}
          {% if abs_book_groups %}
            <option value="abs" {% if selected_service == 'abs' %}selected{% endif %}>Audiobookshelf</option>
          {% endif %}
        </select>
      </div>
      
      {% for lib_name, media_groups in library_media.items() %}
      {% set library_index = loop.index0 %}
      <div class="medialist-section" id="plex-{{ library_index }}" style="display:none;">
        <div style="display: flex; align-items: center; gap: 1em; margin-bottom: 1rem;">
          <img src="/static/plex.webp" alt="Plex Logo" style="height: 32px; display: block;" />
          <span class="service-libraries-label">Plex - {{ lib_name }}</span>
        </div>
        
        <!-- Letter Navigation -->
        <div class="letter-navigation" data-library-index="{{ library_index }}">
          {% set all_letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'|list + ['0-9', 'Other'] %}
          {% for letter in all_letters %}
            {% set titles = media_groups.get(letter, []) %}
            {% if titles %}
              <button class="letter-button" data-letter="{{ letter }}" data-library-index="{{ library_index }}">
                {{ letter }}
              </button>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Initial Message -->
        <div class="initial-message" id="initial-message-{{ library_index }}">
          Choose a letter to get started
        </div>
        
        <!-- Posters Container -->
        <div class="posters-container" id="posters-container-{{ library_index }}" style="display:none;">
          <!-- Posters will be loaded here -->
        </div>
      </div>
      {% endfor %}
      
      {% if abs_book_groups %}
      <!-- Hidden ABS data for JavaScript -->
      <script>
        window.absBookGroups = {{ abs_book_groups|tojson }};
      </script>
      
      <div class="medialist-section" id="abs" style="display:none;">
        <div style="display: flex; align-items: center; gap: 1em; margin-bottom: 1rem;">
          <img src="/static/abs.webp" alt="ABS Logo" style="height: 32px; display: block;" />
          <span class="service-libraries-label">Audiobookshelf</span>
        </div>
        
        <!-- Letter Navigation for ABS -->
        <div class="letter-navigation" data-library-index="abs">
          {% set all_letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'|list + ['0-9', 'Other'] %}
          {% for letter in all_letters %}
            {% set books = abs_book_groups.get(letter, []) %}
            {% if books %}
              <button class="letter-button" data-letter="{{ letter }}" data-library-index="abs">
                {{ letter }}
              </button>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Initial Message for ABS -->
        <div class="initial-message" id="initial-message-abs">
          Choose a letter to get started
        </div>
        
        <!-- Posters Container for ABS -->
        <div class="posters-container" id="posters-container-abs" style="display:none;">
          <!-- Books will be loaded here -->
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const select = document.getElementById("list-select");
      const sections = document.querySelectorAll(".medialist-section");
      const loadedLetters = new Map(); // Track which letters have been loaded per library
      
      function showSection(id) {
        sections.forEach(sec => sec.style.display = "none");
        const el = document.getElementById(id);
        if (el) el.style.display = "block";
        
        // Reset active states when switching sections
        document.querySelectorAll('.letter-button.active').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show initial message and hide posters container
        const libraryIndex = id === 'abs' ? 'abs' : id.replace('plex-', '');
        const initialMessage = document.getElementById(`initial-message-${libraryIndex}`);
        const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
        
        if (initialMessage) initialMessage.style.display = 'block';
        if (postersContainer) postersContainer.style.display = 'none';
      }
      
      function loadPostersForLetter(libraryIndex, letter) {
        const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
        const initialMessage = document.getElementById(`initial-message-${libraryIndex}`);
        
        if (!postersContainer) return;
        
        // Always load content, even if previously loaded
        const libraryKey = `${libraryIndex}-${letter}`;
        
        // Show loading indicator
        postersContainer.innerHTML = '<div style="color:#666; text-align:center; padding:1em;">Loading posters...</div>';
        postersContainer.style.display = 'block';
        if (initialMessage) initialMessage.style.display = 'none';
        
        // For ABS section, load content directly
        if (libraryIndex === 'abs') {
          const books = window.absBookGroups || {};
          const letterBooks = books[letter] || [];
          
          let html = '<ul>';
          for (const book of letterBooks) {
            html += '<li>';
            html += `<img src="${book.cover || '{{ url_for("static", filename=logo_filename) }}'}" alt="${book.title} cover" onerror="this.onerror=null;this.src='{{ url_for("static", filename=logo_filename) }}';" />`;
            html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${book.title}</div>`;
            if (book.author) {
              html += `<div style="font-size: 0.9em; color: #aaa; margin-bottom: 0.25rem;">by ${book.author}</div>`;
            }
            html += `<a href="https://www.goodreads.com/search?q=${encodeURIComponent(book.title + ' ' + (book.author || ''))}" target="_blank" class="accent">Goodreads</a>`;
            html += '</li>';
          }
          html += '</ul>';
          
          if (letterBooks.length === 0) {
            html = '<div style="color:#666; text-align:center; padding:1em;">No books found for this letter</div>';
          }
          
          postersContainer.innerHTML = html;
          loadedLetters.set(libraryKey, true);
          return;
        }
        
        // Load posters via AJAX for Plex
        fetch('/ajax/load-posters-by-letter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            library_index: libraryIndex,
            letter: letter
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Build HTML for items with posters in grid layout
            let html = '<ul>';
            
            for (const item of data.items) {
              html += '<li>';
              if (item.poster) {
                html += `<img src="${item.poster}" alt="${item.title} poster" />`;
              }
              html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${item.title}</div>`;
              
              // Add external links
              const links = [];
              if (item.imdb) {
                links.push(`<a href="https://www.imdb.com/title/${item.imdb}" target="_blank" class="accent">IMDB</a>`);
              }
              if (item.lastfm_url && item.is_artist === true && !item.imdb) {
                links.push(`<a href="${item.lastfm_url}" target="_blank" class="accent">Last.fm</a>`);
              }
              
              if (links.length > 0) {
                html += links.join(' | ');
              }
              
              html += '</li>';
            }
            
            html += '</ul>';
            
            if (data.items.length === 0) {
              html = '<div style="color:#666; text-align:center; padding:1em;">No items found for this letter</div>';
            }
            
            postersContainer.innerHTML = html;
            loadedLetters.set(libraryKey, true);
          } else {
            postersContainer.innerHTML = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading posters</div>';
          }
        })
        .catch(error => {
          console.error('Error loading posters:', error);
          postersContainer.innerHTML = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading posters</div>';
        });
      }
      
      // Handle letter button clicks
      document.addEventListener('click', function(e) {
        if (e.target.matches('.letter-button')) {
          const letter = e.target.dataset.letter;
          const libraryIndex = e.target.dataset.libraryIndex;
          
          // Remove active class from all buttons in this navigation
          const navigation = e.target.closest('.letter-navigation');
          navigation.querySelectorAll('.letter-button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Add active class to clicked button
          e.target.classList.add('active');
          
          // Load posters for this letter
          loadPostersForLetter(libraryIndex, letter);
        }
      });
      
      // Show the pre-selected section or first section by default
      if (select.options.length > 0) {
        const selectedOption = select.querySelector('option[selected]');
        if (selectedOption) {
          showSection(selectedOption.value);
          select.value = selectedOption.value;
        } else {
          showSection(select.options[0].value);
          select.value = select.options[0].value;
        }
      }
      
      select.addEventListener("change", function () {
        const selectedValue = this.value;
        showSection(selectedValue);
      });
    });
  </script>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>

</body>
</html>
