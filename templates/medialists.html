<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} - Media Lists</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/modern-style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>

</head>
<body>
  {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% include "_quick_access_panel.html" %}

  <div class="onboarding-content medialists-page">
    <div class="onboarding-section">
      
      <!-- Hidden CSRF token field -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <div class="form-group">
        <label for="list-select" class="form-label">Select Library:</label>
        <select id="list-select" class="form-input" style="max-width: 350px;">
          {% for lib_name in library_media.keys() %}
            <option value="plex-{{ loop.index0 }}" {% if selected_service == 'plex' and selected_library == lib_name %}selected{% endif %}>{{ lib_name }}</option>
          {% endfor %}
          {% if abs_book_groups %}
            <option value="abs" {% if selected_service == 'abs' %}selected{% endif %}>Audiobooks</option>
          {% endif %}
        </select>
      </div>
      
      {% for lib_name, media_groups in library_media.items() %}
      {% set library_index = loop.index0 %}
      {% set library_count = library_counts.get(lib_name, 0) %}
      <div class="medialist-section" id="plex-{{ library_index }}" style="display:none;">
        <div style="display: flex; align-items: center; gap: 1em;">
          <img src="/static/plex.webp" alt="Plex Logo" style="height: 32px; display: block;" />
          <span class="service-libraries-label">{{ lib_name }}</span>
        </div>
        
        {% if library_count >= 75 %}
        <!-- Letter Navigation -->
        <div class="letter-navigation" data-library-index="{{ library_index }}">
          {% set all_letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'|list + ['0-9', 'Other'] %}
          {% for letter in all_letters %}
            {% set titles = media_groups.get(letter, []) %}
            {% if titles %}
              <button class="letter-button" data-letter="{{ letter }}" data-library-index="{{ library_index }}">
                {{ letter }}
              </button>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Initial Message -->
        <div class="initial-message" id="initial-message-{{ library_index }}">
          Choose a letter to get started
        </div>
        
        <!-- Posters Container -->
        <div class="posters-container" id="posters-container-{{ library_index }}" style="display:none;">
          <!-- Posters will be loaded here -->
        </div>
        {% else %}
        <!-- All Items Container for Small Libraries -->
        <div class="posters-container" id="posters-container-{{ library_index }}" style="display:block;" data-small-library="true">
          <!-- All items will be loaded here -->
        </div>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if abs_book_groups %}
      <!-- Hidden ABS data for JavaScript -->
      <script>
        window.absBookGroups = {{ abs_book_groups|tojson }};
        window.absBookCount = {{ abs_book_count }};
      </script>
      
      <div class="medialist-section" id="abs" style="display:none;">
        <div style="display: flex; align-items: center; gap: 1em;">
          <img src="/static/abs.webp" alt="ABS Logo" style="height: 32px; display: block;" />
          <span class="service-libraries-label">Audiobooks</span>
        </div>
        
        {% if abs_book_count >= 75 %}
        <!-- Letter Navigation for ABS -->
        <div class="letter-navigation" data-library-index="abs">
          {% set all_letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'|list + ['0-9', 'Other'] %}
          {% for letter in all_letters %}
            {% set books = abs_book_groups.get(letter, []) %}
            {% if books %}
              <button class="letter-button" data-letter="{{ letter }}" data-library-index="abs">
                {{ letter }}
              </button>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Initial Message for ABS -->
        <div class="initial-message" id="initial-message-abs">
          Choose a letter to get started
        </div>
        
        <!-- Posters Container for ABS -->
        <div class="posters-container" id="posters-container-abs" style="display:none;">
          <!-- Books will be loaded here -->
        </div>
        {% else %}
        <!-- All Books Container for Small ABS Libraries -->
        <div class="posters-container" id="posters-container-abs" style="display:block;" data-small-library="true">
          <!-- All books will be loaded here -->
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const select = document.getElementById("list-select");
      const sections = document.querySelectorAll(".medialist-section");
      const loadedLetters = new Map(); // Track which letters have been loaded per library
      const loadedContent = new Map(); // Store the actual content for each letter
      
      // URL state management functions
      function updateURL(service, library, letter = null) {
        const url = new URL(window.location);
        url.searchParams.set('service', service);
        if (library) {
          url.searchParams.set('library', library);
        }
        if (letter) {
          url.searchParams.set('letter', letter);
        } else {
          url.searchParams.delete('letter');
        }
        window.history.replaceState({}, '', url);
      }
      
      function getURLParams() {
        const url = new URL(window.location);
        return {
          service: url.searchParams.get('service') || 'plex',
          library: url.searchParams.get('library'),
          letter: url.searchParams.get('letter')
        };
      }
      
      function getLibraryNameFromIndex(libraryIndex) {
        if (libraryIndex === 'abs') {
          return 'Audiobooks';
        }
        // For Plex libraries, we need to get the name from the select options
        const option = select.querySelector(`option[value="${libraryIndex}"]`);
        return option ? option.textContent : null;
      }
      
      function getLibraryIndexFromName(libraryName) {
        if (libraryName === 'Audiobooks') {
          return 'abs';
        }
        // For Plex libraries, find the option with matching text
        for (const option of select.options) {
          if (option.textContent === libraryName) {
            return option.value;
          }
        }
        return null;
      }
      
      function showSection(id) {
        sections.forEach(sec => sec.style.display = "none");
        const el = document.getElementById(id);
        if (el) el.style.display = "block";
        
        // Reset active states when switching sections
        document.querySelectorAll('.letter-button.active').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show initial message and hide posters container
        const libraryIndex = id === 'abs' ? 'abs' : id.replace('plex-', '');
        const initialMessage = document.getElementById(`initial-message-${libraryIndex}`);
        const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
        
        if (initialMessage) initialMessage.style.display = 'block';
        if (postersContainer) postersContainer.style.display = 'none';
        
        // Update URL with current library
        const libraryName = getLibraryNameFromIndex(id);
        const service = id === 'abs' ? 'abs' : 'plex';
        updateURL(service, libraryName);
        
        // Auto-load all items for small libraries (less than 75 items)
        if (id === 'abs') {
          const absCount = window.absBookCount || 0;
          if (absCount < 75) {
            loadAllAbsBooks();
          }
        } else {
          // For Plex libraries, check if this is a small library
          const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
          if (postersContainer && postersContainer.hasAttribute('data-small-library')) {
            loadAllItemsForLibrary(libraryIndex);
          }
        }
      }
      
      function loadAllAbsBooks() {
        const postersContainer = document.getElementById('posters-container-abs');
        if (!postersContainer) return;
        
        const books = window.absBookGroups || {};
        let allBooks = [];
        
        // Collect all books from all letters
        for (const letter in books) {
          allBooks = allBooks.concat(books[letter] || []);
        }
        
        // Sort all books alphabetically by title
        allBooks.sort((a, b) => a.title.localeCompare(b.title));
        
        let html = '<ul>';
        for (const book of allBooks) {
          html += '<li>';
          const goodreadsUrl = `https://www.goodreads.com/search?q=${encodeURIComponent((book.author || '') + ' ' + book.title)}`;
          html += `<a href="${goodreadsUrl}" target="_blank" style="display: block;">`;
          html += `<img src="${book.cover || '{{ url_for("static", filename=logo_filename) }}'}" alt="${book.title} cover" style="cursor: pointer;" onerror="this.onerror=null;this.src='{{ url_for("static", filename=logo_filename) }}';" />`;
          html += '</a>';
          if (book.author) {
            html += `<div style="font-size: 0.9em; color: #aaa; margin-bottom: 0.25rem;">${book.author}</div>`;
          }
          html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${book.title}</div>`;
          html += `<a href="${goodreadsUrl}" target="_blank" class="accent">Goodreads</a>`;
          html += '</li>';
        }
        html += '</ul>';
        
        if (allBooks.length === 0) {
          html = '<div style="color:#666; text-align:center; padding:1em;">No books found</div>';
        }
        
        postersContainer.innerHTML = html;
        postersContainer.style.display = 'block';
      }
      
      function loadAllItemsForLibrary(libraryIndex) {
        const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
        if (!postersContainer) return;
        
        // Show loading indicator
        postersContainer.innerHTML = '<div style="color:#666; text-align:center; padding:1em;">Loading all items...</div>';
        postersContainer.style.display = 'block';
        
        // Load all items via AJAX
        fetch('/ajax/load-all-items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            library_index: libraryIndex
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Build HTML for items with posters in grid layout
            let html = '<ul>';
            
            for (const item of data.items) {
              html += '<li>';
              
              // Determine the primary link for the poster
              let posterLink = null;
              if (item.imdb) {
                posterLink = `https://www.imdb.com/title/${item.imdb}`;
              } else if (item.lastfm_url && item.is_artist === true) {
                posterLink = item.lastfm_url;
              }
              
              if (item.poster) {
                if (posterLink) {
                  html += `<a href="${posterLink}" target="_blank" style="display: block;">`;
                  html += `<img src="${item.poster}" alt="${item.title} poster" style="cursor: pointer;" />`;
                  html += '</a>';
                } else {
                  html += `<img src="${item.poster}" alt="${item.title} poster" />`;
                }
              }
              html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${item.title}</div>`;
              
              // Add external links (keep the text links for accessibility)
              const links = [];
              if (item.imdb) {
                links.push(`<a href="https://www.imdb.com/title/${item.imdb}" target="_blank" class="accent">IMDB</a>`);
              }
              if (item.lastfm_url && item.is_artist === true && !item.imdb) {
                links.push(`<a href="${item.lastfm_url}" target="_blank" class="accent">Last.fm</a>`);
              }
              
              if (links.length > 0) {
                html += links.join(' | ');
              }
              
              html += '</li>';
            }
            
            html += '</ul>';
            
            if (data.items.length === 0) {
              html = '<div style="color:#666; text-align:center; padding:1em;">No items found</div>';
            }
            
            postersContainer.innerHTML = html;
          } else {
            const errorHtml = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading items</div>';
            postersContainer.innerHTML = errorHtml;
          }
        })
        .catch(error => {
          console.error('Error loading all items:', error);
          const errorHtml = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading items</div>';
          postersContainer.innerHTML = errorHtml;
        });
      }
      
      function loadPostersForLetter(libraryIndex, letter) {
        const postersContainer = document.getElementById(`posters-container-${libraryIndex}`);
        const initialMessage = document.getElementById(`initial-message-${libraryIndex}`);
        
        if (!postersContainer) return;
        
        // Check if already loaded
        const libraryKey = `${libraryIndex}-${letter}`;
        const isAlreadyLoaded = loadedLetters.has(libraryKey);
        
        // If already loaded, just display the stored content
        if (isAlreadyLoaded && loadedContent.has(libraryKey)) {
          postersContainer.innerHTML = loadedContent.get(libraryKey);
          postersContainer.style.display = 'block';
          if (initialMessage) initialMessage.style.display = 'none';
          return;
        }
        
        // Show loading indicator only if not already loaded
        if (!isAlreadyLoaded) {
          postersContainer.innerHTML = '<div style="color:#666; text-align:center; padding:1em;">Loading posters...</div>';
        }
        postersContainer.style.display = 'block';
        if (initialMessage) initialMessage.style.display = 'none';
        
        // Update URL with current letter
        const libraryName = getLibraryNameFromIndex(libraryIndex);
        const service = libraryIndex === 'abs' ? 'abs' : 'plex';
        updateURL(service, libraryName, letter);
        
        // For ABS section, load content directly
        if (libraryIndex === 'abs') {
          const books = window.absBookGroups || {};
          const letterBooks = books[letter] || [];
          
          let html = '<ul>';
          for (const book of letterBooks) {
            html += '<li>';
            const goodreadsUrl = `https://www.goodreads.com/search?q=${encodeURIComponent((book.author || '') + ' ' + book.title)}`;
            html += `<a href="${goodreadsUrl}" target="_blank" style="display: block;">`;
            html += `<img src="${book.cover || '{{ url_for("static", filename=logo_filename) }}'}" alt="${book.title} cover" style="cursor: pointer;" onerror="this.onerror=null;this.src='{{ url_for("static", filename=logo_filename) }}';" />`;
            html += '</a>';
            html += `<div style="font-size: 0.9em; color: #aaa; margin-bottom: 0.25rem;">${book.author}</div>`;
            html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${book.title}</div>`;
            html += `<a href="${goodreadsUrl}" target="_blank" class="accent">Goodreads</a>`;
            html += '</li>';
          }
          html += '</ul>';
          
          if (letterBooks.length === 0) {
            html = '<div style="color:#666; text-align:center; padding:1em;">No books found for this letter</div>';
          }
          
          postersContainer.innerHTML = html;
          loadedLetters.set(libraryKey, true);
          loadedContent.set(libraryKey, html);
          return;
        }
        
        // Check if this is a small library that should show all items
        const isSmallLibrary = postersContainer.hasAttribute('data-small-library');
        if (isSmallLibrary) {
          // Load all items for small libraries
          loadAllItemsForLibrary(libraryIndex);
          return;
        }
        
        // Load posters via AJAX for Plex
        fetch('/ajax/load-posters-by-letter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify({ 
            library_index: libraryIndex,
            letter: letter
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Build HTML for items with posters in grid layout
            let html = '<ul>';
            
            for (const item of data.items) {
              html += '<li>';
              
              // Determine the primary link for the poster
              let posterLink = null;
              if (item.imdb) {
                posterLink = `https://www.imdb.com/title/${item.imdb}`;
              } else if (item.lastfm_url && item.is_artist === true) {
                posterLink = item.lastfm_url;
              }
              
              if (item.poster) {
                if (posterLink) {
                  html += `<a href="${posterLink}" target="_blank" style="display: block;">`;
                  html += `<img src="${item.poster}" alt="${item.title} poster" style="cursor: pointer;" />`;
                  html += '</a>';
                } else {
                  html += `<img src="${item.poster}" alt="${item.title} poster" />`;
                }
              }
              html += `<div style="font-weight: bold; margin-bottom: 0.25rem;">${item.title}</div>`;
              
              // Add external links (keep the text links for accessibility)
              const links = [];
              if (item.imdb) {
                links.push(`<a href="https://www.imdb.com/title/${item.imdb}" target="_blank" class="accent">IMDB</a>`);
              }
              if (item.lastfm_url && item.is_artist === true && !item.imdb) {
                links.push(`<a href="${item.lastfm_url}" target="_blank" class="accent">Last.fm</a>`);
              }
              
              if (links.length > 0) {
                html += links.join(' | ');
              }
              
              html += '</li>';
            }
            
            html += '</ul>';
            
            if (data.items.length === 0) {
              html = '<div style="color:#666; text-align:center; padding:1em;">No items found for this letter</div>';
            }
            
            postersContainer.innerHTML = html;
            loadedLetters.set(libraryKey, true);
            loadedContent.set(libraryKey, html);
          } else {
            const errorHtml = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading posters</div>';
            postersContainer.innerHTML = errorHtml;
            loadedLetters.set(libraryKey, true);
            loadedContent.set(libraryKey, errorHtml);
          }
        })
        .catch(error => {
          console.error('Error loading posters:', error);
          const errorHtml = '<div style="color:#cc0000; text-align:center; padding:1em;">Error loading posters</div>';
          postersContainer.innerHTML = errorHtml;
          loadedLetters.set(libraryKey, true);
          loadedContent.set(libraryKey, errorHtml);
        });
      }
      
      // Handle letter button clicks
      document.addEventListener('click', function(e) {
        if (e.target.matches('.letter-button')) {
          const letter = e.target.dataset.letter;
          const libraryIndex = e.target.dataset.libraryIndex;
          
          // Remove active class from all buttons in this navigation
          const navigation = e.target.closest('.letter-navigation');
          navigation.querySelectorAll('.letter-button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Add active class to clicked button
          e.target.classList.add('active');
          
          // Load posters for this letter
          loadPostersForLetter(libraryIndex, letter);
        }
      });
      
      // Initialize based on URL parameters
      function initializeFromURL() {
        const params = getURLParams();
        let targetLibraryIndex = null;
        
        // Determine which library to show based on URL parameters
        if (params.service === 'abs') {
          targetLibraryIndex = 'abs';
        } else if (params.library) {
          // Find the library index for the given library name
          targetLibraryIndex = getLibraryIndexFromName(params.library);
        }
        
        // If we found a valid library, show it
        if (targetLibraryIndex && document.getElementById(targetLibraryIndex)) {
          showSection(targetLibraryIndex);
          select.value = targetLibraryIndex;
          
          // If there's a letter parameter, load that letter
          if (params.letter) {
            const libraryIndex = targetLibraryIndex === 'abs' ? 'abs' : targetLibraryIndex.replace('plex-', '');
            const letterButton = document.querySelector(`.letter-button[data-letter="${params.letter}"][data-library-index="${libraryIndex}"]`);
            if (letterButton) {
              // Remove active class from all buttons in this navigation
              const navigation = letterButton.closest('.letter-navigation');
              navigation.querySelectorAll('.letter-button').forEach(btn => {
                btn.classList.remove('active');
              });
              
              // Add active class to the target button
              letterButton.classList.add('active');
              
              // Load the letter content
              loadPostersForLetter(libraryIndex, params.letter);
            }
          }
        } else {
          // Fallback to default behavior
          if (select.options.length > 0) {
            const selectedOption = select.querySelector('option[selected]');
            if (selectedOption) {
              showSection(selectedOption.value);
              select.value = selectedOption.value;
            } else {
              showSection(select.options[0].value);
              select.value = select.options[0].value;
            }
          }
        }
      }
      
      // Handle select changes
      select.addEventListener("change", function () {
        const selectedValue = this.value;
        showSection(selectedValue);
      });
      
      // Initialize the page
      initializeFromURL();
    });
  </script>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>

  <!-- Quick Access Panel Script -->
  <script src="{{ url_for('static', filename='quick-access.js') }}"></script>

</body>
</html>
