<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} — ABS</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/modern-style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
      
      // Enhanced collapsible section animations - simplified to prevent margin issues
      const collapsibleSections = document.querySelectorAll('details.collapsible-section');
      
      collapsibleSections.forEach(details => {
        const summary = details.querySelector('summary');
        
        if (!summary) return;
        
        // Let CSS handle the animations naturally
        summary.addEventListener('click', function(e) {
          // Allow default behavior but add smooth transitions
          const isOpen = details.hasAttribute('open');
          
          if (!isOpen) {
            // Add a small delay to ensure smooth opening
            setTimeout(() => {
              details.style.transition = 'all 0.3s ease';
            }, 10);
          }
        });
      });
    });
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% if services and QUICK_ACCESS_ENABLED == 'yes' %}
    <div class="quick-access-panel">
      <div class="quick-access-title">Quick Access</div>
      <div class="quick-access-grid">
        {% for service in services %}
          <div class="quick-access-item">
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" class="service-link">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" class="quick-access-icon">
            </a>
            <div class="quick-access-label">
              {% if service.name == "Plex" %}
                Media
              {% elif service.name == "Audiobookshelf" %}
                Books
              {% elif service.name == "Tautulli" %}
                Stats
              {% elif service.name == "Overseerr" %}
                Request
              {% else %}
                {{ service.name }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="onboarding-content">
    <div class="onboarding-section">
      <h1 class="onboarding-title" style="color: white !important; -webkit-text-fill-color: white !important; background: none !important;">Welcome to Audiobookshelf!</h1>
      <p class="onboarding-intro">
        While Plex can handle audiobooks, <a href="https://www.audiobookshelf.org/showcase/" target="_blank" class="accent">Audiobookshelf</a> (or just ABS) does a much better job (still for free). I reccomend it if you're an avid audio reader! You can listen on your phone or computer like Audible or Spotify.
      </p>

      <!-- Single Carousel with Library Selector -->
      <div class="carousel-section">
        <div class="poster-carousel-container">
          <div class="poster-carousel animate" id="audiobook-carousel"></div>
        </div>
      </div>

      <p class="carousel-note">
        Random selection of some audiobooks on my server. Go <a href="/medialists?service=abs" class="accent">here</a> for the full list. <span class="mobile-only">On mobile, scroll horizontally to browse through covers.</span>
      </p>

      <div class="screenshot-section">
        <img src="{{ url_for('static', filename='abshome.webp') }}" alt="Homepage Example" class="toggle-grow" />
                  <p class="screenshot-caption">Click to enlarge</p>
      </div>
    </div>

    <details {% if submitted %}open{% endif %} class="collapsible-section">
      <summary class="collapsible-heading">1. Get Access</summary>
      <p>To get started, fill out the form below. Let me know when you're done so I can add your account.</p>

      <p class="muted">
        Note: Please don't share the account you create with others. If you know someone who you think would enjoy having access, let me know. In most cases I'll be happy to add them with their own account.
      </p>
      <form method="POST" action="/audiobookshelf" id="audiobookshelf-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
          <label for="email" class="form-label">Email:</label>
          <input type="email" id="email" name="email" placeholder="Enter email" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="form-group">
          <label for="username" class="form-label">Username:</label>
          <input type="text" id="username" name="username" placeholder="Choose a username" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="form-group">
          <label for="password" class="form-label">Password:</label>
          <input type="text" id="password" name="password" placeholder="Choose a password" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="submit-section">
          <button type="submit" class="submit-btn" {% if submitted %}disabled{% endif %}>Submit</button>
        </div>
      </form>
      <div id="audiobookshelf-success" style="display:none;">
        <div class="info-box">
          <span>✅</span>
          <span><strong>Thanks! Your request has been submitted.</strong></span>
        </div>
      </div>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">2. Logging In</summary>
      <p>
        When I say so, you can access ABS on desktop at <a href="{{ AUDIOBOOKSHELF_URL }}" target="_blank" class="accent">{{ AUDIOBOOKSHELF_URL }}</a>, or download the app (see below) on your phone or tablet, and enter that same URL into the app when you open it.
      </p>

      <ul class="text-left max-800" style="margin: 1em 0;">
        <li><a href="https://www.audiobookshelf.org/showcase/" target="_blank" class="accent">Android</a></li>
      </ul>

      <p>
        There's no offical iOS app yet, but you can try these:
      </p>

      <ul class="text-left max-800" style="margin: 1em 0;">
        <li><a href="https://apps.apple.com/us/app/shelfplayer/id6475221163" target="_blank" class="accent">ShelfPlayer</a></li>
        <li><a href="https://apps.apple.com/us/app/plappa/id6475201956" target="_blank" class="accent">plappa</a></li>
      </ul>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">3. First Time Setup</summary>
      <p>
        There's not a whole lot to do for ABS, you can start listening right away!
      </p>
    
      <p>
        Look through the settings in whichever app you get and change anything to your liking. It has useful features like an automatic sleep timer, playback speed change, bookmarking, and more. 	
      </p>

      <p class="accent">
        Note: You can download audiobooks for offline listening, in case my server is offline or you go off-grid.
      </p>

      <div class="screenshot-section">
        <img src="{{ url_for('static', filename='abssetup.webp') }}" alt="Settings" class="toggle-grow" />
                  <p class="screenshot-caption">Click to enlarge</p>
      </div>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">4. Requests</summary>
      <p>
        I don't have an automated system for requesting audiobooks (yet), but I can add them manually if available.
      </p>

      <p>
        If you want a book, look for it before you ask me. See <a href="https://fmhy.pages.dev/readingpiracyguide#audiobooks" target="_blank" class="accent">this</a> list of sites.
      </p>

      {% if tautulli_enabled %}
      <h3>Notifications</h3>
      <p>
        For notifications about newly added audiobooks, ask me about my Discord.
      </p>
      {% endif %}
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">5. Issues</summary>
      <p>
        If you have issues playing a specific book, let me know.
      </p>
    </details>
  </div>

  <script>
    // --- Enhanced Infinite Carousel Logic with Mobile Optimizations ---
    function setupInfiniteCarousel(carousel) {
      const container = carousel.parentElement;
      let scrollSpeed = 0.5; // px per frame
      let rafId;
      let isPaused = false;
      let offset = 0;

      // Detect mobile/touch device - more specific detection
      const isMobile = window.matchMedia('(pointer: coarse)').matches && 
                      (window.innerWidth <= 1800 || 'ontouchstart' in window);
      
      console.log('Audiobookshelf carousel setup - Mobile detected:', isMobile);
      console.log('Screen width:', window.innerWidth);
      console.log('Pointer type:', window.matchMedia('(pointer: coarse)').matches);
      console.log('Touch support:', 'ontouchstart' in window);

      // Check mobile scroll mode from environment
      const mobileScrollMode = '{{ MOBILE_SCROLL_MODE }}' || 'auto';
      console.log('Mobile scroll mode:', mobileScrollMode);
      
      // If manual mode is enabled, disable auto-animation
      if (mobileScrollMode === 'manual') {
        console.log('Manual scroll mode enabled - disabling auto-animation');
        isPaused = true;
      } else {
        console.log('Auto scroll mode enabled - using desktop auto-scroll method');
        // Use the same auto-scroll method as desktop (no mobile-specific handling)
      }
      
      // Enhanced manual scrolling support for touch devices
      let isUserInteracting = false;
      let manualScrollStartX = 0;
      let manualScrollStartOffset = 0;
      let isManualScrolling = false;
      let lastScrollPosition = 0;
      
      // Only enable manual scrolling on touch devices
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      if (isTouchDevice) {
        // Improved touch event handling for manual scrolling
        let touchStartTime = 0;
        let lastTouchMoveTime = 0;
        let scrollVelocity = 0;
        let lastTouchX = 0;
        
        container.addEventListener('touchstart', function(e) {
          isUserInteracting = true;
          isManualScrolling = true;
          manualScrollStartX = e.touches[0].clientX;
          manualScrollStartOffset = offset;
          lastTouchX = manualScrollStartX;
          touchStartTime = Date.now();
          scrollVelocity = 0;
          console.log('Manual scroll started - auto-scroll paused');
        }, { passive: true });
        
        container.addEventListener('touchmove', function(e) {
          if (isManualScrolling) {
            const now = Date.now();
            const currentTouchX = e.touches[0].clientX;
            
            // Calculate velocity for smoother scrolling
            if (lastTouchMoveTime > 0) {
              const timeDelta = now - lastTouchMoveTime;
              if (timeDelta > 0) {
                scrollVelocity = (currentTouchX - lastTouchX) / timeDelta;
              }
            }
            
            // Throttle touch move events to reduce jumpiness
            if (now - lastTouchMoveTime < 16) { // ~60fps
              return;
            }
            lastTouchMoveTime = now;
            lastTouchX = currentTouchX;
            
            // Smooth manual scrolling
            const deltaX = currentTouchX - manualScrollStartX;
            offset = manualScrollStartOffset + deltaX;
            carousel.style.transform = `translateX(${offset}px)`;
            
            // Update scroll position for infinite scroll detection
            lastScrollPosition = offset;
          }
        }, { passive: true });
        
        container.addEventListener('touchend', function(e) {
          isManualScrolling = false;
          const touchDuration = Date.now() - touchStartTime;
          
          // Apply momentum scrolling if velocity is high enough
          if (Math.abs(scrollVelocity) > 0.5) {
            const momentumDistance = scrollVelocity * 100;
            offset += momentumDistance;
            carousel.style.transform = `translateX(${offset}px)`;
          }
          
          // Reset interaction flag with appropriate delay based on touch duration
          const resetDelay = touchDuration < 100 ? 50 : 150;
          setTimeout(() => {
            isUserInteracting = false;
            console.log('Manual scroll ended - auto-scroll resumed');
          }, resetDelay);
        }, { passive: true });
      }
      
      // Enhanced poster loading with better infinite scroll
      function checkForMorePosters() {
        const remainingImages = carousel.children.length;
        if (remainingImages <= 15) {
          console.log('Near end during auto-scroll - duplicating images quickly!');
          duplicateImages();
        }
      }

      // Improved duplicate images function
      function duplicateImages() {
        const imgs = Array.from(carousel.children);
        const fragment = document.createDocumentFragment();
        
        imgs.forEach(img => {
          const clone = img.cloneNode(true);
          // Ensure cloned images load properly
          if (clone.tagName === 'IMG') {
            clone.style.opacity = '0';
            clone.addEventListener('load', function() {
              this.style.opacity = '1';
            });
          }
          fragment.appendChild(clone);
        });
        
        carousel.appendChild(fragment);
        updateWidth();
      }

      // Enhanced carousel width calculation
      function updateWidth() {
        const containerWidth = container.offsetWidth;
        let buffer = 0;
        if (carousel.children.length > 0) {
          const imgWidth = carousel.children[0].offsetWidth + parseInt(getComputedStyle(carousel).gap || 0);
          buffer = imgWidth * 6; // Increased buffer for smoother infinite scroll
        }
        carousel.style.width = (containerWidth + buffer) + 'px';
      }

      // Improved animation loop with better infinite scroll
      function animate() {
        if (!isPaused && !isUserInteracting) {
          offset -= scrollSpeed;
          carousel.style.transform = `translateX(${offset}px)`;
          
          const firstImg = carousel.children[0];
          if (firstImg) {
            const firstImgWidth = firstImg.offsetWidth + parseInt(getComputedStyle(carousel).gap || 0);
            if (Math.abs(offset) >= firstImgWidth) {
              // Move first image to end for infinite scroll
              carousel.appendChild(firstImg);
              offset += firstImgWidth;
              carousel.style.transform = `translateX(${offset}px)`;
              
              // Check if we need more images
              checkForMorePosters();
            }
          }
        }
        rafId = requestAnimationFrame(animate);
      }

      // Enhanced image loading with better performance
      function initializeCarousel() {
        const imgs = carousel.querySelectorAll('img');
        let loaded = 0;
        let started = false;
        
        function maybeStart() {
          if (!started && loaded > 0) {
            started = true;
            duplicateImages();
            updateWidth();
            animate();
          }
        }
        
        if (imgs.length === 0) {
          animate();
          return;
        }
        
        imgs.forEach(img => {
          // Set opacity to 0 initially
          img.style.opacity = '0';
          
          if (img.complete) {
            loaded++;
            // Set opacity to 1 when image is already loaded
            img.style.opacity = '1';
            maybeStart();
          } else {
            img.addEventListener('load', () => {
              loaded++;
              // Set opacity to 1 when image loads
              img.style.opacity = '1';
              maybeStart();
            });
            img.addEventListener('error', () => {
              // Handle failed image loads
              loaded++;
              maybeStart();
            });
          }
        });
        
        // Fallback: if all images are loaded, ensure animation starts
        if (loaded === imgs.length) {
          maybeStart();
        }
      }

      // Initialize the carousel
      initializeCarousel();
    }

    // Fetch covers with Goodreads links and initialize carousel
    fetch('/audiobook-covers-with-links')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('audiobook-carousel');
        const posters = data.posters || [];
        const goodreadsLinks = data.goodreads_links || [];
        const titles = data.titles || [];
        
        container.innerHTML = posters.map((path, index) => {
          const goodreadsLink = goodreadsLinks[index];
          const title = titles[index] || `Audiobook ${index + 1}`;
          if (goodreadsLink) {
            return `<a href="${goodreadsLink}" target="_blank" class="accent" title="${title}"><img src="${path}" class="carousel-img" alt="Audiobook cover" loading="lazy" style="opacity: 0; transition: opacity 0.3s ease;"></a>`;
          } else {
            return `<img src="${path}" class="carousel-img" alt="Audiobook cover" loading="lazy" title="${title}" style="opacity: 0; transition: opacity 0.3s ease;">`;
          }
        }).join('');
        setupInfiniteCarousel(container);
      });
  </script>

  <script>
    function handleSubmit(event) {
      // Allow form to submit normally and delay disabling
      setTimeout(() => {
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = true);
      }, 50); // enough time for submit to start

      return true; // let form proceed
    }
  </script>

  <!-- Image Modal Script -->
  <script src="{{ url_for('static', filename='image-modal.js') }}"></script>

  <script>
    // AJAX audiobookshelf form submission
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('audiobookshelf-form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const data = new URLSearchParams();
          for (const pair of formData) {
            data.append(pair[0], pair[1]);
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          Array.from(form.elements).forEach(el => el.disabled = true);
          try {
            const response = await fetch('/audiobookshelf', {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: data
            });
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                document.getElementById('audiobookshelf-success').style.display = '';
                form.style.display = 'none';
              } else {
                alert(result.error || 'Submission failed.');
                Array.from(form.elements).forEach(el => el.disabled = false);
                if (submitBtn) submitBtn.disabled = false;
              }
            } else {
              alert('Submission failed.');
              Array.from(form.elements).forEach(el => el.disabled = false);
              if (submitBtn) submitBtn.disabled = false;
            }
          } catch (err) {
            alert('Submission failed.');
            Array.from(form.elements).forEach(el => el.disabled = false);
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>

</body>
</html>
