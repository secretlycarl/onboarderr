<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ SERVER_NAME }} - ABS</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/modern-style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% include "_quick_access_panel.html" %}

  <div class="onboarding-content">
    <div class="onboarding-section">
      <h1 class="onboarding-title" style="color: white !important; -webkit-text-fill-color: white !important; background: none !important;">Welcome to Audiobookshelf!</h1>
      <p class="onboarding-intro">
        <a href="https://www.audiobookshelf.org/showcase/" target="_blank" class="accent">Audiobookshelf</a> (or just ABS) lets me share my collection of audiobooks with you (still for free). You can listen on your phone or computer like Audible or Spotify.
      </p>

      <!-- Single Carousel with Library Selector -->
      <div class="carousel-section">
        <div class="poster-carousel-container">
          <div class="poster-carousel animate" id="audiobook-carousel"></div>
        </div>
      </div>

      <p class="carousel-note">
        Random selection of audiobooks on my server. Go <a href="/medialists?service=abs" class="accent">here</a> for the full list.<br>
        <span class="mobile-only">On mobile, scroll horizontally to browse through posters.</span>
      </p>

      <h3>Desktop and Mobile UI</h3>
      <div class="screenshot-section">
        <img src="{{ url_for('static', filename='abshome.webp') }}" alt="Homepage Example" class="toggle-grow" />
                  <p class="screenshot-caption">Click to enlarge</p>
      </div>
    </div>

    <details {% if submitted %}open{% endif %} class="collapsible-section">
      <summary class="collapsible-heading">1. Get Access</summary>
      <p>To get started, fill out the form below. Let me know when you're done so I can add your account.</p>

      <p class="muted">
        Note: Please don't share the account you create with others. If you know someone who you think would enjoy having access, let me know. In most cases I'll be happy to add them with their own account.
      </p>
      <form method="POST" action="/audiobookshelf" id="audiobookshelf-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
          <label for="email" class="form-label">Email:</label>
          <input type="email" id="email" name="email" placeholder="Enter email" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="form-group">
          <label for="username" class="form-label">Username:</label>
          <input type="text" id="username" name="username" placeholder="Choose a username" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="form-group">
          <label for="password" class="form-label">Password:</label>
          <input type="text" id="password" name="password" placeholder="Choose a password" required
                 class="form-input"
                 {% if submitted %}disabled{% endif %}>
        </div>
    
        <div class="submit-section">
          <button type="submit" class="submit-btn" {% if submitted %}disabled{% endif %}>Submit</button>
        </div>
      </form>
      <div id="audiobookshelf-success" style="display:none;">
        <div class="info-box">
          <span>âœ…</span>
          <span><strong>Thanks! Your request has been submitted.</strong></span>
        </div>
      </div>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">2. Logging In</summary>
      <p>
        After I make your account, you can access ABS on desktop at <a href="{{ AUDIOBOOKSHELF_URL }}" target="_blank" class="accent">this link</a>, or download the app on your phone or tablet and put that URL into it.
      </p>

      <ul class="text-left max-800">
        <li><a href="https://www.audiobookshelf.org/showcase/" target="_blank" class="accent">Android</a></li>
      </ul>

      <p>
        There's no offical iOS app yet, but you can try these:
      </p>

      <ul class="text-left max-800">
        <li><a href="https://apps.apple.com/us/app/shelfplayer/id6475221163" target="_blank" class="accent">ShelfPlayer</a></li>
        <li><a href="https://apps.apple.com/us/app/plappa/id6475201956" target="_blank" class="accent">plappa</a></li>
      </ul>

      <h3>Login Screenshots</h3>
      <div class="screenshot-section">
        <img src="{{ url_for('static', filename='abslogin.webp') }}" alt="Login Screenshots" class="toggle-grow" />
      </div>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">3. First Time Setup</summary>
      <p>
        There's not a whole lot to do for ABS, you can start listening right away!
      </p>
    
      <p>
        Look through the settings in whichever app you get and change anything to your liking. It has useful features like an automatic sleep timer, playback speed change, bookmarking, and more. 	
      </p>

      <p class="accent">
        Note: You can download audiobooks for offline listening, in case my server is offline or you go off-grid.
      </p>

      <div class="screenshot-section">
        <img src="{{ url_for('static', filename='abssetup.webp') }}" alt="Settings" class="toggle-grow" />
      </div>
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">4. Requests</summary>
      <p>
        I don't have an automated system for requesting audiobooks (yet), but I can add them manually if available.
      </p>

      <p>
        If you want a book, look for it before you ask me. See <a href="https://fmhy.pages.dev/readingpiracyguide#audiobooks" target="_blank" class="accent">this</a> list of sites.
      </p>

      {% if tautulli_enabled %}
      <h3>Notifications</h3>
      <p>
        For notifications about newly added audiobooks, ask me about my Discord.
      </p>
      {% endif %}
    </details>

    <details class="collapsible-section">
      <summary class="collapsible-heading">5. Issues</summary>
      <p>
        If you have issues playing a specific book or anything else about setting up ABS, let me know.
      </p>
    </details>
  </div>

  <!-- Carousel Auto-Scroll Script -->
  <script src="{{ url_for('static', filename='carousel-auto-scroll.js') }}"></script>

  <script>
    // --- AUTO-SCROLL CAROUSEL LOGIC for Audiobookshelf ---
    function setupInfiniteCarousel(carousel, onLoadMore = null) {
      const container = carousel.parentElement;
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      console.log('Audiobookshelf carousel setup - Mobile detected:', isMobile);
      
      // Clear any existing auto-scroll instance
      if (carousel.autoScrollInstance) {
        carousel.autoScrollInstance.destroy();
        carousel.autoScrollInstance = null;
      }
      
      // Clear any existing animation
      if (carousel.rafId) {
        cancelAnimationFrame(carousel.rafId);
        carousel.rafId = null;
      }
      
      // Remove existing event listeners to prevent duplicates
      if (carousel._mouseEnterHandler) {
        container.removeEventListener('mouseenter', carousel._mouseEnterHandler);
      }
      if (carousel._mouseLeaveHandler) {
        container.removeEventListener('mouseleave', carousel._mouseLeaveHandler);
      }

      // Reset transform
      carousel.style.transform = 'translateX(0px)';
      
      // Set carousel width for proper scrolling
      function updateWidth() {
        if (carousel.children.length === 0) {
          return;
        }
        
        let totalWidth = 0;
        const gap = parseInt(getComputedStyle(carousel).gap || 0);
        
        Array.from(carousel.children).forEach((img, index) => {
          const imgWidth = img.offsetWidth;
          if (imgWidth === 0) {
            totalWidth += img.naturalWidth + gap;
          } else {
            totalWidth += imgWidth + gap;
          }
        });
        
        carousel.style.width = totalWidth + 'px';
      }
      
      // Update width immediately and after a short delay
      updateWidth();
      setTimeout(updateWidth, 100);
      
      // Initialize auto-scroll with appropriate settings
      const autoScrollOptions = {
        scrollSpeed: 0.5, // px per frame - from old implementation
        pauseOnHover: true,
        pauseOnInteraction: true,
        resumeDelay: 1000, // 1 second delay after user interaction
        minPosters: 8,
        loadMoreThreshold: 15,
        onLoadMore: onLoadMore
      };
      
      // Initialize the auto-scroll instance
      carousel.autoScrollInstance = window.initializeCarouselAutoScroll(carousel.id, autoScrollOptions);
      
      // Setup intersection observer for poster loading
      const updateObserver = setupIntersectionObserver();
      if (updateObserver) {
        console.log('Intersection observer setup successful');
      }
      
      // Periodic safety check to ensure carousel doesn't become empty
      setInterval(() => {
        if (carousel.children.length < 5) {
          console.log('Carousel running low on posters, adding more...');
          if (onLoadMore) {
            onLoadMore().then(() => {
              updateWidth();
            }).catch(error => {
              console.error('Error loading more posters:', error);
            });
          }
        }
      }, 3000);
      
      // Return the observer update function
      return updateObserver;
      
      // Setup intersection observer to detect when last few images come into view
      function setupIntersectionObserver() {
        console.log('Setting up intersection observer for audiobookshelf...');
        console.log('onLoadMore available:', !!onLoadMore);
        console.log('IntersectionObserver available:', !!window.IntersectionObserver);
        
        if (!onLoadMore || !window.IntersectionObserver) {
          console.log('Intersection observer setup failed - missing requirements');
          return null;
        }
        
        let lastTriggerTime = 0;
        const minTriggerInterval = 200; // Increased from 0 to 200ms to prevent rapid loading during fast scrolling
        
        const observer = new IntersectionObserver((entries) => {
          console.log('Intersection observer triggered:', entries.length, 'entries');
          entries.forEach(entry => {
            console.log('Entry:', entry.isIntersecting, 'target:', entry.target);
            const now = Date.now();
            if (entry.isIntersecting && (now - lastTriggerTime) > minTriggerInterval) {
              console.log('Last few images are now visible - triggering load');
              lastTriggerTime = now;
              onLoadMore().then(() => {
                console.log('onLoadMore completed successfully');
              }).catch(error => {
                console.error('Error loading more posters:', error);
              });
            }
          });
        }, {
          root: null, // Use viewport instead of container
          rootMargin: '100px', // Trigger when 100px away from viewport
          threshold: 0.1
        });

        // Function to observe the last few images
        function observeLastImages() {
          console.log('Updating intersection observer...');
          // Disconnect previous observations
          observer.disconnect();
          
          const images = Array.from(carousel.children);
          console.log('Total images in carousel:', images.length);
          if (images.length >= 5) {
            // Observe all of the last 5 images
            const last5Images = images.slice(-5);
            console.log('Observing last 5 images:', last5Images.length);
            
            last5Images.forEach((img, index) => {
              if (img) {
                observer.observe(img);
                console.log(`Now observing image ${images.length - 5 + index + 1} of ${images.length}`);
              }
            });
          } else {
            console.log('Not enough images to observe (need at least 5, have', images.length, ')');
          }
        }

        // Initial setup
        observeLastImages();

        // Return function to update observation when new images are added
        return observeLastImages;
      }
    }

    // Initialize audiobookshelf carousel with dynamic loading
    const container = document.getElementById('audiobook-carousel');
    let currentPosters = [];
    let currentGoodreadsLinks = [];
    let currentTitles = [];
    let updateObserver = null;

    // Function to load more audiobook posters
    async function loadMoreAudiobookPosters() {
      try {
        const response = await fetch('/ajax/get-random-audiobook-posters', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ count: 5 })
        });
        
        if (response.ok) {
          const data = await response.json();
          const newPosters = data.posters || [];
          const newGoodreadsLinks = data.goodreads_links || [];
          const newTitles = data.titles || [];
          
          // Add new posters to the carousel
          newPosters.forEach((path, index) => {
            const goodreadsLink = newGoodreadsLinks[index];
            const title = newTitles[index] || `Audiobook ${currentPosters.length + index + 1}`;
            
            const imgElement = document.createElement('img');
            imgElement.src = path;
            imgElement.className = 'carousel-img';
            imgElement.alt = 'Audiobook cover';
            imgElement.loading = 'lazy';
            imgElement.title = title;
            imgElement.style.opacity = '0';
            imgElement.style.transition = 'opacity 0.3s ease';
            
            imgElement.addEventListener('load', function() {
              this.style.opacity = '1';
            });
            
            if (goodreadsLink) {
              const linkElement = document.createElement('a');
              linkElement.href = goodreadsLink;
              linkElement.target = '_blank';
              linkElement.className = 'accent';
              linkElement.title = title;
              linkElement.appendChild(imgElement);
              container.appendChild(linkElement);
            } else {
              container.appendChild(imgElement);
            }
          });
          
          // Update our tracking arrays
          currentPosters.push(...newPosters);
          currentGoodreadsLinks.push(...newGoodreadsLinks);
          currentTitles.push(...newTitles);
          
          // Update the observer if it exists
          if (updateObserver) {
            updateObserver();
          }
          
          console.log(`Loaded ${newPosters.length} more audiobook posters`);
        } else {
          console.error('Failed to load more audiobook posters');
        }
      } catch (error) {
        console.error('Error loading more audiobook posters:', error);
      }
    }

    // Function to ensure minimum posters
    function ensureMinimumPosters() {
      if (container.children.length < 5) {
        console.log('Ensuring minimum posters for audiobookshelf carousel');
        loadMoreAudiobookPosters();
      }
    }

    // Initialize with initial load
    loadMoreAudiobookPosters().then(() => {
      // Setup the carousel after initial load
      updateObserver = setupInfiniteCarousel(container, loadMoreAudiobookPosters);
    });
  </script>

  <script>
    function handleSubmit(event) {
      // Allow form to submit normally and delay disabling
      setTimeout(() => {
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = true);
      }, 50); // enough time for submit to start

      return true; // let form proceed
    }
  </script>

  <!-- Image Modal Script -->
  <script src="{{ url_for('static', filename='image-modal.js') }}"></script>

  <script>
    // AJAX audiobookshelf form submission
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('audiobookshelf-form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const data = new URLSearchParams();
          for (const pair of formData) {
            data.append(pair[0], pair[1]);
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          Array.from(form.elements).forEach(el => el.disabled = true);
          try {
            const response = await fetch('/audiobookshelf', {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: data
            });
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                document.getElementById('audiobookshelf-success').style.display = '';
                form.style.display = 'none';
              } else {
                alert(result.error || 'Submission failed.');
                Array.from(form.elements).forEach(el => el.disabled = false);
                if (submitBtn) submitBtn.disabled = false;
              }
            } else {
              alert('Submission failed.');
              Array.from(form.elements).forEach(el => el.disabled = false);
              if (submitBtn) submitBtn.disabled = false;
            }
          } catch (err) {
            alert('Submission failed.');
            Array.from(form.elements).forEach(el => el.disabled = false);
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <!-- Navigation Script -->
  <script src="{{ url_for('static', filename='navigation.js') }}"></script>
  
  <!-- Collapsible Animations Script -->
  <script src="{{ url_for('static', filename='collapsible-animations.js') }}"></script>

  <!-- Smooth Background Extension Script -->
  <script src="{{ url_for('static', filename='smooth-background.js') }}"></script>

  <!-- Quick Access Panel Script -->
  <script src="{{ url_for('static', filename='quick-access.js') }}"></script>

</body>
</html>
